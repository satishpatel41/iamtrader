<!DOCTYPE html>
<html lang="en">
<head>
<title>Scanner</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/3.0.1/mustache.min.js"></script>
<link href="https://unpkg.com/tabulator-tables@4.1.3/dist/css/tabulator.min.css" rel="stylesheet">
<link href="https://unpkg.com/tabulator-tables@4.1.3/dist/css/semantic-ui/tabulator_semantic-ui.min.css" rel="stylesheet">
<style>
    .loader {
      border: 10px solid #f3f3f3;
      border-radius: 50%;
      border-top: 10px solid #3498db;
      width: 50px;
      height: 50px;
      -webkit-animation: spin 2s linear infinite; /* Safari */
      animation: spin 2s linear infinite;
      position: fixed;
      left: 45%;
      top: 45%;
      transform: translate(-50%, -50%);
    }

    /* Safari */
    @-webkit-keyframes spin {
      0% { -webkit-transform: rotate(0deg); }
      100% { -webkit-transform: rotate(360deg); }
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .indicatorsRow{
      padding-bottom:10px;
    }

    .btn-label {
        padding:6px;
        position: relative;
        display: inline-block;
        background: rgb(217, 223, 255);
        border-radius: 3px
    }

    #target{
      padding-bottom:15px;
    }
    


</style>
<script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.1.3/dist/js/tabulator.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/web-socket-js/1.0.0/web_socket.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>

<script type="text/javascript">

$(document).ready( function () {
      var index= 0;
      var selectedSid= -1;
      var items ={};
      var template = $("#items_tmp").html();
      var strategyListArr =[];
      var allIndicators= [
        {
            "name":"number",
            "input":'0',
            "config":'number'
        },
        {
            "name":"close",
            "input":'',
            "config":'close'
        },
        {
            "name":"low",
            "input":'',
            "config":'low'
        },
        {
            "name":"high",
            "input":'',
            "config":'high'
        },
        {
            "name":"open",
            "input":'',
            "config":'open'
        },
        {
            "name":"volume",
            "input":'',
            "config":'volume'
        },
        {
            "name":"ATR",
            "input":'high,low,close,14',
            "config":'high,low,close,period'
        },
        {
            "name":"BB.upper",
            "input":'14,close,2',
            "config":'period,values,stdDev'
        },
        {
            "name":"BB.lower",
            "input":'14,close,2',
            "config":'period,values,stdDev'
        },{
            "name":"MACD",
            "input":'close,fastPeriod,slowPeriod,false,false',
            "config":'values,fastPeriod,slowPeriod,SimpleMAOscillator,SimpleMASignal'
        },{
            "name":"RSI",
            "input":'close,14',
            "config":'values,period'
        },{
            "name":"SMA",
            "input":'close,50',
            "config":'values,period'
        },{
            "name":"EMA",
            "input":'close,50',
            "config":'values,period'
        },{
            "name":"ADX",
            "input":'close,high,low,14',
            "config":'close,high,low,period'
        }
    ];
  
      
      $("#saveButton").hide();
      var server = window.location.port ? window.location.protocol +"//"+window.location.hostname +":"+window.location.port: window.location.protocol +"//"+window.location.hostname;
      $('#userTxt').text(localStorage.getItem('user'));
     
      getAllStrategy();

      function getAllStrategy()
      {
          strategyListArr = [];
          selectedSid = -1;
          var uid = localStorage.getItem('uid');
          $(".loader").show();
          $.get({
            url: server+'/strategyList/'+uid,
            success: function(list){
                $(".loader").hide();       
                strategyListArr = list.filter(function (el) {
                  return (el != null && el.name != null && el.name != undefined && el.name != "");
                });
                createTable()
              }
          });
      }

      function createTable()
      {
          var table = new Tabulator("#strategyTable", {
                data:strategyListArr,
                ajaxLoader: true,
                ajaxLoaderLoading: 'updating data',
                placeholder:"No Data Set",
                height:"100%",
                width:"90%",
                layout:"fitDataFill",      //fit columns to width of table
                tooltips:true,            //show tool tips on cells
                history:true,             //allow undo and redo actions on the table
                pagination:"local",       //paginate the data
                paginationSize:20,         //allow 7 rows per page of data
                movableColumns:true,      //allow column order to be changed
                columns:[
                    {title:"Name", field:"name",widthShrink:1},
                    {title:"Description", field:"description",widthShrink:1},
                    {title:"Category", field:"category",widthShrink:1},
                    {
                      title:"Edit",widthShrink:1,field:"sid",formatter:function(cell, formatterParams)
                      {
                        return "<span class='btn-label'><i id='edit-"+cell.getValue()+"'class='glyphicon glyphicon-edit'></i></span>";
                      } 
                    },
                    {
                      title:"Delete",widthShrink:1,field:"sid",formatter:function(cell, formatterParams)
                      {
                        return "<span class='btn-label'><i id='"+cell.getValue()+"'class='glyphicon glyphicon-trash'></i></span>";
                      } 
                    },
                ],
                rowClick:function(e, row){
                    if(e.target.classList.contains("glyphicon-trash")){
                      //alert("Row " + e.target.id + " Clicked!!!!")
                      $.get({
                          url: server+'/deleteStrategy/'+e.target.id,
                          success: function(list){
                              $(".loader").hide();  
                              getAllStrategy();
                            }
                      }); 
                    }
                    else if(e.target.classList.contains("glyphicon-edit")){
                      var sid = String(e.target.id).substr(5,5);
                      $.get({
                          url: server+'/indicatorList/'+sid,
                          success: function(list){
                              $(".loader").hide();  
                              console.log(list);
                              // Select first tab
                              $('.nav-tabs a:first').tab('show');
                              selectedSid = sid;
                              createIndicators(list);
                            }
                      }); 
                    }
                },
                rowContext:function(e, row){
                    //alert("Row " + row.getIndex() + " Context Clicked!!!!")
                },
            });
      }
      
      $('#saveBtn').on('click', function(event) {
        event.preventDefault(); // To prevent following the link (optional)
        var indicatorArr = [];
        var indicatorsRow= $( ".indicatorsRow" );
        for(var i=0;i<indicatorsRow.length;i++){
          var obj  = {};
          obj.indicator1 = $($( ".row .indicatorTxt1" )[i]).val();
          obj.indicator2 = $($(".row .indicatorTxt2")[i]).val();
          obj.indicator_config1 = $($( ".row .inputTxt1" )[i]).val();
          obj.indicator_config2 = $($( ".row .inputTxt2" )[i]).val();
          obj.value = $($( ".row .inputTxt" )[i]).val()
          obj.op = $($( ".row .opDropDown" )[i]).val();
          
          indicatorArr.push(obj);
        }

        var strategyObj = {
                uid:localStorage.getItem('uid'),
                sid:selectedSid,
                name:$("#nameTxt").val(),
                indicators:indicatorArr,
                description:$("#descriptionTxt").val(),
                category:$("#category").val(),
                isPrivate:$("#is_private")[0].checked
        };

      var api = '/createStrategy';
      if(selectedSid >= 0)
        api ='/updateStrategy';

        $.ajax({
              type: "post",
              data: {data:JSON.stringify(strategyObj)},
              url: server + api,
              success: function(msg){
                $("#nameTxt").val('');
                $("#descriptionTxt").val(''),
                $("#category").val(''),
                $("#is_private")[0].checked =false;
                $('#strategyModal').modal('hide');
                $("#target").empty();
                $('.nav-tabs a:last').tab('show');
                selectedSid = -1;
                index = 0;
                getAllStrategy();
              }
            });
      });

      $('#saveButton').on('click', function(event) {
        event.preventDefault(); 
        $('#strategyModal').modal('show');

        var id = -1;
        var count = 0;
        strategyListArr.map(strategy=>{
          if(strategy.sid == selectedSid)
          {
            id = count;
          }
          count ++;
        });

        if(id >= 0){
          $("#nameTxt").val(strategyListArr[id]['name']);
          $("#descriptionTxt").val(strategyListArr[id]['description']),
          $("#category").val(strategyListArr[id]['category']),
          $("#is_private")[0].checked =strategyListArr[id]['isPrivate'];
        }
      });

      $('#addButton').on('click', function(event) {
        event.preventDefault(); // To prevent following the link (optional)
        $("#notePanel").hide();
        items.items = [];
        index= index + 1;
        items.items.push({'id' :index });
        template = $("#items_tmp").html();
        html = Mustache.to_html(template, items);

        $("#target").append(html);
        helpers.buildDropdown(allIndicators, $('#indicatorsRow'+index+' .indicatorTxt1'),'Select an option','name');
        helpers.buildDropdown(allIndicators, $('#indicatorsRow'+index+' .indicatorTxt2'),'Select an option','name');

        if($("#target").children().length > 0){
          $('#saveButton').show();
        }

       
        $( ".row .indicatorTxt2" ).change(function(e) {
          var val = $( this ).val();

          var input = '';
          allIndicators.map(indicator1=>{
            if(indicator1['name'] == val){
              input = indicator1['input'];
            }
          });

          if(input != ''){
            $(this.parentElement.parentElement.children[5].children[0]).val(input);
            $(this.parentElement.parentElement.children[5].children[0]).show();
          }
          else
            $(this.parentElement.parentElement.children[5].children[0]).hide();  
        });

         $( ".row .indicatorTxt1" ).change(function(e) {
          var val = $( this ).val();

          var input = '';
          allIndicators.map(indicator1=>{
            if(indicator1['name'] == val){
              input = indicator1['input'];
            }
          });

          if(input != ''){
            $(this.parentElement.parentElement.children[2].children[0]).val(input);
            $(this.parentElement.parentElement.children[2].children[0]).show();
          }
          else
            $(this.parentElement.parentElement.children[2].children[0]).hide();  
        });

        $('#target .delBtn').on('click', function(event) {
            event.preventDefault();
            index =index-1;
           
            $(this.parentElement.parentElement).remove();
            if($("#target").children().length == 0){
              $('#saveButton').hide();
            }
        });
      });

      // Select all tabs
       $('.nav-tabs a').click(function(){
        $("#notePanel").show();
        items.items = [];
        $("#target").empty();
        index = 0;
        selectedSid = -1;
        $('#saveButton').hide();
      })

      function createIndicators(list) {
        $("#notePanel").hide();
        items.items = [];
        $("#target").empty();
        list.map(indicator=>{
          index= index + 1;
          items.items = [];
          items.items.push({'id' :index });
          template = $("#items_tmp").html();
          html = Mustache.to_html(template, items);
          $("#target").append(html);
          helpers.buildDropdown(allIndicators, $('#indicatorsRow'+index+' .indicatorTxt1'),'Select an option','name');
          helpers.buildDropdown(allIndicators, $('#indicatorsRow'+index+' .indicatorTxt2'),'Select an option','name');

          $('#indicatorsRow'+index+' .indicatorTxt1')[0].value = indicator.indicator1;
          $('#indicatorsRow'+index+' .indicatorTxt2')[0].value = indicator.indicator2;
          $('#indicatorsRow'+index+' .opDropDown')[0].value = indicator.op;
          //$('#indicatorsRow'+index+' .inputTxt')[0].value = indicator.value;
          $('#indicatorsRow'+index+' .inputTxt1')[0].value = indicator.indicator_config1;
          $('#indicatorsRow'+index+' .inputTxt2')[0].value = indicator.indicator_config2;
        });
        if($("#target").children().length > 0){
          $('#saveButton').show();
        }
        
        
        $('#target .delBtn').on('click', function(event) {
            event.preventDefault();
            //console.log("index > " + index);
            index =index-1;
            
            $(this.parentElement.parentElement).remove();
            if($("#target").children().length == 0){
              $('#saveButton').hide();
            }
        });
        
        $( ".row .indicatorTxt2" ).change(function(e) {
          var val = $( this ).val();

          var input = '';
          allIndicators.map(indicator1=>{
            if(indicator1['name'] == val){
              input = indicator1['input'];
            }
          });

          if(input != ''){
            $(this.parentElement.parentElement.children[5].children[0]).val(input);
            $(this.parentElement.parentElement.children[5].children[0]).show();
          }
          else
            $(this.parentElement.parentElement.children[5].children[0]).hide();  
        });

         $( ".row .indicatorTxt1" ).change(function(e) {
          var val = $( this ).val();

          var input = '';
          allIndicators.map(indicator1=>{
            if(indicator1['name'] == val){
              input = indicator1['input'];
            }
          });

          if(input != ''){
            $(this.parentElement.parentElement.children[2].children[0]).val(input);
            $(this.parentElement.parentElement.children[2].children[0]).show();
          }
          else
            $(this.parentElement.parentElement.children[2].children[0]).hide();
        });
      }


      var helpers = {
          buildDropdown: function(result, dropdown, emptyMessage,field){
              dropdown.html('');
              dropdown.append('<option value="">' + emptyMessage + '</option>');
              if(result != ''){
                if(field){
                  $.each(result, function(k, v) {
                      dropdown.append('<option value="' + v[field]+ '">' + v[field] + '</option>');
                  });
                }
                else
                {
                  $.each(result, function(k, v) {
                      dropdown.append('<option value="' + v+ '">' + v+ '</option>');
                  });
                }
              }
          },

      }

      var ws = new WebSocket('ws://localhost:8080');
      ws.onopen = function() {
      //ws.send("Hello"); 
      };
      ws.onmessage = function(e) {
        var strategy = JSON.parse(e.data);
        if(localStorage.getItem('uid') == strategy.data.strategy.uid){
            Command: toastr["info"](strategy.data.strategy.symbol)
            Command: toastr["info"](e.data)

            toastr.options = {
            "closeButton": false,
            "debug": false,
            "newestOnTop": false,
            "progressBar": false,
            "positionClass": "toast-top-right",
            "preventDuplicates": false,
            "onclick": null,
            "showDuration": "300",
            "hideDuration": "1000",
            "timeOut": "5000",
            "extendedTimeOut": "1000",
            "showEasing": "swing",
            "hideEasing": "linear",
            "showMethod": "fadeIn",
            "hideMethod": "fadeOut"
            }
          }
      };
      ws.onclose = function() {
        console.log("closed");
      };

});
</script>
</head>
<body>

<nav class="navbar navbar-inverse navbar-fixed-top">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>                        
        </button>
      <a class="navbar-brand" href="/index">Scanner</a>
    </div>
    <div class="collapse navbar-collapse" id="myNavbar">
      <ul class="nav navbar-nav">
        <li ><a href="/gainerloser">Top Gainer / Looser</a></li>
        <li><a href="/gapupdown">Gap up/Down</a></li>
        <li><a href="/allCharts">Stocks Charts</a></li>
        <li ><a href="/scanner">Scanner</a></li>
        <li class="active"><a href="/strategy">Strategy</a></li>
        <li><a href="/applyStrategy">Apply Strategy</a></li>  
      </ul>
      <ul class="nav navbar-nav pull-right">
          <li class="dropdown pull-right"><a href="#" class="dropdown-toggle" data-toggle="dropdown">Welcome, <span id="userTxt"></span> <span class="glyphicon glyphicon-user"></span><b class="caret"></b></a>
            <ul class="dropdown-menu pull-right">
                <li><a href="/profile"><i class="icon-cog"></i> Profile</a></li>
                <li><a href="/authenticate"><i class="icon-cog"></i> Upstox Login</a></li>
                <li><a href="/preferences"><i class="icon-envelope"></i> Preferences</a></li>
                <li class="divider"></li>
                <li><a href="/logout"><span class="glyphicon glyphicon-off"></span> Logout</a></li>
            </ul>
        </li>
      </ul>
    </div> 
  </div>
</nav>
  
<div class="container">
      <div class="row"></div>
      <br/><br/><br/>
      <ul class="nav nav-tabs">
        <li ><a data-toggle="tab" href="#addStrategyPanel">Create strategy</a></li>
        <li class="active"><a data-toggle="tab" href="#strategyListPanel">All strategy</a></li>
      </ul>

      <div class="tab-content">
        <div id="addStrategyPanel" class="tab-pane fade">
          
          <br/>
          <div class="alert alert-warning" role="alert" id="notePanel">
              You can create your own custom strategy by adding Indicators, you can click below button to add Indicators !
          </div>

          <script id="items_tmp" type="text/template">
          {{#items}}
            <div class="indicatorsRow row row-{{id}}" id="indicatorsRow{{id}}">
              <div class="col-sm-1">
                <span class="btn-label delBtn"><i class="glyphicon glyphicon-trash"></i></span>
              </div> 
              <div class="col-sm-2">
                <select class="form-control indicatorTxt1" placeholder="Select Indicator">
                </select>
              </div> 
              <div class="col-sm-2">
                <input type="text"  class="form-control valueTxt inputTxt1" placeholder="Enter Value">
              </div> 

              <div class="col-sm-2">
                <select class="form-control opDropDown" >
                    <option value=">">&gt;</option>
                    <option value="<">&lt;</option>
                    <option value="==">==</option>
                    <option value=">=">>=</option>
                    <option value="<="><=</option>
                    <option value="Crossed Above">Crossed Above</option>
                    <option value="Crossed Below">Crossed Below</option>
                  </select>
              </div> 
              <div class="col-sm-2">
                <select class="form-control indicatorTxt2" placeholder="Select Indicator">
                </select>
              </div> 

              <div class="col-sm-2">
                <input type="text"  class="form-control valueTxt inputTxt2"  placeholder="Enter Value">
              </div>  
            </div> 
          {{/items}}
          </script>
         
          <div id="target"></div>

          <div class="row">
            <div class="col-sm-2">
              <button type="button" id="addButton" class="btn btn-primary">Add Indicators</button>
            </div>
            <div class="col-sm-2">
              <button type="button" id="saveButton" class="btn btn-success" >Save Strategy</button>
            </div>
          </div>

          <!-- Modal -->
          <div class="modal fade" id="strategyModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h4 class="modal-title">Save Strategy</h>
              </div>
                <div class="modal-body">
                  <form>
                    <div class="form-group">
                      <label for="nameTxt">Name</label>
                      <input type="text" class="form-control" id="nameTxt" placeholder="Enter your strategy name">
                    </div>
                    <div class="form-group">
                      <label for="descriptionTxt">Description</label>
                      <textarea class="form-control" id="descriptionTxt" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                      <label for="category">Select category</label>
                      <select class="form-control" id="category">
                        <option>Intraday Bullish scan</option>
                        <option>Intraday Bearish scan</option>
                      </select>
                    </div>
                    <label>
                      <input type="checkbox" id="is_private"> Is Private?
                  </label>
                </form>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Discard</button>
                  <button type="button" id="saveBtn" class="btn btn-primary">Save</button>
                </div>
              </div>
            </div>
          </div>
          
        </div>
        <div id="strategyListPanel" class="tab-pane fade in active">
            <br/>
            <div class="alert alert-info">  
                <p>All custom strategy are listed below!</p>
            </div>
            <div id="strategyTable">
            </div>
        </div>
      </div>
    </div>
</div>

<div class="loader"></div>
</body>
</html>