var SMA=require("technicalindicators").SMA,EMA=require("technicalindicators").EMA,RSI=require("technicalindicators").RSI,BB=require("technicalindicators").BollingerBands,ADL=require("technicalindicators").ADL,ADX=require("technicalindicators").ADX,ATR=require("technicalindicators").ATR,MACD=require("technicalindicators").MACD,bullish=require("technicalindicators").bullish;async function startBackTesting(symbol,stockData,strategyList,isBackTesting){var closes=[],opens=[],highs=[],lows=[],timestamps=[],values=stockData.map(async e=>{closes.push(+e.close),opens.push(+e.open),highs.push(+e.high),lows.push(+e.low),timestamps.push(+e.timestamp)}),result=[],output=[];return timestamps=timestamps.reverse(),Promise.all(strategyList.strategy.map(async strategyObj=>new Promise(function(resolved,rejected){Promise.all(strategyObj.indicators.map(async indicatorObj=>new Promise(function(resolve,reject){try{if(indicatorObj.indicator&&""!=indicatorObj.indicator){indicatorObj.values="closes"==indicatorObj.values?eval(indicatorObj.values):closes;var str=indicatorObj.indicator+".calculate("+JSON.stringify(indicatorObj)+")",res=eval(str),op=isBackTesting?res.reverse():res.reverse().slice(0,3);output.push(op),indicatorObj=null,resolve(op)}else resolve("")}catch(e){reject(e)}}))).then(obj=>{closes=closes.reverse();for(var strategyRes=[],i=0;i<obj[0].length-2;i++){(null==result[i]||null==result[i])&&(result[i]=[]);var flag=eval(strategyObj.strategy),india=moment.tz(new Date(+timestamps[i]),"Asia/Kolkata");india.format();var d=india.date()+"/"+(india.month()+1)+"/"+india.year()+" "+india.hour()+":"+india.minute();result[i].push({date:d,flag:flag})}return closes=closes.reverse(),resolved(result)}).catch(e=>{rejected(e),console.log("INNER LOOP : "+e),e=null})})))}Array.prototype.insert=function(e,...t){return this.slice(0,e).concat(t,this.slice(e))};var SMA=require("technicalindicators").SMA,EMA=require("technicalindicators").EMA,RSI=require("technicalindicators").RSI,BB=require("technicalindicators").BollingerBands,ADL=require("technicalindicators").ADL,ADX=require("technicalindicators").ADX,ATR=require("technicalindicators").ATR,MACD=require("technicalindicators").MACD,bullish=require("technicalindicators").bullish;class BaseStrategy{constructor(){}async executeStrategy(symbol,stockData,strategyList){var closes=[],opens=[],highs=[],lows=[],timestamps=[],values=stockData.map(async e=>{closes.push(+e.close),opens.push(+e.open),highs.push(+e.high),lows.push(+e.low),timestamps.push(+e.timestamp)});return timestamps=timestamps.reverse(),Promise.all(strategyList.strategy.map(async strategyObj=>new Promise(function(resolved,rejected){var result=[],output=[];Promise.all(strategyObj.indicators.map(async indicatorObj=>new Promise(function(resolve,reject){try{if(indicatorObj.indicator&&""!=indicatorObj.indicator){indicatorObj.values="closes"==indicatorObj.values?eval(indicatorObj.values):closes;var str=indicatorObj.indicator+".calculate("+JSON.stringify(indicatorObj)+")",res=eval(str),op=res.reverse().slice(0,3);output.push(op),op=str=res=indicatorObj=null,resolve(output)}else resolve("")}catch(e){reject(e)}}))).then(obj=>{closes=closes.reverse(),highs=highs.reverse(),lows=lows.reverse(),opens=opens.reverse();var i=0,strategy=eval(strategyObj.strategy);result.push(strategy),closes=closes.reverse(),highs=highs.reverse(),lows=lows.reverse(),opens=opens.reverse();var d=new Date(+timestamps[0]),strategyRes=result.every(e=>1==e);return output=result=i=d=null,resolved(strategyRes)}).catch(e=>{rejected(e),console.log("INNER LOOP : "+e),e=null})})))}}async function applyStrategy(e,t,s){var a,o=[];Promise.all(e.map(async e=>{return getStock(e.symbol?e.symbol:e,t)})).then(e=>{var t=e.map(async e=>{try{var t=JSON.parse(e.data);a=new BaseStrategy,await a.executeStrategy(e.symbol,t,s).then(t=>{var s=t.every(e=>1==e);s&&o.push(e.symbol),t=s=e=a=null}).catch(e=>{console.log("OUTER LOOP ERROR > "+e),e=a=null})}catch(e){console.log("Error "+e),e=a=null}});Promise.all(t).then(e=>{console.log("RESULT  > "+s.name+" >> "+o),"production"==process.env.NODE_ENV&&sendingMail("satish.patel41@gmail.com",s.name,o).catch(console.error),closes=opens=highs=lows=timestamps=s=o=null}).catch()}).catch(e=>{console.log(e)})}var chalk=require("chalk");const sqlite3=require("sqlite3").verbose();let db=new sqlite3.Database("db/upstox.db",e=>e?console.error(e.message):void console.log(chalk.green("Connected to the in-memory SQlite database.")));function closeDb(){db.close()}function insertDB(e,t){return new Promise(function(s){db.run(e,t,function(e){e?console.log(chalk.red("Insert error > "+e)):(console.log(chalk.blue("Successfully inserted")),s("success"))})})}async function getFirst(e,t){return new Promise(function(s,a){db.get(e,t,function(e,t){e?a("Read error: "+e.message):s(t)})})}const csv=require("csv-parser");var fs=require("fs"),nifty="https://www.nseindia.com/content/indices/ind_nifty50list.csv",fno="https://www.nseindia.com/content/fo/fo_mktlots.csv",watchList=[];const results=[];var fnoList=[],niftyList=[];fs.createReadStream("data/list/ind_nifty50list.csv").pipe(csv()).on("data",e=>results.push(e)).on("end",()=>{results.forEach(function(e){e.Symbol&&niftyList.push({ex:"NSE_EQ",symbol:e.Symbol})}),watchList=niftyList.sort(),store.set("niftyList",niftyList),watchList=niftyList.sort()});const nodemailer=require("nodemailer");var transporter1=nodemailer.createTransport({service:"gmail",auth:{user:"satish.patel41@gmail.com",pass:"Pratiksha@123"}});let mailOptions={from:'"Admin" <satish.patel41@gmail.com>',to:"satish.patel41@yahoo.com",subject:"Alert : Call Generated",text:"Alert for",html:'<p><b>Hello</b> Alert triggered on Wed Nov 7, 6:00 pm</p><p>Here\'s a nyan cat for you as an embedded attachment:<br/><img src="cid:nyan@example.com"/></p>',list:{help:"admin@example.com?subject=help",unsubscribe:[{url:"http://example.com/unsubscribe",comment:"A short note about this url"},"unsubscribe@example.com"],id:{url:"mylist.example.com",comment:"This is my awesome list"}}};var transporter=nodemailer.createTransport({host:"smtp.ethereal.email",port:587,auth:{user:"tito25@ethereal.email",pass:"cXqDHqccV9T7VMqhzs"}});function sendingMail(e,t,s){console.log("sendingMail> "+e+" : "+t+" :: "+s);var a="<ul>";s.map(e=>{a+="<li>"+e+"</li>"}),a+="</ul>";var o=moment.tz(new Date,"Asia/Kolkata");o.format();var n=o.date()+"/"+(o.month()+1)+"/"+o.year()+" "+o.hour()+":"+o.minute();mailOptions.subject="Scan alert "+t,mailOptions.to=e,mailOptions.html="<h1>Alert triggered on "+n+"</h1><br><p>Below is the list of new stocks filtered through scan <u>"+t+"</u></p><br><p><b>"+a+"</b></p>",transporter.sendMail(mailOptions,(e,t)=>e?console.log(e):void console.log("Message sent: %s",t.messageId))}var list,cron=require("node-cron"),chalk=require("chalk"),moment=require("moment-timezone");function load1WeekData(){var e=new Date,t=e.getDate()+"-"+(e.getMonth()+1)+"-"+e.getFullYear();e.setDate(e.getDate()-1e3);var s=e.getDate()+"-"+(e.getMonth()+1)+"-"+e.getFullYear();store.get("accessToken")&&syncLiveAllStockData(watchList,"1WEEK",s,t)}function load1dayData(){var e=new Date,t=e.getDate()+"-"+(e.getMonth()+1)+"-"+e.getFullYear();e.setDate(e.getDate()-200);var s=e.getDate()+"-"+(e.getMonth()+1)+"-"+e.getFullYear();store.get("accessToken")&&syncLiveAllStockData(watchList,"1DAY",s,t)}cron.schedule("*/5 * * * *",()=>{load5minData(),console.log(chalk.blue("running a task every 5 minutes"))},{scheduled:!0,timezone:"Asia/Kolkata"}),cron.schedule("*/10 * * * *",()=>{console.log(chalk.blue("running a task every 10 minutes"))},{scheduled:!0,timezone:"Asia/Kolkata"}),cron.schedule("*/15 * * * *",()=>{load15minData(),console.log(chalk.blue("running a task every 15 minutes"))},{scheduled:!0,timezone:"Asia/Kolkata"}),cron.schedule("*/30 * * * *",()=>{console.log(chalk.blue("running a task every 30 minutes"))},{scheduled:!0,timezone:"Asia/Kolkata"}),cron.schedule("0 */1 * * *",()=>{load60minData(),console.log(chalk.blue("running a task every 1 hour"))},{scheduled:!0,timezone:"Asia/Kolkata"}),cron.schedule("59 23 * * *",()=>{store.unlink(),console.log(chalk.yellow("Clean cache data"))},{scheduled:!0,timezone:"Asia/Kolkata"}),cron.schedule("0 17 * * *",()=>{load1dayData(),console.log(chalk.blue("running a task every 1 day"))},{scheduled:!0,timezone:"Asia/Kolkata"}),cron.schedule("0 17 * * *",()=>{load1WeekData(),console.log(chalk.blue("running a task every 1 day"))},{scheduled:!0,timezone:"Asia/Kolkata"});var now=new Date,india=moment.tz(now,"DD-MM-YYYY HH:mm","Asia/Kolkata");india.format();var start_date="";now.setDate(now.getDate()-15),india=moment.tz(now,"DD-MM-YYYY HH:mm","Asia/Kolkata"),india.format();var end_date="";function load60minData(){store.get("accessToken")&&syncLiveAllStockData(watchList,"60MINUTE",start_date,end_date)}function load30minData(){store.get("accessToken")&&syncLiveAllStockData(watchList,"30MINUTE",start_date,end_date)}function load10minData(){store.get("accessToken")&&syncLiveAllStockData(watchList,"10MINUTE",start_date,end_date)}function load5minData(){store.get("accessToken"),getPercent_list(watchList)}function load3minData(){store.get("accessToken")}function load15minData(){store.get("accessToken")&&syncLiveAllStockData(watchList,"15MINUTE",start_date,end_date),strategyList.map(e=>{applyStrategy(watchList,"15MINUTE",e)}),getPercent_list(watchList)}var express=require("express"),compression=require("compression"),moment=require("moment-timezone"),bodyParser=require("body-parser"),chalk=require("chalk"),fs=require("fs"),url=require("url"),cluster=require("cluster"),session=require("express-session"),FileStore=require("session-file-store")(session),Store=require("data-store"),async=require("async");const querystring=require("querystring");var store=new Store({path:"config.json"}),Upstox=require("upstox"),api="OknufM07tm1g9EfN4fHKP2Eqi9DSw40I2Y3xliHg",upstox=new Upstox(api);const PORT=process.env.PORT||3e3;var redirect_uri="http://localhost:"+PORT;"production"==process.env.NODE_ENV&&(api="OknufM07tm1g9EfN4fHKP2Eqi9DSw40I2Y3xliHg",redirect_uri="https://robo-trader.herokuapp.com/");var numReqs=0;if(cluster.isMaster){console.log(chalk.green("cpus 1"));for(var worker,i=0;i<1;i++)worker=cluster.fork(),worker.on("message",function(){});cluster.on("death",function(e){console.log(chalk.red("worker "+e.pid+" died"))})}else{function a(e,t,s){e.session.user?s():(console.log(chalk.blue(JSON.stringify(e.session)+" session \n"+e.session.user)),t.sendFile("login.html",{root:__dirname}))}function b(){var e={values:[],period:14};rsi=new technicalindicators.RSI(e);var t={values:[],period:20};sma=new technicalindicators.SMA(t);var s={period:14,values:[],stdDev:2};bb=new technicalindicators.BollingerBands(s),s=e=t=null}var app=express();app.use(express.static("public")),app.use(compression()),app.use(bodyParser.json()),app.use(bodyParser.urlencoded({extended:!0})),app.use(session({store:new FileStore({path:"./session-store"}),name:"_fs_cookie",resave:!1,saveUninitialized:!1,secret:"00777",cookie:{maxAge:36e5}})),app.use(function(e,t,s){t.header("Access-Control-Allow-Origin","*"),t.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept"),s()});var months=["January","February","March","April","May","June","July","August","September","October","November","December"],date=new Date,today=date.getDate()+"-"+(date.getMonth()+1)+"-"+date.getFullYear(),time=date+":"+date.getHours()+":"+date.getMinutes();app.get("/",function(e,t){var s=url.parse(e.url,!0).query;code=s.code,console.log(chalk.green("session > "+JSON.stringify(e.session.cookie))),code?(getAcceToken(code),t.sendFile("index.html",{root:__dirname})):t.sendFile("index.html",{root:__dirname}),s=null}),app.get("/welcome",a,function(e,t){t.send("<b>Hello</b> welcome to my http server made with express")}),app.get("/login",function(e,t){t.sendFile("login.html",{root:__dirname})}),app.get("/logout",function(e,t){e.session.destroy(function(){console.log(chalk.blue("user logged out."))}),t.redirect("/login")}),app.post("/login",function(e,t){var s=e.body.username,a=e.body.password;s?getFirst("select * from User where email=? and password=?",[s,a]).then(s=>{console.log("result > "+JSON.stringify(s)),null==s?t.send("error"):(console.log(chalk.green("Login token > "+store.get("accessToken"))),e.session.user=s,t.send(s))}):t.sendFile("login.html",{root:__dirname})}),app.get("/signup",function(e,t){t.sendFile("signup.html",{root:__dirname})}),app.get("/gainerLoser",function(e,t){t.sendFile("gainerloser.html",{root:__dirname})}),app.get("/api/gainerLoser",function(e,t){t.send(store.get("percentage"))}),app.post("/signup",function(e,t){var s=e.body.email,a=e.body.psw,o=e.body.mobile,n=e.body.name;e.body.pswRepeat;if(s){var r=!1;getFirst(i="select * from User where email=?",l=[s]).then(e=>{console.log("result > "+JSON.stringify(e)),null==e||(t.send("error"),r=!0)});var i="INSERT INTO User (name,mobile,email,password)VALUES(?,?,?,?)",l=[n,o,s,a];console.log(i+"> "+l),r||insertDB(i,l).then(e=>{console.log("result > "+JSON.stringify(e)),"success"==e?t.send("success"):t.send("error")})}else t.sendFile("signup.html",{root:__dirname})}),app.get("/contactus",a,function(e,t){t.sendFile("contactus.html",{root:__dirname})}),app.get("/index",a,function(e,t){t.sendFile("index.html",{root:__dirname})}),app.get("/scan",a,function(e,t){t.sendFile("scanner.html",{root:__dirname})}),app.get("/strategy",a,function(e,t){t.sendFile("strategy.html",{root:__dirname})}),app.get("/gainerloser",a,function(e,t){t.sendFile("gainerloser.html",{root:__dirname})});var lastObject={open:"",close:"",low:"",high:"",volume:"",timestamp:"",rsi:"",sma:"",bb:{upper:"",lower:"",isCrossed:"",middel:"",pb:""}},stockData=[];app.post("/createStrategy",a,function(e,t){var s=JSON.parse(e.body.data),a=s.uid,o=s.name,n=s.symbol,r=s.exchange,i=s.orderType,l=s.symbolToBuySell,c=s.interval;insertDB("INSERT INTO Strategy (uid,name,symbol,exchange,orderType,symbolToBuySell,interval)VALUES(?,?,?,?,?,?,?)",[a,o,n,r,i,l,c]).then(e=>{"success"==e?getFirst("select sid from Strategy where uid=?",[a]).then(e=>{if(null==e.sid)t.send("error");else{console.log(e.sid);var a=e.sid;s.indicators.map(async e=>{var t=e.indicator,s=e.settings,o=e.value,n=e.op;insertDB("INSERT INTO Indicators (sid,indicator,settings,value,op)VALUES(?,?,?,?,?)",[a,t,s,o,n]).then(e=>{console.log("result > "+JSON.stringify(e))})}),t.send("success")}}):t.send("error")});var u=new Date;"5MINUTE"==c?u.setDate(u.getDate()-2):"3MINUTE"==c?u.setDate(u.getDate()-1):"15MINUTE"==c?u.setDate(u.getDate()-2):"10MINUTE"==c?u.setDate(u.getDate()-3):"30MINUTE"==c?u.setDate(u.getDate()-4):"60MINUTE"==c?u.setDate(u.getDate()-4):"1DAY"==c?u.setDate(u.getDate()-20):"1WEEK"==c?u.setDate(u.getDate()-140):"1MONTH"==c&&u.setMonth(u.getMonth()-20);var d=u.getDate()+"-"+(u.getMonth()+1)+"-"+u.getFullYear();b(),stockData=[],loadSymbol(s.symbol,s.exchange,c,d).then(function(e){t.setHeader("Content-Type","application/json"),stockData=e.data,lastObject={open:"",close:"",low:"",high:"",volume:"",timestamp:"",rsi:"",sma:"",bb:{upper:"",lower:"",isCrossed:"",middel:"",pb:""}},stockData.map(e=>{var t=moment.tz(new Date(+e.timestamp),"Asia/Kolkata");return t.format(),e.timestamp=t.date()+"/"+(t.month()+1)+"/"+t.year()+" "+t.hour()+":"+t.minute(),e.rsi=rsi.nextValue(+e.close),e.sma=sma.nextValue(+e.close),e.bb=bb.nextValue(+e.close),lastObject=e,e}),stockData.reverse();for(var a={symbol:s.symbol,close:stockData[0].close,volume:stockData[0].volume,rsi:stockData[0].rsi,timestamp:stockData[0].timestamp,sma:stockData[0].sma,bb:stockData[0].bb},o=!1,n=0;n<s.indicators.length;n++){var r=s.indicators[n].op,i=a[s.indicators[n].indicator],l=s.indicators[n].value,c=!1;"<"==r?c=i<l:">"==r?c=i>l:"<="==r?c=i<=l:">="==r?c=i>=l:"=="==r&&(c=i==l),c&&(o=!0),console.log("isMatch :> "+o)}if(o){var u={transaction_type:s.orderType,exchange:s.exchange,symbol:s.symbolToBuySell,quantity:1,order_type:"m"};upstox.placeOrder(u).then(function(e){console.log(e)}).catch(function(e){console.log(chalk.red(e)),e=null})}console.log("Result "+JSON.stringify(a)),t.send(JSON.stringify(a)),stockData=null,t.end()}).catch(function(e){console.log("createStrategy error > "+JSON.stringify(e)),e=null})}),app.get("/loadSymbol/:symbol/:interval",a,function(e,t){console.log("params: "+JSON.stringify(e.params));var s=e.params.symbol,a=e.params.interval,o=new Date;"5MINUTE"==a?o.setMinutes(o.getMinutes()-100):"3MINUTE"==a?o.setMinutes(o.getMinutes()-60):"10MINUTE"==a?o.setMinutes(o.getMinutes()-200):"15MINUTE"==a?o.setMinutes(o.getMinutes()-300):"30MINUTE"==a?o.setMinutes(o.getMinutes()-600):"60MINUTE"==a?o.setMinutes(o.getMinutes()-1200):"1DAY"==a?o.setDate(o.getDate()-20):"1WEEK"==a?o.setDate(o.getDate()-140):"1MONTH"==a?o.setMonth(o.getMonth()-20):o.setDate(o.getDate()-20);var n=o.getDate()+"-"+(o.getMonth()+1)+"-"+o.getFullYear();console.log("start_date > "+a+" >> "+n);var r={values:[],period:14},i=new technicalindicators.RSI(r),l={values:[],period:20},c=new technicalindicators.SMA(l),u={period:14,values:[],stdDev:2},d=new technicalindicators.BollingerBands(u);u=r=l=null,stockData=[],loadSymbol(s,"NSE_EQ",a,n).then(function(e){t.setHeader("Content-Type","application/json"),stockData=e.data,lastObject={open:"",close:"",low:"",high:"",volume:"",timestamp:"",rsi:"",sma:"",bb:{upper:"",lower:"",isCrossed:"",middel:"",pb:""}},stockData.map(e=>{return moment.tz(new Date(+e.timestamp),"Asia/Kolkata").format(),e.rsi=i.nextValue(+e.close),e.sma=c.nextValue(+e.close),e.bb=d.nextValue(+e.close),e&&e.bb&&+e.close>=+e.bb.upper?e.bb.isCrossed="Crossed Above":e&&e.bb&&+e.close<=+e.bb.lower&&(e.bb.isCrossed="Crossed Below"),lastObject=e,e}),stockData.reverse(),t.send(JSON.stringify(stockData)),stockData=null,t.end()}).catch(function(s){if(401==s.code){accessToken="",store.set("accessToken",accessToken);var a=upstox.getLoginUri(redirect_uri);t.status(200).header("Content-type","text/html"),code=e.params.code,t.status(302).setHeader("Location",a),t.end(),s=a=null}console.log("/loadSymbol/:symbol/:interval error > "+JSON.stringify(s))})}),app.get("/getFutureContract/:exchange",a,function(e,t){var s=e.params.exchange;fs.readFile("data/index/nse_fo.txt","utf8",function(e,a){var o=csvTojs(JSON.parse(a).data).filter(e=>e.instrument_type+""===s).map(e=>e.symbol);t.setHeader("Content-Type","application/json"),t.send(o),t.end()})}),app.get("/getStockIndicators/:symbol/:interval",a,function(e,t){var s=e.params.symbol,a=e.params.interval;new Promise(function(e){e(getStock(s,a))}).then(e=>{var s={values:[],period:14};rsi=new technicalindicators.RSI(s);var o={values:[],period:20};sma=new technicalindicators.SMA(o);var n={period:14,values:[],stdDev:2};bb=new technicalindicators.BollingerBands(n),n=s=o=null;var r=[];try{(r=JSON.parse(e.data)).map(e=>(e.rsi=rsi.nextValue(+e.close),e.sma=sma.nextValue(+e.close),e.bb=bb.nextValue(+e.close),e)),r.reverse(),t.setHeader("Content-Type","application/json")}catch(e){console.log(e)}t.send(JSON.stringify(r)),exchange=list=a=null,t.end()}).catch()}),app.get("/getDefaultIndicators/:interval/:exchange",a,function(e,t){var s=e.params.interval,a=e.params.exchange,o=[];o="nifty"==a?store.get("niftyList"):"fno"==a?store.get("fnoList"):store.get("nseSymbolList"),Promise.all(o.map(async e=>{return getStock(e.symbol?e.symbol:e,s)})).then(e=>{var n={values:[],period:14};rsi=new technicalindicators.RSI(n);var r={values:[],period:20};sma=new technicalindicators.SMA(r);var i={period:14,values:[],stdDev:2};bb=new technicalindicators.BollingerBands(i),i=n=r=null;var l=e.map(async e=>{try{var t=JSON.parse(e.data);return t.map(e=>{var t=moment.tz(new Date(+e.timestamp),"Asia/Kolkata");return t.format(),e.timestamp=t.date()+"/"+(t.month()+1)+"/"+t.year()+" "+t.hour()+":"+t.minute(),e.rsi=rsi.nextValue(+e.close),e.sma=sma.nextValue(+e.close),e.bb=bb.nextValue(+e.close),lastObject=e,e}),t.reverse(),{symbol:e.symbol,close:t[0].close,volume:t[0].volume,rsi:t[0].rsi,timestamp:t[0].timestamp,sma:t[0].sma,bb:t[0].bb}}catch(e){console.log("Error "+e)}});Promise.all(l).then(e=>{t.setHeader("Content-Type","application/json"),t.send(JSON.stringify(e)),a=o=s=null,t.end()}).catch()}).catch(e=>{console.log(e)})});var result=[],map=new Map;app.get("/loadAllSymbolData/:interval/:exchange",a,function(e,t){console.log("params: "+JSON.stringify(e.params));var s=e.params.interval,a=e.params.exchange,o=[];o="nifty"==a?store.get("niftyList"):"fno"==a?store.get("fnoList"):store.get("nseSymbolList");var n=[];if("5MINUTE"==s?n=store.get("data5"):"3MINUTE"==s?n=store.get("data3"):"10MINUTE"==s?n=store.get("data10"):"15MINUTE"==s?n=store.get("data15"):"30MINUTE"==s?n=store.get("data30"):"60MINUTE"==s?n=store.get("data60"):"1DAY"==s?n=store.get("data1day"):"1WEEK"==s?n=store.get("data1week"):"1MONTH"==s&&(n=store.get("data1month")),n&&null!=n&&0<n.length&&n.filter(function(e){return null!=e&&null!=e.close&&null!=e.close&&""!=e.close}),n&&0<n.length&&n[0])t.setHeader("Content-Type","application/json"),t.send(JSON.stringify(n)),t.end();else{console.log("*No data available "+s+" Fetch it.");var r=new Date;"5MINUTE"==s?r.setDate(r.getDate()-2):"3MINUTE"==s?r.setDate(r.getDate()-2):"10MINUTE"==s?r.setDate(r.getDate()-3):"15MINUTE"==s?r.setDate(r.getDate()-3):"30MINUTE"==s?r.setDate(r.getDate()-4):"60MINUTE"==s?r.setDate(r.getDate()-4):"1DAY"==s?r.setDate(r.getDate()-30):"1WEEK"==s?r.setDate(r.getDate()-140):"1MONTH"==s&&r.setMonth(r.getMonth()-20);var i=r.getDate()+"-"+(r.getMonth()+1)+"-"+r.getFullYear();loadAllSymbolData(o,s,i).then(function(e){console.log("\n loadAllSymbolData **"+JSON.stringify(e));"5MINUTE"==s?store.set("data5",e):"3MINUTE"==s?store.set("data3",e):"10MINUTE"==s?store.set("data10",e):"15MINUTE"==s?store.set("data15",e):"30MINUTE"==s?store.set("data30",e):"60MINUTE"==s?store.set("data60",e):"1DAY"==s?store.set("data1day",e):"1WEEK"==s?store.set("data1week",e):"1MONTH"==s&&store.set("data1month",e),t.setHeader("Content-Type","application/json"),t.send(JSON.stringify(e)),a=o=s=null,t.end()}).catch(function(e){console.log("loadAllSymbolData/ error > "+JSON.stringify(e))})}}),app.get("/getListOfAllSymbol",a,function(e,t){t.setHeader("Content-Type","application/json"),0<(fnoList=store.get("fnoList")).length?t.send(JSON.stringify(fnoList)):t.send(JSON.stringify(getListOfAllSymbol())),t.end()}),app.get("/getBalance",function(e,t){t.setHeader("Content-Type","application/json"),t.send(JSON.stringify(balance)),t.end()}),app.get("/getProfile",function(e,t){t.setHeader("Content-Type","application/json"),t.send(JSON.stringify(profile)),t.end()}),app.post("/scan",function(){}),app.get("/admin",a,function(e,t){var s=moment.tz(store.get("tokenValidity"),"Asia/Kolkata"),a=new Date,o=moment.tz(a,"YYYY-DD-MM HH:mm","Asia/Kolkata");if(o.format(),console.log("tokenValidity "+o+":"+s+":"+s.isBefore(o)),s.isBefore(o)&&(accessToken="",store.set("accessToken",accessToken)),store.get("accessToken")&&""!=store.get("accessToken"))accessToken=store.get("accessToken"),upstox.setToken(accessToken),getListOfAllSymbol(),t.sendFile("index.html",{root:__dirname});else{var n=upstox.getLoginUri(redirect_uri);console.log("*loginUri "+n),t.status(200).header("Content-type","text/html"),code=e.params.code,t.status(302).setHeader("Location",n),t.end()}}),app.use(function(e,t){t.status(404).send("Sorry, that route doesn't exist. Have a nice day :)")}),app.listen(PORT,function(){console.log("App listening on port "+PORT)})}cluster.on("exit",function(e){console.log("Worker %d died :(",e.id),cluster.fork()});var strategy_smaCross1={name:"EMA Cross Over",description:"Crossed 13 ema with 50 SMA",isLive:!1,isBuyOrSell:"b",strategy:[{indicators:[{indicator:"EMA",period:13,values:"closes"},{indicator:"EMA",period:50,values:"closes"}],output:[],strategy:"output[0][0] >= output[1][0]"},{indicators:[{indicator:"SMA",period:20,values:"closes"},{indicator:"SMA",period:50,values:"closes"}],output:[],strategy:"output[0][1] < output[1][1]"}]},strategy_sma200={name:"SMA 200 Cross Over",description:"Close above 200 sma",isBuyOrSell:"b",isLive:!1,strategy:[{indicators:[{indicator:"SMA",period:200,values:"closes"}],output:[],strategy:"closes[i] >= output[0][i]"},{indicators:[{indicator:"SMA",period:200,values:"opens"}],output:[],strategy:"opens[i+1] <= output[0][i]"},{indicators:[{indicator:""}],output:[],strategy:"closes[i] > opens[i]"}]},strategy_rsi60_crossed={name:"RSI : 60 Cross Over",description:"RSI : 60 Cross Over",isLive:!1,isBuyOrSell:"b",strategy:[{indicators:[{indicator:"RSI",period:14,values:"closes"}],output:[],strategy:"output[0][i] >= 60"},{indicators:[{indicator:"RSI",period:14,values:"closes"}],output:[],strategy:"output[0][i+1] < 60"},{indicators:[{indicator:""}],output:[],strategy:"((closes[0] - opens[0]) / (highs[0] - lows[0])) >= 0.5"},{indicators:[{indicator:""}],output:[],strategy:"closes[i] > opens[i]"}]},strategy_rsi40_crossed={name:"RSI : 40 Cross Over",description:"RSI : 40 Cross Over",isBuyOrSell:"s",isLive:!1,strategy:[{indicators:[{indicator:"RSI",period:14,values:"closes"}],output:[],strategy:"output[0][i] <= 40"},{indicators:[{indicator:"RSI",period:14,values:"closes"}],output:[],strategy:"output[0][i+1] >= 40"},{indicators:[{indicator:""}],output:[],strategy:"((closes[0] - opens[0]) / (highs[0] - lows[0])) <= -0.5"},{indicators:[{indicator:""}],output:[],strategy:"closes[i] < opens[i]"}]},strategy_bbLower={name:"Bollinger band : lower band Cross Over",description:"Bollinger band : lower band Cross Over",isBuyOrSell:"s",isLive:!1,strategy:[{indicators:[{indicator:"BB",period:14,values:"closes",stdDev:2}],output:[],strategy:"closes[i] <= output[0][i]['lower']"},{indicators:[{indicator:"BB",period:14,values:"closes",stdDev:2}],output:[],strategy:"opens[i] >= output[0][i]['lower']"},{indicators:[{indicator:""}],output:[],strategy:"closes[i] < opens[i]"},{indicators:[{indicator:""}],output:[],strategy:"((closes[i] - opens[i]) / (highs[i] - lows[i])) <= -0.5"}]},strategy_bbUpper_band_crossed={name:"Bollinger band : Upper band Cross Over",description:"Bollinger band : Upper band Cross Over",isBuyOrSell:"b",isLive:!1,strategy:[{indicators:[{indicator:"BB",period:14,values:"closes",stdDev:2}],output:[],strategy:"closes[i] >= output[0][i]['upper']"},{indicators:[{indicator:"BB",period:14,values:"closes",stdDev:2}],output:[],strategy:"opens[i] <= output[0][i]['upper']"},{indicators:[{indicator:""}],output:[],strategy:"closes[i] > opens[i]"},{indicators:[{indicator:""}],output:[],strategy:"((closes[i] - opens[i]) / (highs[i] - lows[i])) >= 0.5"}]},strategyList=[strategy_rsi60_crossed,strategy_bbUpper_band_crossed,strategy_bbLower],technicalindicators=require("technicalindicators"),fs=require("fs"),path=require("path"),moment=require("moment-timezone"),months=["January","February","March","April","May","June","July","August","September","October","November","December"],date=new Date,today=date.getDate()+"-"+(date.getMonth()+1)+"-"+date.getFullYear(),time=date+":"+date.getHours()+":"+date.getMinutes(),days=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],strategyObj={symbol:"BANKNIFTY19JANFUT",indicators:[{indicator:"rsi",settings:"14",value:"60",op:">="},{indicator:"sma",settings:"20",value:"close",op:">="}],interval:"15min"};function backTesting(e){e.filter(function(e){return 60<=e.rsi}).filter(function(e){return e.close>=e.sma})}function mappedFunction(){}function transform(e){if(0<e.timestamp){var t=new Date(+e.timestamp),s=moment.tz(t,"DD-MM-YYYY HH:mm","Asia/Kolkata");s.format()}return e.timestamp=s,e}var index=0,buyprice=0,sellprice=0,profit=0,totalProfit=0,isBuySignalGenerated=!1,isSellSignalGenerated=!1,buyCall=0,sellCall=0;function calculateIndicators(e){e.rsi=rsi.nextValue(+e.close),e.sma=sma.nextValue(+e.close),e.bb=bb.nextValue(+e.close);var t=new Date(+e.timestamp),s=moment.tz(t,"DD-MM-YYYY HH:mm","Asia/Kolkata");return s.format(),e.date=s.date()+"/"+(s.month()+1)+"/"+s.year()+" "+s.hour()+":"+s.minute(),9==s.hour()&&25==s.minute()&&e.bb&&e.close>e.bb.upper&&(buyCall++,buyprice=e.close,isBuySignalGenerated=!0,console.log("\n\n BUY *>> "+e.date+" >> "+buyprice)),isBuySignalGenerated?e.bb&&e.close<=e.bb.middle&&(isBuySignalGenerated=!1,profit=e.close-buyprice,totalProfit+=profit,console.log("\n\n EXIT CALL *>> "+e.date+" close >> "+e.close+" profit>> "+profit+" totalProfit >> "+totalProfit+">>"+buyCall)):isSellSignalGenerated&&(40<obj.rsi||e.close>obj.sma)&&(isSellSignalGenerated=!1,profit=sellprice-e.close,totalProfit+=profit,console.log("\n\n EXIT SELL *>> "+e.date+" close >> "+e.close+" profit>> "+profit+" totalProfit >> "+totalProfit+">>"+sellCall)),index++,e}function log(e){if("production"!=process.env.NODE_ENV){date=new Date;var t="logs/log-"+(today=date.getDate()+"-"+(date.getMonth()+1)+"-"+date.getFullYear())+".txt";try{fs.existsSync(t)?fs.appendFile(t,"\n"+date+" "+e,function(e){if(e)throw e}):fs.writeFile(t,"\n"+date+" "+e,function(e){if(e)throw e})}catch(s){console.error(s),fs.writeFile(t,"\n"+date+" "+e,function(e){if(e)throw e})}}}function addIndicators(e,t){var s=e.data;for(let e of s){return(o=e).timestamp=new Date(o.timestamp),o}var a=[];for(let e of s)a.push(e.close);for(let e of s){var o;return 0,o=e}backTesting(s,t)}var database,fs=require("fs"),path=require("path"),async=require("async"),loki=require("lokijs"),intervalsArr=["1WEEK","1DAY","60MINUTE","30MINUTE","15MINUTE","10MINUTE","5MINUTE"],queue=async.queue(function(e,t){if(e.symbol){var s;try{s=path.resolve(path.join(__dirname,"..","db/stock/"+e.interval+"/"+e.symbol+".db"))}catch(e){console.log("Error > "+e)}var a=new loki(s,{autoload:!0,autoloadCallback:function(){var o=a.getCollection(e.symbol);o||(o=a.addCollection(e.symbol));var n=[];(null==e.ex||null==e.ex||""==e.ex)&&(e.ex="NSE_EQ"),loadSymbol(e.symbol,e.ex,e.interval,e.start_date,e.end_date).then(function(r){try{""!=r&&null!=r&&null!=r?(n=r,r.error?console.log("Queue error "+e.symbol+" :: "+e.ex+" :: "+JSON.stringify(r.error)):o.get(1)&&o.get(1).data&&o.get(1).data.timestamp&&o.get(1).data.timestamp===r.timestamp?console.log("Do nothing   "+e.interval+"> "+e.symbol):(o.clear(),o.insert(n)),a.saveDatabase(),a.close(),t()):(a.close(),t()),s=e=n=r=null}catch(o){a.close(),console.log("loadHandler queue : err   > "+o),s=e=o=null,t()}})},autosave:!0,autosaveInterval:1e4})}},15);async function syncLiveAllStockData(e,t,s,a){e.map(async e=>{var o=e.symbol?e.symbol:e,n=e.ex;queue.push({symbol:o,ex:n,interval:t,start_date:s,end_date:a},function(){}),e=o=n=null})}async function syncAllUpstoxData(e){intervalsArr.map(async t=>{console.log("syncAllUpstoxData : Finished Queue  - "+t),e.map(async e=>{var s=e.symbol?e.symbol:e,a=e.ex;queue.push({symbol:s,ex:a,interval:t,start_date:start_date,end_date:end_date},function(){})})})}async function getPercent_list(e){console.log("getPercent_list  % "+e.length);var t=["1DAY","15MINUTE"];Promise.all(t.map(async t=>new Promise(function(s){Promise.all(e.map(async e=>getStock(e.symbol?e.symbol:e,t))).then(e=>{s(e)}).catch(e=>{console.log(e)})}))).then(e=>{for(var s=[],a=0;a<e[0].length;a++)try{var o=e[0][a],n=e[1][a];if(o.symbol==n.symbol){var r=[];(r=JSON.parse(o.data)).reverse();var i=[];(i=JSON.parse(n.data)).reverse();var l=getPercentageChange(r[0].close,i[0].close),c={};c.symbol=o.symbol,c.percentage=l,s.push(c),r=i=null}}catch(e){console.log("Parsing error "+o.symbol+" : "+e)}s.sort(function(e,t){return e.percentage-t.percentage}),s.reverse(),store.set("percentage",s),s=e=t=null}).catch(e=>{console.log(e)})}async function getDefaultIndicatorsValues(e,t){Promise.all(e.map(async e=>{return getStock(e.symbol?e.symbol:e,t)})).then(e=>{e.map(async e=>{try{JSON.parse(e.data)}catch(e){console.log("Error "+e)}})}).catch(e=>{console.log(e)})}async function backTesting(e,t,s,a){var o=[];return new Promise(function(s){s(getStock(e,t))}).then(t=>{try{var n=JSON.parse(t.data);startBackTesting(e,n,s,a).then(e=>{for(var a=0;a<e[1].length;a++)e[0][a].every(e=>1==e.flag)&&o.push(e[1][a][0].date);console.log("\n backTesting RESULT  > "+s.name+"::"+t.symbol+" > "+o)}).catch(e=>{console.log("OUTER LOOP ERROR > "+e)})}catch(e){console.log("Error "+e)}}).catch(e=>{console.log(e)})}async function syncLiveStockDataByInterval(e,t){e.map(async e=>{var s=e.symbol?e.symbol:e,a=e.ex;queue.push({symbol:s,ex:a,interval:t},function(){})})}function getStockDataByInterval(e,t){getStock(e,t).then(e=>{JSON.parse(e.data)}).catch(e=>console.log(e))}function getStock(e,t){return new Promise((s,a)=>{var o;try{o=path.resolve(path.join(__dirname,"..","db/stock/"+t+"/"+e+".db"))}catch(e){console.log("getStock > Error > "+e),a(e),e=null}var n=new loki(o,{autoload:!0,autoloadCallback:function(){var t=n.getCollection(e);t||(t=n.addCollection(e));try{t.get(1)&&t.get(1).data&&t.get(1).data?s({symbol:e,data:JSON.stringify(t.get(1).data)}):s({symbol:e,data:[]}),n.close()}catch(e){n.close(),a(e),e=null}},autosave:!0,autosaveInterval:1e4})})}var accessToken,Upstox=require("upstox"),moment=require("moment-timezone"),api="OknufM07tm1g9EfN4fHKP2Eqi9DSw40I2Y3xliHg",upstox=new Upstox(api),fs=require("fs"),months=["January","February","March","April","May","June","July","August","September","October","November","December"],code="",__dirname="views",exchanges=["MCX_FO","BSE_EQ","NSE_EQ","NSE_FO","NCD_FO"],api_secret="69xldylnvf",client_id="";function getAcceToken(e){var t={apiSecret:api_secret,code:e,grant_type:"authorization_code",redirect_uri:redirect_uri};upstox.getAccessToken(t).then(function(s){t=api_secret=e=null,accessToken=s.access_token,store.set("accessToken",accessToken);var a=new Date,o=moment.tz(a,"DD-MM-YYYY HH:mm","Asia/Kolkata");o.format(),o=o.set({year:o.year(),date:o.date()+1,hour:9,minute:5,second:5}),store.set("tokenValidity",o),console.log("****accessToken*\n"+accessToken),upstox.setToken(accessToken),start()}).catch(function(e){console.log("getAccessToken > "+e)})}function start(){async.parallel({getProfile:getProfile,getBalance:getBalance,getListOfAllSymbol:getListOfAllSymbol,getAllData:getAllData},function(){}),upstox.getMasterContract({exchange:"nse_fo"}).then(function(e){console.log("FNO data >> \n \n"+transformedData),fs.writeFile("data/index/nse_fo.txt",JSON.stringify(e),function(e){if(e)throw e;console.log("nse_fo File is created successfully.")})}).catch(function(e){console.log("nse fo error "+JSON.stringify(e))}),upstox.connectSocket().then(function(){upstox.on("orderUpdate",function(e){console.log("orderUpdate"+e)}),upstox.on("positionUpdate",function(e){console.log("positionUpdate"+e)}),upstox.on("tradeUpdate",function(e){console.log("tradeUpdate"+e)});var e=niftyList.join();upstox.subscribeFeed({exchange:"NSE_EQ",symbol:e,type:"ltp"}).then(function(e){console.log("feedsymbols subscribeFeed response ",e)}).catch(function(e){console.log("Error in subscribe feed ",e)}),upstox.on("liveFeed",function(e){console.log("liveFeed"+e)}),upstox.on("disconnected",function(e){console.log("disconnected > "+e)}),upstox.on("error",function(e){console.log("error"+e)})}).catch(function(e){console.log("connectSocket #"+e)})}var nseSymbolList=[],balance,profile;function getListOfAllSymbol(){}function getBalance(){upstox.getBalance({type:"security"}).then(function(e){balance=JSON.stringify(e),getListOfAllSymbol()}).catch(function(e){console.log(e),getListOfAllSymbol()})}function getProfile(){upstox.getProfile().then(function(e){client_id=e.data.client_id,profile=JSON.stringify(e.data)}).catch(function(e){console.log("Error"+e)})}async function loadSymbol(e,t,s="1day",a="",o=""){if(store.get("accessToken"))return new Promise(function(n,r){upstox.getOHLC({exchange:t,symbol:e,start_date:a,end_date:o,format:"json",interval:s}).then(e=>{n(e)}).catch(e=>{r(e)})})}function getAllData(){var e=new Date;e.getDate(),e.getMonth(),e.getFullYear();e.setDate(e.getDate()-21),e.getDate(),e.getMonth(),e.getFullYear(),syncAllUpstoxData(watchList,"1DAY"),getPercent_list(watchList)}var stockData=[],data={},promiseArr=[];async function loadAllSymbolData(e,t="1DAY",s="11-11-2018"){return console.log("* Step 1 : loadSymbol "),promiseArr=[],Promise.all(e.map(function(e){return loadSymbol(e,"NSE_EQ",t,s).then(function(t){try{console.log("* loadSymbol "+JSON.stringify(t)),stockData=t.data;var s;if(inputBB=inputSMA=null,stockData.map(e=>(e&&e.close,e.change=getPercentageChange(+lastObject.close,+e.close),e.bb&&+e.close>=+e.bb.upper?e.bb.isCrossed="Crossed Above":e.bb&&+e.close<=+e.bb.lower&&(e.bb.isCrossed="Crossed Below"),lastObject=e,e)),stockData.reverse(),0<stockData[0].timestamp){var a=new Date(+stockData[0].timestamp),o=moment.tz(a,"DD-MM-YYYY HH:mm","Asia/Kolkata");o.format(),s=0<o.minute()?o.date()+"/"+(o.month()+1)+"/"+o.year()+" "+o.hour()+":"+o.minute():o.date()+"/"+(o.month()+1)+"/"+o.year()}return data={symbol:e,close:stockData[0].close,volume:stockData[0].volume,rsi:stockData[0].rsi,timestamp:s,sma:stockData[0].sma,bb:stockData[0].bb,change:stockData[0].change},stockData=null,promiseArr.push(data),data}catch(e){console.log("loadAllSymbolData : err   > "+e)}})}))}async function getUpstoxData(e,t="1DAY",s="",a=""){return console.log("* Step 1 : loadSymbol "),promiseArr=[],Promise.all(e.map(function(e){return loadSymbol(e,"NSE_EQ",t,s,a).then(function(e){try{return console.log("* loadSymbol "+JSON.stringify(e)),stockData=e.data,promiseArr.push(data),data}catch(e){console.log("loadAllSymbolData : err   > "+e)}})}))}function csvTojs(e){for(var t=e,s=[],a=t[0].split(","),o=1;o<t.length;o++){var n={},r=t[o],i=0,l=0,c=0;if(""!==r.trim()){for(;c<r.length;){var u=r[c];if('"'===u)do{u=r[++c]}while('"'!==u&&c<r.length-1);if(","===u||c===r.length-1){var d=r.substr(l,c-l).trim();'"'===d[0]&&(d=d.substr(1)),","===d[d.length-1]&&(d=d.substr(0,d.length-1)),'"'===d[d.length-1]&&(d=d.substr(0,d.length-1)),n[a[i++]]=d,l=c+1}++c}s.push(n)}}return s}function getPercentageChange(e,t){return((t-e)/e*100).toFixed(2)}Array.prototype.insert=function(e,...t){return this.slice(0,e).concat(t,this.slice(e))};