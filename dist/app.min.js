//require('./Utility.js');
/* require('./MailServer.js');
require('db.js');
require('Strategy.js');
require('UpstoxAPI.js');
require('server.js');
require('Scheduler.js');
 */
var SMA = require('technicalindicators').SMA;
var EMA = require('technicalindicators').EMA;
var RSI = require('technicalindicators').RSI;
var BB = require('technicalindicators').BollingerBands;
var ADL = require('technicalindicators').ADL;
var ADX = require('technicalindicators').ADX;
var ATR = require('technicalindicators').ATR
var MACD = require('technicalindicators').MACD;
var bullish = require('technicalindicators').bullish;

async function startBackTesting(symbol,stockData,strategyList,isBackTesting){ 
    var closes = [];
    var opens = [];
    var highs = [];
    var lows = [];
    var timestamps = [];
    var values = stockData.map(async (obj) =>  {
        closes.push(Number(obj.close));       
        opens.push(Number(obj.open));       
        highs.push(Number(obj.high));       
        lows.push(Number(obj.low));       
        timestamps.push(Number(obj.timestamp));       
    });  
    var result = [];
    var output = new Array();
    timestamps = timestamps.reverse();//**********  dont't change **********  
    return Promise.all(strategyList.strategy.map(async (strategyObj) => {  
        return new Promise(function(resolved, rejected) {   
            Promise.all(strategyObj.indicators.map(async (indicatorObj) => {
                return new Promise(function(resolve, reject) {
                    try{
                        if(indicatorObj.indicator && indicatorObj.indicator != ""){
                            if(indicatorObj.values == "closes")
                                indicatorObj.values = eval(indicatorObj.values);
                            else
                                indicatorObj.values = closes;
                            
                            var str = indicatorObj.indicator+".calculate("+JSON.stringify(indicatorObj)+")";
                            var res = eval(str); 
                            var op = isBackTesting ? res.reverse():res.reverse().slice(0, 3);  //**********  dont't change **********  
                            output.push(op);     
                           // console.log("backTesting *indicators " +symbol +" > " +closes[0] +">> "+JSON.stringify(output));
                            indicatorObj = null;
                            resolve(op);   
                        }     
                        else{
                            resolve("");   
                        }                
                    }
                    catch(e){
                        reject(e);
                    }
                });        
            }))
            .then(obj => { 
                closes = closes.reverse(); //**********  dont't change **********  
                var strategyRes = [];

                for(var i=0;i < obj[0].length - 2;i++)
                {
                    if(result[i] == null || result[i] == undefined )
                    {
                        result[i] = new Array();
                    }
                    var flag = eval(strategyObj.strategy);   
                    
                    var india = moment.tz(new Date(Number(timestamps[i])), "Asia/Kolkata");
                    india.format(); 
                    var d = india.date() +"/"+(india.month() + 1) +"/"+india.year()+" "+india.hour()+":"+india.minute();
                    result[i].push({date:d, flag : flag}); 
                }
                closes = closes.reverse(); //**********  dont't change **********  
                //console.log("\n \n  then " +strategyObj.strategy +"::: "+JSON.stringify(result));

                return resolved(result);                   
            })
            .catch(err => {
                rejected(err);
                console.log("INNER LOOP : " + err)
                err = null;
            });
        })
    }));
 }

Array.prototype.insert = function(i,...rest){
    return this.slice(0,i).concat(rest,this.slice(i));
}
var SMA = require('technicalindicators').SMA;
var EMA = require('technicalindicators').EMA;
var RSI = require('technicalindicators').RSI;
var BB = require('technicalindicators').BollingerBands;
var ADL = require('technicalindicators').ADL;
var ADX = require('technicalindicators').ADX;
var ATR = require('technicalindicators').ATR
var MACD = require('technicalindicators').MACD;
var bullish = require('technicalindicators').bullish;

class BaseStrategy {
    constructor() {
    }

    async executeStrategy(symbol,stockData,strategyList){
        var closes = [];
        var opens = [];
        var highs = [];
        var lows = [];
        var timestamps = [];
        var values = stockData.map(async (obj) =>  {
            closes.push(Number(obj.close));       
            opens.push(Number(obj.open));       
            highs.push(Number(obj.high));       
            lows.push(Number(obj.low));       
            timestamps.push(Number(obj.timestamp));       
        });  

        timestamps = timestamps.reverse();//**********  dont't change **********  
        return Promise.all(strategyList.strategy.map(async (strategyObj) => {  
                return new Promise(function(resolved, rejected) {
                    var result = [];
                    var output = new Array();
                    Promise.all(strategyObj.indicators.map(async (indicatorObj) => {
                        return new Promise(function(resolve, reject) {
                            try{
                                if(indicatorObj.indicator && indicatorObj.indicator != ""){
                                    if(indicatorObj.values == "closes")
                                        indicatorObj.values = eval(indicatorObj.values);
                                    else
                                        indicatorObj.values = closes;
                                    
                                    //console.log("*getIndicator " +symbol +" > " +closes[0] +" ::"+ indicatorObj.values[0]);
                                    var str = indicatorObj.indicator+".calculate("+JSON.stringify(indicatorObj)+")";
                                    var res = eval(str); 
                                    //console.log("*getIndicator " +res); 
                                    var op = res.reverse().slice(0, 3);  //**********  dont't change **********  
                                    output.push(op);     
                                    //console.log("*indicators " +symbol +" > " +closes[0] +">> "+JSON.stringify(output));
                                    op = str = res = indicatorObj = null;
                                    resolve(output);   
                                }     
                                else{
                                    resolve("");   
                                }                
                            }
                            catch(e){
                                reject(e);
                            }
                        });        
                    }))
                    .then(obj => { 
                        //console.log("***** " +strategyObj.strategy);
                        closes = closes.reverse(); //**********  dont't change **********  
                        highs = highs.reverse(); //**********  dont't change **********  
                        lows = lows.reverse(); //**********  dont't change **********  
                        opens = opens.reverse(); //**********  dont't change **********  
                        var i = 0;
                        var strategy = eval(strategyObj.strategy);
                        result.push(strategy);   
                        //console.log("*" +symbol +" > " + result +":: "+ eval((closes[0] - opens[0])/highs[0] - lows[0]));
                        closes = closes.reverse(); //**********  dont't change **********  
                        highs = highs.reverse(); //**********  dont't change **********  
                        lows = lows.reverse(); //**********  dont't change **********  
                        opens = opens.reverse(); //**********  dont't change **********  
                        var d =new Date(Number(timestamps[0])); 
                        var strategyRes = result.every(x => x == true);  
                        
                        // console.log(symbol +" > " + d +"  > "+  strategyRes +" > "+ result);  
                        
                        output = result = i = d = null;
                        //closes =  opens =  highs = lows = timestamps = finalResult=  strategyObj = null;
                        return resolved(strategyRes);       
                                    
                    })
                    .catch(err => {
                        rejected(err);
                        console.log("INNER LOOP : " + err);
                        err = null;
                    });
            })
        }));
    }

}

//Sync Upstox data on by Interval, eg 15 min sync
async function applyStrategy(list,interval,strategy){ 
    //console.log("ApplyStrategy > " + list.length +"::"+   strategy.name +"::"+ interval);
    var base;
    var matchSymbols = [];
    return Promise.all(list.map(async (x) =>  {
    var symbol = x.symbol ? x.symbol:x;    
    return getStockDataFromDb(symbol,interval);          
    })).then(stockData => {
        var arr = stockData.map(async (dataObj) =>  {
            try{
                var data = JSON.parse(dataObj.data); 
                base = new BaseStrategy();
                await base.executeStrategy(dataObj.symbol,data,strategy).then(finalResult => { 
                    var finalResultFlag = finalResult.every(x => x == true);
                    if(finalResultFlag){
                        matchSymbols.push(dataObj.symbol);
                        //console.log("Strategy RESULT  > " + finalResult +"::"+   strategy.name +"::"+ dataObj.symbol +" > "+ matchSymbols.length);
                    }
                    finalResult= finalResultFlag= dataObj =base = null;             
                }).catch(error => 
                {
                    console.log("OUTER LOOP ERROR > " + error);
                    error = base = null;
                });
            }
            catch(e){
                //console.log("applyStrategy Error: " + JSON.stringify(e));
                e = base = null;
            }
        });       
      
        Promise.all(arr).then(a=>
        {
            console.log("Strategy result  > " +today +" : "+strategy.name+" : "+ interval +" : "+ matchSymbols);

            if(process.env.NODE_ENV=="production")
            {
                sendingMail("satish.patel41@gmail.com",strategy.name,matchSymbols).catch(console.error);
            }
            
            closes =  opens =  highs = lows = timestamps =   matchSymbols =null;
            return {strategy:strategy.name,matchSymbols:matchSymbols};
        })
        .catch(err => {
            //console.log("applyStrategy error 1  " + err);
            err =null;
        });
                    
    })
    .catch(error => { 
        //console.log("applyStrategy error  2  " + err);
        error =null;
    }); 
}
var chalk = require('chalk');
var async = require("async");
const sqlite3 = require('sqlite3').verbose();
let db = new sqlite3.Database('db/upstox.db', (err) => {
if (err) {
    return console.error(err.message);
}
console.log(chalk.green('Connected to the in-memory SQlite database.'));
});

function closeDb(){
    db.close();
}

function insertDB(query,param){
    return new Promise(function(resolve, reject) {
        db.run(query, param,function(err){
            if(err)
                console.log(chalk.red("Insert error > " + err));
            else{
                console.log(chalk.blue("Successfully inserted"));
                resolve("success");
            }               
        });
    })        
}

async function getFirst(query,params){
    return new Promise(function(resolve, reject) {
        db.get(query, params, function(err, row){  
        if(err) reject("Read error: " + err.message);
        else {
            resolve(row);
        }
        })    
    })    
}

function getStockDataFromDb(symbol,interval)
{
    return new Promise((resolve, reject)=>{
        var symbolfile;
        try{      
            symbolfile = path.resolve(path.join(__dirname, '..', 'db/stock/'+symbol+'.json'));
        }
        catch(e){
            console.log("getStockDataFromDb > Error > " + e);
            reject(e);
            e = null;
        }
        var lokiJson = new loki(symbolfile, 
        {
            autoload: true,
            autoloadCallback : onLoaded,
            autosave: true, 
            autosaveInterval: 4000
        }); 
        
        function onLoaded() {
            var database = lokiJson.getCollection(interval);
                   
            try{
                if(database != null && database.get(1) && database.get(1).data)
                    resolve({"symbol":symbol,data:JSON.stringify(database.get(1).data)});
                else
                    resolve({"symbol":symbol,data:[]}); 

                //console.log("\n\n > " + JSON.stringify(database.get(1).data));

                lokiJson.close();    
            }
            catch(e){
                console.log("getStockDataFromDb > Error > " + interval +"::"+e);
                lokiJson.close();
                reject(e);
                e = null;
            }   
        } 
    }); 
}

var queue = async.queue(function(task, callback) {
    var allIntervalsArr = ['15MINUTE','5MINUTE','60MINUTE','30MINUTE','10MINUTE','3MINUTE'];

    if(task.symbol){
        var symbolfile;
        try{      
            symbolfile = path.resolve(path.join(__dirname, '..', 'db/stock/'+task.symbol+'.json'));
        }
        catch(e){
            console.log("symbolfile Error > " + e);
        }

        var lokiJson = new loki(symbolfile, 
        {
            autoload: true,
            autoloadCallback : loadHandler,
            autosave: true, 
            autosaveInterval: 10000
        }); 
        
        function loadHandler() {
            var database = lokiJson.getCollection(task.interval);
            if(!database){
                database = lokiJson.addCollection(task.interval);//,{unique: ['timestamp']}
            }  
            var stockData = [];

            if(task.ex == null || task.ex == undefined || task.ex == '')
                task.ex = "NSE_EQ";
            
            loadSymbol(task.symbol,task.ex,task.interval,task.start_date,task.end_date).then(function (response) {
                try {
                    if(response != '' && response != undefined && response != null){
                        stockData = response;
                        //console.log('response  >>> ' + task.symbol +" :: " + task.interval+"> "+stockData.data.length);
                        if(response && response.error){
                            // database.clear();
                            lokiJson.close(); 
                            console.log('Queue error ' + task.symbol +" :: "+task.ex +" :: "+JSON.stringify(response.error));
                        }
                        else if(database != null && database.get(1) && database.get(1).data && database.get(1).data.timestamp && database.get(1).data.timestamp == response.timestamp){
                            console.log('Skip ! Do nothing   ' +task.interval+"> "+ task.symbol);
                        }
                        else if(database != null) {
                            //console.log('UPDATE   ' +task.interval+"> "+ task.symbol +" :: "+ database);
                            database.clear();
                            database.insert(stockData);  
                            lokiJson.saveDatabase();       

                            if(task.interval == "1MINUTE"){
                                var intervalNo = parseInt(task.interval);
                                allIntervalsArr.map(async (allIntervalsArrObj) =>  {
                                    await updateCollection(lokiJson,allIntervalsArrObj,stockData.data)
                                }); 
                                //console.log('UPDATE   ' +task.interval+"> "+ task.symbol);
                            }
                        }
                        else{
                            lokiJson.close();    
                        }
                        lokiJson.saveDatabase();   
                        lokiJson.close(); 
                        callback();         
                    } 
                    else{
                        lokiJson.close();    
                        callback();     
                    }
                    
                    symbolfile = task = stockData = response = null;

                } catch (err) {
                    lokiJson.close();    
                    console.log("loadHandler queue : err   > " + err);
                    symbolfile = task = err = null;
                }
            });
        }  
    } 
},200);

function updateCollection(lokiJson,interval,stockData)
{
    return new Promise(function(resolve, reject) {
            var intervalNo = parseInt(interval);
       
            var database = lokiJson.getCollection(interval);
            try{
                if(database && database.get(1) && database.get(1).data && database.get(1).data.timestamp && database.get(1).data.timestamp === response.timestamp){
                    console.log('Do nothing   ' +interval);
                }
                else if(database && database.get(1) && database.get(1).data){
                    var symbolObj= {};
                    var count = 0;
                    for(var i = 0; i < stockData.length;i++)
                    {
                        var t = database.get(1).data[database.get(1).data.length - 1].timestamp;
                        if(stockData[i].timestamp > t)
                        {
                            if(count % intervalNo == 0){
                                symbolObj = stockData[i];
                                database.get(1).data.push(stockData[i]);
                                count = 0;
                               // console.log('edit  ' +count +" : "+ stockData.length +" : "+ i+" : "+interval +" : "+ intervalNo  +" : "+  stockData[i].timestamp  +" : "+new Date(Number(stockData[i].timestamp)));
                            }
                            database.get(1).data[database.get(1).data.length - 1].low = Math.min((stockData[i] && stockData[i].low) ? stockData[i].low : 0,symbolObj.low);
                            database.get(1).data[database.get(1).data.length - 1].close = Number(stockData[i].close);
                            database.get(1).data[database.get(1).data.length - 1].timestamp = Number(stockData[i].timestamp);
                            database.get(1).data[database.get(1).data.length - 1].high = Math.max((stockData[i] && stockData[i].high) ? stockData[i].high : 0,symbolObj.high);
                            count++;
                        }
                    }
            }
            resolve(1); 
            }
            catch(e){
                reject(e);
                e = null;
            } 
     });
}
// assign a callback
queue.drain = function() {
   // console.log('all items have been processed');
};


  var nifty = require('../db/list/nifty.json').list.sort();
  var fno = require('../db/list//fno.json').list.sort();
  var nse = require('../db/list/nse.json').list.sort();
  watchList =  fno;
  
'use strict';
const nodemailer = require('nodemailer');

var transporter1 = nodemailer.createTransport({
service: 'gmail',
auth: {
    user: 'satish.patel41@gmail.com',
    pass: 'Pratiksha@123'
}
});

// setup email data with unicode symbols
let mailOptions = {
    from: '"Admin" <satish.patel41@gmail.com>', // sender address
    to: 'satish.patel41@yahoo.com', // list of receivers
    subject: 'Alert : Call Generated', // Subject line
    text: 'Alert for', // plain text body
    html: '<p><b>Hello</b> Alert triggered on Wed Nov 7, 6:00 pm</p>' +
        '<p>Here\'s a nyan cat for you as an embedded attachment:<br/><img src="cid:nyan@example.com"/></p>',

    list: {
        // List-Help: <mailto:admin@example.com?subject=help>
        help: 'admin@example.com?subject=help',
        // List-Unsubscribe: <http://example.com> (Comment)
        unsubscribe: [
            {
                url: 'http://example.com/unsubscribe',
                comment: 'A short note about this url'
            },
            'unsubscribe@example.com'
        ],
        // List-ID: "comment" <example.com>
        id: {
            url: 'mylist.example.com',
            comment: 'This is my awesome list'
        }
    }
};


var transporter = nodemailer.createTransport({
    host: 'smtp.ethereal.email',
    port: 587,
    auth: {
        user: 'tito25@ethereal.email',
        pass: 'cXqDHqccV9T7VMqhzs'
    }
});

function sendingMail(toEmail, strategy, symbolsList){
    console.log("sendingMail> " + toEmail +" : "+ strategy +" :: "+symbolsList);
    var list = "<ul>";
    symbolsList.map(symbol =>
    {
        list+="<li>"+symbol+"</li>";
    });
    list+="</ul>";
   
    var india = moment.tz(new Date(), "Asia/Kolkata");
    india.format(); 
    var now = india.date() +"/"+(india.month() + 1) +"/"+india.year()+" "+india.hour()+":"+india.minute();//new Date(row.timestamp);
    

    mailOptions.subject = 'Scan alert ' + strategy, // Subject line
    mailOptions.to = toEmail;
    mailOptions.html =  "<h1>Alert triggered on " +now+"</h1><br><p>Below is the list of new stocks filtered through scan <u>" +strategy+"</u></p><br><p><b>" + list+"</b></p>";
    
    // send mail with defined transport object

    if(symbolsList.length > 1){
        transporter.sendMail(mailOptions, (error, info) => {
            if (error) {
                return console.log(error);
            }
            console.log('Message sent: %s', info.messageId);
            //console.log('Preview URL: %s', nodemailer.getTestMessageUrl(info));
        });
    }
}
/* 
"use strict";
const nodemailer = require("nodemailer");

// async..await is not allowed in global scope, must use a wrapper

async  function sendingMail(toEmail, strategy, symbolsList){

  // Generate test SMTP service account from ethereal.email
  // Only needed if you don't have a real mail account for testing
  let account = await nodemailer.createTestAccount();

  // create reusable transporter object using the default SMTP transport
  let transporter = nodemailer.createTransport({
    host: "smtp.ethereal.email",
    port: 587,
    secure: false, // true for 465, false for other ports
    auth: {
      user: account.user, // generated ethereal user
      pass: account.pass // generated ethereal password
    }
  });
  //console.log('nodemailer user  : ' +  account.user +" \n "+ account.pass);

  // setup email data with unicode symbols
  let mailOptions = {
    from: '"Fred Foo ðŸ‘»" <foo@example.com>', // sender address
    to: "bar@example.com, baz@example.com", // list of receivers
    subject: "Hello âœ”", // Subject line
    text: "Hello world?", // plain text body
    html: "<b>Hello world?</b>" // html body
  };

  var list = "<ul>";
  symbolsList.map(symbol =>
  {
      list+="<li>"+symbol+"</li>";
  });
  list+="</ul>";
 
  var india = moment.tz(new Date(), "Asia/Kolkata");
  india.format(); 
  var now = india.date() +"/"+(india.month() + 1) +"/"+india.year()+" "+india.hour()+":"+india.minute();//new Date(row.timestamp);
  

  mailOptions.subject = 'Scan alert ' + strategy, // Subject line
  mailOptions.to = toEmail;
  mailOptions.html =  "<h1>Alert triggered on " +now+"</h1><br><p>Below is the list of new stocks filtered through scan <u>" +strategy+"</u></p><br><p><b>" + list+"</b></p>";
 

  // send mail with defined transport object
  let info = await transporter.sendMail(mailOptions)

  //console.log("Message sent: %s", info.messageId);
  // Preview only available when sending through an Ethereal account
  console.log("Preview URL: %s", nodemailer.getTestMessageUrl(info));

  // Message sent: <b658f8ca-6296-ccf4-8306-87d57a0b4321@example.com>
  // Preview URL: https://ethereal.email/message/WaQKMgKddxQDoou...
}

 */
var cron = require('node-cron');
var chalk = require('chalk');
var list;
var moment = require('moment-timezone');
var ping = require('ping');
var hosts = ['robo-trader.herokuapp.com', 'https://robo-trader.herokuapp.com/'];

var now = new Date();
var india = moment.tz(now, 'DD-MM-YYYY HH:mm',"Asia/Kolkata");
india.format(); 
            
var end_date = formatDate(india.date())+"-"+formatDate(india.month() + 1)+"-"+india.year();
now.setDate(now.getDate() - 21);
india = moment.tz(now, 'DD-MM-YYYY HH:mm',"Asia/Kolkata");
india.format(); 
var start_date = formatDate(india.date())+"-"+formatDate(india.month() + 1)+"-"+india.year();

cron.schedule('*/1 * * * *', () => {
    load1minData();
    console.log(chalk.blue('running a task every 1 minutes ' + new Date()));
}, {
scheduled: true,
timezone: "Asia/Kolkata"
});

cron.schedule('*/3 * * * *', () => {
    load3minData();
    console.log(chalk.blue('running a task every 3 minutes ' + new Date()));
}, {
scheduled: true,
timezone: "Asia/Kolkata"
});

cron.schedule('*/5 * * * *', () => {
    load5minData();
    console.log(chalk.blue('running a task every 5 minutes ' + new Date()));
}, {
scheduled: true,
timezone: "Asia/Kolkata"
});

cron.schedule('*/10 * * * *', () => {
    load10minData();
    console.log(chalk.blue('running a task every 10 minutes ' + new Date()));
}, {
scheduled: true,
timezone: "Asia/Kolkata"
});

cron.schedule('*/16 * * * *', () => {
    load15minData();
    console.log(chalk.blue('running a task every 15 minutes ' + new Date()));
}, {
scheduled: true,
timezone: "Asia/Kolkata"
});


cron.schedule('*/45 * * * *', () => {
    hosts.forEach(function (host) {
        ping.promise.probe(host)
            .then(function (res) {
                console.log(res);
            });
    });

     console.log(chalk.blue('Ping --- every 45 minutes' + new Date()));
 }, {
 scheduled: true,
 timezone: "Asia/Kolkata"
 });


cron.schedule('*/30 * * * *', () => {
   load30minData();
    console.log(chalk.blue('running a task every 30 minutes' + new Date()));
}, {
scheduled: true,
timezone: "Asia/Kolkata"
});

cron.schedule('0 */1 * * *', () => {
    load60minData();
    console.log(chalk.blue('running a task every 1 hour' + new Date()));
}, {
scheduled: true,
timezone: "Asia/Kolkata"
});

cron.schedule('59 23 * * *', () => {
    //store.unlink();
    //store.set('accessToken', ''); 
    //console.log(chalk.yellow('Clean cache data'));
}, {
scheduled: true,
timezone: "Asia/Kolkata"
});


// At 9:30
cron.schedule('30 9 * * *', () => {
    console.log('Good morning : 9:30 call');
    interval = '15MINUTE';

    Promise.all(open_low_high_List.map(async(strategy) =>{
        applyStrategy(watchList,interval,strategy); 
    })).then(function(result) {
        open_band_List.map(async(strategy) =>{
            applyStrategy(watchList,interval,strategy); 
        });
        console.log('9:30 call result : ' + result);        
    })
}, {
scheduled: true,
timezone: "Asia/Kolkata"
});

cron.schedule('0 18 * * *', () => {
    load1dayData();
    console.log(chalk.blue('running a task every 1 day'));
}, {
scheduled: true,
timezone: "Asia/Kolkata"
});

cron.schedule('0 19 * * *', () => {
    load1WeekData();
    console.log(chalk.blue('running a task every 1 day'));
}, {
scheduled: true,
timezone: "Asia/Kolkata"
});

function load1WeekData()
{
    interval = '1WEEK';
    if(accessToken)
    syncLiveAllStockData(watchList,interval,start_date,end_date);  
}

function load1dayData()
{
    interval = '1DAY';
    if(accessToken)
    syncLiveAllStockData(watchList,interval,start_date,end_date);  
}


function load60minData()
{
    //queue.empty();
    now = new Date();
    now.setDate(now.getDate() - 2);
    india = moment.tz(now, 'DD-MM-YYYY HH:mm',"Asia/Kolkata");
    india.format(); 
    start_date = formatDate(india.date())+"-"+formatDate(india.month() + 1)+"-"+india.year();

    interval = '60MINUTE';
    if(accessToken)
    syncLiveAllStockData(watchList,interval,start_date,end_date); 
}

function load30minData()
{ 
    //queue.empty();
    now = new Date();
    now.setDate(now.getDate() - 2);
    india = moment.tz(now, 'DD-MM-YYYY HH:mm',"Asia/Kolkata");
    india.format(); 
    start_date = formatDate(india.date())+"-"+formatDate(india.month() + 1)+"-"+india.year();

    interval = '30MINUTE';
    if(accessToken)
    syncLiveAllStockData(watchList,interval,start_date,end_date);   
}

function load10minData()
{
    //queue.empty();
    interval = '10MINUTE';   
    now = new Date();
    now.setDate(now.getDate() - 2);
    india = moment.tz(now, 'DD-MM-YYYY HH:mm',"Asia/Kolkata");
    india.format(); 
    start_date = formatDate(india.date())+"-"+formatDate(india.month() + 1)+"-"+india.year();//india.date()+"-"+(india.month())+"-"+india.year();
    if(accessToken)
    syncLiveAllStockData(watchList,interval,start_date,end_date);   
}

function load5minData()
{
    interval = '5MINUTE';
    //queue.empty();
    now = new Date();
    now.setDate(now.getDate() - 1);
    india = moment.tz(now, 'DD-MM-YYYY HH:mm',"Asia/Kolkata");
    india.format(); 
    start_date = formatDate(india.date())+"-"+formatDate(india.month() + 1)+"-"+india.year();//india.date()+"-"+(india.month())+"-"+india.year();

    let promise = new Promise(function(resolve, reject) {
        if(accessToken)
        syncLiveAllStockData(watchList,interval,start_date,end_date);
        resolve(1);    
    }).then(res=>{
        getPercent_list(watchList);
    });
   
}

function load3minData()
{
    interval = '3MINUTE';
    //queue.empty();
    now = new Date();
    now.setDate(now.getDate() - 1);
    india = moment.tz(now, 'DD-MM-YYYY HH:mm',"Asia/Kolkata");
    india.format(); 
    start_date = formatDate(india.date())+"-"+formatDate(india.month() + 1)+"-"+india.year();
    let promise = new Promise(function(resolve, reject) {
        if(accessToken)
        syncLiveAllStockData(watchList,interval,start_date,end_date);
        resolve(1);     
    }).then(res=>{
        return Number(res) + 1;
        getPercent_list(watchList);
    });
}

function load1minData()
{
    interval = '1MINUTE';
    //queue.empty();
    now = new Date();
    now.setDate(now.getDate() - 1);
    india = moment.tz(now, 'DD-MM-YYYY HH:mm',"Asia/Kolkata");
    india.format(); 
    start_date = formatDate(india.date())+"-"+formatDate(india.month() + 1)+"-"+india.year();//india.date()+"-"+(india.month())+"-"+india.year();

    let promise = new Promise(function(resolve, reject) {
        if(accessToken)
             syncLiveAllStockData(watchList,interval,start_date,end_date);
        resolve(1);      
    }).then(res=>{
        return Number(res) + 1;
    });
}

function load15minData()
{   
    interval = '15MINUTE';
    //queue.empty();
    now = new Date();
    now.setDate(now.getDate() - 1);
    india = moment.tz(now, 'DD-MM-YYYY HH:mm',"Asia/Kolkata");
    india.format(); 
    start_date = formatDate(india.date())+"-"+formatDate(india.month() + 1)+"-"+india.year();
    let promise = new Promise(function(resolve, reject) {
        if(accessToken)
            syncLiveAllStockData(watchList,interval,start_date,end_date);
        
        setTimeout(function() {
            resolve(1);
        }, 10000);      
    }).then(res=>{
        //console.log("load15minData - Process p  " + res);
        return Number(res) + 1;
    });

    promise.then(function(result)  {
        strategyList.map(strategy =>{
            applyStrategy(watchList,'15MINUTE',strategy); 
        });
       // console.log("load15minData " + result);
        return Number(result) + 1;
    });

    promise.then(function(result)  {
        getPercent_list(watchList);
       // console.log("load15minData  " + result);
    });
}
var express = require('express');

var compression = require('compression')
var moment = require('moment-timezone');
var bodyParser = require('body-parser');
var chalk = require('chalk');
var fs = require('fs');
var url = require('url');
var cluster = require('cluster');
var session = require('express-session');
var FileStore = require('session-file-store')(session);
var Store = require('data-store');
var async = require('async');
const querystring = require('querystring');
var store = new Store({ path: 'config.json' });
var Upstox = require("upstox");
var api = "OknufM07tm1g9EfN4fHKP2Eqi9DSw40I2Y3xliHg";
var upstox = new Upstox(api);
const PORT = process.env.PORT || 3000;
var redirect_uri = "http://localhost:"+PORT;

if(process.env.NODE_ENV=="production")
{
    api = "OknufM07tm1g9EfN4fHKP2Eqi9DSw40I2Y3xliHg";
    redirect_uri = "https://robo-trader.herokuapp.com/";
}



var numReqs = 0; 
if (cluster.isMaster) {
  // Fork workers.
  let cpus = 1;//require('os').cpus().length;
  console.log(chalk.green("cpus "  +cpus));
  for (var i = 0; i < cpus; i++) {
    var worker = cluster.fork();
 
    worker.on('message', function(msg) {
     /*  if (msg.cmd && msg.cmd == 'notifyRequest') {
        numReqs++;
      } */
    });
  }
 
  cluster.on('death', function(worker) {
    console.log(chalk.red('worker ' + worker.pid + ' died'));
  });
} else {
        var app = express();
        app.use(express.static('public'));
        // compress all responses
        app.use(compression());
        app.use(bodyParser.json()); // support json encoded bodies
        app.use(bodyParser.urlencoded({ extended: true })); // support encoded bodies
        app.use(session(
            {
                store: new FileStore({

                    path: './session-store'
            
                }),
                name: '_fs_cookie', // cookie will show up as foo site
                resave: false,
                saveUninitialized: false,
                secret: "00777",
                cookie: {
                    maxAge: 1000 * 60 * 60 * 10//24
                }
            }    
        ));
    
        app.use(function(req, res, next) {
            res.header("Access-Control-Allow-Origin", "*");
            res.header("Access-Control-Allow-Headers", "Origin, X-Requested-With, Content-Type, Accept");
            next();
        });

        var months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        var date = new Date();
        var today = date.getDate() +"-"+(date.getMonth() + 1) +"-"+date.getFullYear();
        var time = date +":"+date.getHours() +":"+date.getMinutes();   
        
       
       // app.use(express.static('views'))
       // app.use('/views', express.static('views'))
        app.get('/', function (req, res) {
            var q = url.parse(req.url, true).query;
            code = q.code;

            console.log("******* code > " + code);
            getAcceToken(code);        
            res.sendFile("index.html", {"root": __dirname});
            //checkBankNiftyExpiry();

            /* if(code)
            {
                getAcceToken(code);        
                res.sendFile("index.html", {"root": __dirname});
            }
            else{
                res.sendFile("index.html", {"root": __dirname});
            } */
            q = null;
    });

    app.get('/welcome', checkSignIn,function (req, res) {
        res.send('<b>Hello</b> welcome to my http server made with express');
    });

    app.get('/login', function (req, res) {
        res.sendFile("login.html", {"root": __dirname});
    });

    app.get('/logout', function(req, res){
         req.session.destroy(function(){
            console.log(chalk.blue("user logged out."));
        });
        res.redirect('/login');
    });

    function checkSignIn(req, res,next){
        if(req.session.user){
            next();     //If session exists, proceed to page
        } else {
            //var err = new Error("Not logged in!");
            console.log(chalk.blue(JSON.stringify(req.session) +" session \n"+  req.session.user));
            res.sendFile("login.html", {"root": __dirname});
        }       
    }

    app.post('/login', function (req, res) {
    var email = req.body.username;
    var psw = req.body.password;

    if(email){
        var query = "select * from User where email=? and password=?";
        var param = [email,psw];
        getFirst(query,param).then(user => {
                console.log("result > " + JSON.stringify(user));
                if(user == undefined)
                {
                    res.send("error")
                }
                else{
                   // console.log(chalk.green("Login token > " + store.get('accessToken')));
                    /* if(store.get('accessToken') && store.get('accessToken') != '')
                    { */
                        req.session.user = user;
                        res.send(user);
                   /*  }
                    else{
                        var loginUrl = upstox.getLoginUri(redirect_uri);
                        res.status(200).header('Content-type', 'text/html');
                        //code = req.params.code;
                        //res.status(302).setHeader('Location', loginUrl);
                        //res.end();
                    } */
                }
            });     
    }
    else
        res.sendFile("login.html", {"root": __dirname});
    });

    app.get('/signup', function (req, res) {
        res.sendFile("signup.html", {"root": __dirname});
    });

    app.get('/gainerLoser', function (req, res) {
        res.sendFile("gainerloser.html", {"root": __dirname});
    });

   // app.get('/api/gainerLoser', function (req, res) {

           
    app.get('/api/gainerLoser/:exchange', checkSignIn,function (req, res) { 
        var exchange = req.params.exchange;  
        var list = [];
        if(exchange == "nifty")
            list =  nifty;
        else if(exchange == "fno")
            list = fno;
        else
            list = nse; 
           
        var response = store.get('percentage').filter(isMatching);
        function isMatching(sItem) {
            var isMatch = false;
            for (var i = 0; i < list.length; i++) {
               
                if(list[i] == sItem.symbol){
                    isMatch = true;
                    break;
                }
            }
            return isMatch;
        }
       
        res.send(response);
        response =list= exchange = null;
        res.end();
    });

    app.post('/signup', function (req, res) {
        var email = req.body.email;
        var psw = req.body.psw;
        var mobile = req.body.mobile;
        var name = req.body.name;
        var pswRepeat = req.body.pswRepeat;

        if(email)
        {
            var query = "select * from User where email=?";
            var param = [email];
            var isMatchEmail = false;
            getFirst(query,param).then(user => {
                    console.log("result > " + JSON.stringify(user));
                    if(user == undefined)
                    {
                        //Do nothing
                    }
                    else{
                        res.send("error");
                        isMatchEmail = true;
                    }
                });

                var query = "INSERT INTO User (name,mobile,email,password)VALUES(?,?,?,?)";
                var param = [name,mobile,email,psw];
                console.log(query +"> "+ param);
                
                if(!isMatchEmail){  
                    insertDB(query,param).then(responses => {
                        console.log("result > " + JSON.stringify(responses));

                        if(responses == 'success')
                        {
                            res.send('success');
                        }
                        else{
                            res.send("error");
                        }
                    });
            }    
            //res.send('<b>username </b>  : ' + email +" > "+ mobile+" > "+ name+" > "+ psw);
        }
        else
            res.sendFile("signup.html", {"root": __dirname});
    });

    app.get('/contactus', checkSignIn,function (req, res) {
        res.sendFile("contactus.html", {"root": __dirname});
    });

    app.get('/index', checkSignIn,function (req, res) {
        res.sendFile("index.html", {"root": __dirname});
    });

    app.get('/chart', checkSignIn,function (req, res) {
         res.sendFile("chart.html", {"root": __dirname});      
    });

    app.get('/scan', checkSignIn,function (req, res) {
        res.sendFile("scanner.html", {"root": __dirname});
    });

    app.get('/strategy', checkSignIn,function (req, res) {
        res.sendFile("strategy.html", {"root": __dirname});
    });

    app.get('/gainerloser', checkSignIn,function (req, res) {
        res.sendFile("gainerloser.html", {"root": __dirname});
    });

    var  lastObject = {open:'',close:'',low:'',high:'',volume:'',timestamp:'',rsi:'',sma:'',bb:{upper:'',lower:'',isCrossed:'',middel:'',pb:''}};
    var stockData = [];

    app.post('/createStrategy',checkSignIn, function (req, res) {
        var strategyObj = JSON.parse(req.body.data);

        var uid = strategyObj.uid;
        var name = strategyObj.name;
        var symbol= strategyObj.symbol;
        var exchange = strategyObj.exchange;
        var orderType = strategyObj.orderType;
        var symbolToBuySell  = strategyObj.symbolToBuySell;
        var interval = strategyObj.interval;
        
        var query = "INSERT INTO Strategy (uid,name,symbol,exchange,orderType,symbolToBuySell,interval)VALUES(?,?,?,?,?,?,?)";
        var param = [uid,name,symbol,exchange,orderType,symbolToBuySell,interval];
        
        insertDB(query,param).then(responses => {
          
            if(responses == 'success')
            {
                var query1 = "select sid from Strategy where uid=?";
                var param1 = [uid];

                getFirst(query1,param1).then(obj => {
                    //console.log("result > " + obj.sid);
                    if(obj.sid == undefined)
                    {
                        res.send("error")
                    }
                    else{
                        console.log(obj.sid);
                         var sid = obj.sid;
                        strategyObj.indicators.map(async (obj) => {

                            var indicator= obj.indicator;
                            var settings = obj.settings;
                            var value = obj.value;
                            var op = obj.op;
                            
                            var q = "INSERT INTO Indicators (sid,indicator,settings,value,op)VALUES(?,?,?,?,?)";
                            var p = [sid,indicator,settings,value,op];
                            //console.log(q +"> "+ JSON.stringify(p));

                            insertDB(q,p).then(responses => {
                                console.log("result > " + JSON.stringify(responses));
                            }); 
                        });

                        res.send('success');
                       
                    }
                });  
            }
            else{
                res.send("error");
            }
        });

        var now = new Date();
        if(interval == "5MINUTE") 
                now.setDate(now.getDate() - 2);
        else if(interval == "3MINUTE")
            now.setDate(now.getDate() - 1);
        else if(interval == "15MINUTE")
             now.setDate(now.getDate() - 2);
        else if(interval == "10MINUTE")
                now.setDate(now.getDate() - 3);
        else if(interval == "30MINUTE")
            now.setDate(now.getDate() - 4);
        else if(interval == "60MINUTE")
            now.setDate(now.getDate() - 4);
        else if(interval == "1DAY")
            now.setDate(now.getDate() - 20);
        else if(interval == "1WEEK")
            now.setDate(now.getDate() - 7*20);
        else if(interval == "1MONTH")
            now.setMonth(now.getMonth() - 20);   
        
        var start_date = now.getDate()+"-"+(now.getMonth() + 1)+"-"+now.getFullYear();

        initiateIndicator();
        stockData = [];
        loadSymbol(strategyObj.symbol,strategyObj.exchange,interval,start_date).then(function (response) {
            res.setHeader('Content-Type', 'application/json');
            stockData =response.data;
            
            lastObject = {open:'',close:'',low:'',high:'',volume:'',timestamp:'',rsi:'',sma:'',bb:{upper:'',lower:'',isCrossed:'',middel:'',pb:''}};
            stockData.map(row => {
                var india = moment.tz(new Date(Number(row.timestamp)), "Asia/Kolkata");
                india.format(); 
                row.timestamp = india.date() +"/"+(india.month()+1) +"/"+india.year()+" "+india.hour()+":"+india.minute();//new Date(row.timestamp);
                row.rsi = rsi.nextValue(Number(row.close));
                row.sma = sma.nextValue(Number(row.close));
                row.bb = bb.nextValue(Number(row.close)); 
                
                lastObject = row;
                return row;
            });
            stockData.reverse();
            var data = {
                "symbol":strategyObj.symbol,
                "close":stockData[0].close,
                "volume":stockData[0].volume,
                "rsi":stockData[0].rsi,
                "timestamp":stockData[0].timestamp,
                "sma":stockData[0].sma, 
                "bb":stockData[0].bb
            }; 

            var isMatch = false;
            
            for(var i=0;i<strategyObj.indicators.length;i++)
            {
                var op = strategyObj.indicators[i]['op'];
                var a = data[strategyObj.indicators[i]['indicator']];
                var b = strategyObj.indicators[i]['value'];
                var result = false;
                if(op == '<')
                    result = (a < b);
                else if(op == '>')
                    result = (a > b);   
                else if(op == '<=')
                    result = (a <= b);
                else if(op == '>=')
                    result = (a >= b);    
                    else if(op == '==')
                    result = (a == b);        
                
                if(result)
                {
                    isMatch = true;
                }
                console.log("isMatch :> " + isMatch);
            }
            
            if(isMatch){
                    var orderObject = {
                        transaction_type:strategyObj.orderType,
                        exchange:strategyObj.exchange,
                        symbol: strategyObj.symbolToBuySell,
                        quantity: 1,
                        order_type:"m"
                    };
                
                    upstox.placeOrder(orderObject).then(function(response) {
                        // Order details received
                        console.log(response);
                    })
                    .catch(function(err) {
                        // Something went wrong.
                        console.log(chalk.red(err));
                        err = null;
                    });
            } 

            console.log("Result " + JSON.stringify(data));
            res.send(JSON.stringify(data));
            stockData = null;
            res.end();
        })
        .catch(function(error){
            console.log("createStrategy error > " +  JSON.stringify(error));
            error = null;
        });

    });

    app.get('/loadSymbol/:symbol/:interval',checkSignIn, function (req, res) { 
        console.log('params: ' + JSON.stringify(req.params));
     
        var symbol = req.params.symbol;  
        var interval = req.params.interval; 

        var now = new Date();
        if(interval == "5MINUTE") // 1WEEK, 1MONTH
            now.setMinutes(now.getMinutes() - 5* 20);
        else if(interval == "3MINUTE")
            now.setMinutes(now.getMinutes() - 3 * 20);
        else if(interval == "10MINUTE")
            now.setMinutes(now.getMinutes() - 10 * 20);
        else if(interval == "15MINUTE")
            now.setMinutes(now.getMinutes() - 15 * 20);    
        else if(interval == "30MINUTE")
            now.setMinutes(now.getMinutes() - 30* 20);
        else if(interval == "60MINUTE")
            now.setMinutes(now.getMinutes() - 60* 20);
        else if(interval == "1DAY")
            now.setDate(now.getDate() - 20);
        else if(interval == "1WEEK")
            now.setDate(now.getDate() - 7*20);
        else if(interval == "1MONTH")
            now.setMonth(now.getMonth() - 20);  
        else 
            now.setDate(now.getDate() - 20);  

        var start_date = now.getDate()+"-"+(now.getMonth() + 1)+"-"+now.getFullYear();
        console.log("start_date > " + interval +" >> "+start_date);
        
       

        stockData = [];
        loadSymbol(symbol,"NSE_EQ",interval,start_date).then(function (response) {

            var inputRSI = {
                values : [],
                period : 14
            };
            var rsi = new technicalindicators.RSI(inputRSI);
            var inputSMA = {
                values : [],
                period : 20
            };
            //console.log("rsi");
            var sma= new technicalindicators.SMA(inputSMA);
    
            var inputBB = {
                period : 14, 
                values : [],
                stdDev : 2 
            }
            //console.log("sma");
            var bb = new technicalindicators.BollingerBands(inputBB);
            inputBB = inputRSI = inputSMA = null;

            res.setHeader('Content-Type', 'application/json');
            stockData =response.data;
            //console.log("loadSymbol stockData : " + response);
            lastObject = {open:'',close:'',low:'',high:'',volume:'',timestamp:'',rsi:'',sma:'',bb:{upper:'',lower:'',isCrossed:'',middel:'',pb:''}};
            stockData.map(row => {
                var india = moment.tz(new Date(Number(row.timestamp)), "Asia/Kolkata");
                india.format(); 
               // row.timestamp = india.date() +"/"+(india.month()+1) +"/"+india.year()+" "+india.hour()+":"+india.minute();//new Date(row.timestamp);
                row.rsi = rsi.nextValue(Number(row.close));
                row.sma = sma.nextValue(Number(row.close));
                row.bb = bb.nextValue(Number(row.close)); 
                if(row && row.bb && Number(row.close) >= Number(row.bb.upper))// && Number(lastObject.close) < Number(lastObject.bb.upper))
                {
                    row.bb.isCrossed = 'Crossed Above';
                }
                else if(row && row.bb && Number(row.close) <= Number(row.bb.lower))// && Number(lastObject.close) > Number(lastObject.bb.lower))
                {
                    row.bb.isCrossed = 'Crossed Below';
                }
                
                lastObject = row;
                return row;
            });
            stockData.reverse();
            res.send(JSON.stringify(stockData));
            stockData = null;
            res.end();
        })
        .catch(function(error){
            if(error.code == 401){
               // accessToken = '';
               // store.set('accessToken', accessToken); 

                var loginUrl = upstox.getLoginUri(redirect_uri);
                res.status(200).header('Content-type', 'text/html');
                code = req.params.code;
                res.status(302).setHeader('Location', loginUrl);
                res.end();
                error = loginUrl = null;
            }
            console.log("/loadSymbol/:symbol/:interval error > " +  JSON.stringify(error));
        });

    });

    function initiateIndicator()
    {
        //console.log("initiateIndicator");
        var inputRSI = {
            values : [],
            period : 14
        };
        rsi = new technicalindicators.RSI(inputRSI);
        var inputSMA = {
            values : [],
            period : 20
        };
        //console.log("rsi");
        sma= new technicalindicators.SMA(inputSMA);

        var inputBB = {
            period : 14, 
            values : [],
            stdDev : 2 
        }
        //console.log("sma");
        bb = new technicalindicators.BollingerBands(inputBB);
        inputBB = inputRSI = inputSMA = null;
    }

    app.get('/getFutureContract/:exchange', checkSignIn,function (req, res) { 
    var exchange = req.params.exchange;  

    //console.log("getMaster exchange > " +  JSON.stringify(exchange));

    fs.readFile('data/index/nse_fo.txt','utf8', function(err, response) {
        
        var obj = JSON.parse(response);
       /*  var now = new Date();
        var thisMonth = months[now.getMonth()].slice(0,3).toUpase();
        var monthPattern = new RegExp(thisMonth, 'gi'); */
            
        var data=csvTojs(obj.data);
        //console.log(data);
        var data = data.filter(x => (String(x.instrument_type) === exchange));
        
        //console.log(data);
        var arr = data.map(x => x.symbol);
        //console.log(arr);

        //console.log(arr);
        res.setHeader('Content-Type', 'application/json');
        res.send(arr);
        res.end();
    });


    /* getMaster(exchange).then(function (response) {

        console.log("getMaster respone > " +  JSON.stringify(response));


        var data = response.filter(function (el) {
            return (el != null && el.close != null && el.close != undefined && el.close != "");
        });

        res.setHeader('Content-Type', 'application/json');
        res.send(JSON.stringify(response));
        exchange =  data = null;
        res.end();
    })
    .catch(function(error){
        log("getMaster/ error > " +  JSON.stringify(error));
    }); */

    });
    
    app.get('/getStockIndicators/:symbol/:interval', checkSignIn,function (req, res) { 
        var symbol = req.params.symbol;  
        var interval = req.params.interval;  
        
        new Promise(function(resolved, rejected) {
            var data = getStockDataFromDb(symbol,interval);    
            resolved(data); 
        }).then(stockData => {
            var inputRSI = {
                values : [],
                period : 14
            };
            rsi = new technicalindicators.RSI(inputRSI);
            var inputSMA = {
                values : [],
                period : 20
            };    
            sma= new technicalindicators.SMA(inputSMA);
            
            var inputBB = {
                period : 14, 
                values : [],
                stdDev : 2 
            }
         
            bb = new technicalindicators.BollingerBands(inputBB);
            inputBB = inputRSI = inputSMA = null;
            var data = [];
            try{
                data = JSON.parse(stockData.data); 
                data.map(row => {
                    row.rsi = rsi.nextValue(Number(row.close));
                    row.sma = sma.nextValue(Number(row.close));
                    row.bb = bb.nextValue(Number(row.close));                
                    
                    return row;
                });
                data.reverse();          
                res.setHeader('Content-Type', 'application/json');
            }
            catch(e){
                console.log(e);
            }
            res.send(JSON.stringify(data));
            exchange = list = interval =  null;
            res.end();                    
            
        })
        .catch();

    });
    
    app.get('/getDefaultIndicators/:interval/:exchange', checkSignIn,function (req, res) { 
        var interval = req.params.interval;  
        var exchange = req.params.exchange;  

        var list = [];
        if(exchange == "nifty")
            list =  nifty;
        else if(exchange == "fno")
            list = fno;
        else
            list = nse; 


        Promise.all(list.map(async (x) =>  {
            var symbol = x.symbol ? x.symbol:x;    
            return getStockDataFromDb(symbol,interval);          
            })).then(stockData => {
               

                var arr = stockData.map(async (dataObj) =>  {
                    try{
                        var data = JSON.parse(dataObj.data); 

                        var inputRSI = {
                            values : [],
                            period : 14
                        };
                        rsi = new technicalindicators.RSI(inputRSI);
                        var inputSMA = {
                            values : [],
                            period : 20
                        };
                        //console.log("rsi");
                        sma= new technicalindicators.SMA(inputSMA);
                
                        var inputBB = {
                            period : 14, 
                            values : [],
                            stdDev : 2 
                        }
                        //console.log("sma");
                        bb = new technicalindicators.BollingerBands(inputBB);
                        inputBB = inputRSI = inputSMA = null;

                        data.map(row => {
                            var india = moment.tz(new Date(Number(row.timestamp)), "Asia/Kolkata");
                            india.format(); 
                            row.timestamp = india.date() +"/"+(india.month()+1) +"/"+india.year()+" "+india.hour()+":"+india.minute();//new Date(row.timestamp);
                            row.rsi = rsi.nextValue(Number(row.close));
                            row.sma = sma.nextValue(Number(row.close));
                            row.bb = bb.nextValue(Number(row.close)); 
                            
                            lastObject = row;
                            return row;
                        });
                        data.reverse();
                        var resonseData = {
                            "symbol":dataObj.symbol,
                            "close":data[0].close,
                            "volume":data[0].volume,
                            "rsi":data[0].rsi,
                            "timestamp":data[0].timestamp,
                            "sma":data[0].sma, 
                            "bb":data[0].bb
                        }; 
                        return resonseData;
                      
                    }
                    catch(e){
                        //console.log("stockData.map Error " + e);
                    }
                });    
                
                Promise.all(arr)
                    .then(resonse=>
                    {
                        res.setHeader('Content-Type', 'application/json');
                        res.send(JSON.stringify(resonse));
                        exchange = list = interval =  null;
                        res.end();
                    })
                    .catch();
            })
            .catch(error => { 
                console.log(error)
            }); 

    });



    var result = [];
    var map = new Map();

    app.get('/loadAllSymbolData/:interval/:exchange', checkSignIn,function (req, res) { 
        console.log('params: ' + JSON.stringify(req.params));
        
        var interval = req.params.interval;  
        var exchange = req.params.exchange;  

        var list = [];
        if(exchange == "nifty")
            list =  nifty;
        else if(exchange == "fno")
            list = fno;
        else{
            list = nse;
        }

        var stockData = [];
        if(interval == "5MINUTE") 
            stockData =store.get('data5');
        else if(interval == "3MINUTE")
            stockData =store.get('data3');
        else if(interval == "10MINUTE")
            stockData =store.get('data10');
        else if(interval == "15MINUTE")
            stockData =store.get('data15');    
        else if(interval == "30MINUTE")
            stockData =store.get('data30');
        else if(interval == "60MINUTE")
            stockData = store.get('data60');
        else if(interval == "1DAY")
            stockData = store.get('data1day');         
        else if(interval == "1WEEK")
            stockData = store.get('data1week');       
        else if(interval == "1MONTH")
            stockData = store.get('data1month');        

        var data = [];
        if(stockData && stockData != undefined && stockData.length > 0)
        {
            stockData.filter(function (el) {
                return (el != null && el.close != null && el.close != undefined && el.close != "");
            });
        }
            
        //console.log('*stockData interval : ' +interval +">"+ stockData.length);
        if(stockData && stockData.length > 0 && stockData[0])
        {
            res.setHeader('Content-Type', 'application/json');
            res.send(JSON.stringify(stockData));
            res.end();
        }
        else{ 
            console.log('*No data available '+ interval+' Fetch it.');
            
            var now = new Date();
            if(interval == "5MINUTE")
                    now.setDate(now.getDate() - 2);
            else if(interval == "3MINUTE")
                    now.setDate(now.getDate() - 2);
            else if(interval == "10MINUTE")
                    now.setDate(now.getDate() - 3); 
            else if(interval == "15MINUTE")
                    now.setDate(now.getDate() - 3);               
            else if(interval == "30MINUTE")
                now.setDate(now.getDate() - 4);
            else if(interval == "60MINUTE")
                now.setDate(now.getDate() - 4);
            else if(interval == "1DAY")
                now.setDate(now.getDate() - 30);
            else if(interval == "1WEEK")
                now.setDate(now.getDate() - 7*20);
            else if(interval == "1MONTH")
                now.setMonth(now.getMonth() - 20);    
            
            var start_date = now.getDate()+"-"+(now.getMonth() + 1)+"-"+now.getFullYear();
                
            //console.log("start_date :: "+interval +"> "+start_date);
            loadAllSymbolData(list,interval,start_date).then(function (response) {
                console.log("\n loadAllSymbolData **"+JSON.stringify(response));
                var data = [];
            
                if(interval == "5MINUTE")
                {
                    store.set('data5', response); 
                }
                else if(interval == "3MINUTE"){
                    store.set('data3', response); 
                }
                else if(interval == "10MINUTE"){
                    store.set('data10', response); 
                }
                else if(interval == "15MINUTE"){
                    store.set('data15', response); 
                }
                else if(interval == "30MINUTE"){
                    store.set('data30', response); 
                }
                else if(interval == "60MINUTE"){
                    store.set('data60', response); 
                }
                else if(interval == "1DAY"){
                    store.set('data1day', response); 
                } 
                else if(interval == "1WEEK"){
                    store.set('data1week', response); 
                } 
                else if(interval == "1MONTH"){
                    store.set('data1month', response); 
                } 
                        
                res.setHeader('Content-Type', 'application/json');
                res.send(JSON.stringify(response));
                exchange = list = interval = data = null;
                res.end();
            })
            .catch(function(error){
                console.log("loadAllSymbolData/ error > " +  JSON.stringify(error));
            });
        }
    });

    app.get('/getListOfAllSymbol', checkSignIn,function (req, res) {   
        res.setHeader('Content-Type', 'application/json');
        
        
        res.send(watchList);
        res.end();
    });

    

    app.get('/getBalance', function (req, res) {   
        res.setHeader('Content-Type', 'application/json');
        res.send(JSON.stringify(balance));
        res.end();
    });

    app.get('/getProfile', function (req, res) {   
        res.setHeader('Content-Type', 'application/json');
        res.send(JSON.stringify(profile));
        res.end();
    });

    app.post('/scan', function (req, res) {

    });

 /*    const requestLogs = [];
    app.get('/heapdump', checkSignIn,function (req, res) {
        heapdump.writeSnapshot((err, filename) => {
            console.log('Heap dump written to', filename)
        });
        requestLogs.push({ url: req.url, date: new Date() });
    res.end(JSON.stringify(requestLogs));
    }); */

    app.get('/admin', checkSignIn,function (req, res) {
        var india = moment.tz(store.get('tokenValidity'),"Asia/Kolkata");
        var d =new Date();
        var now1 = moment.tz(d, 'YYYY-DD-MM HH:mm',"Asia/Kolkata");
        now1.format(); 
        console.log("tokenValidity "  +now1 +":"+india+":"+ india.isBefore(now1));
        if(india.isBefore(now1))
        {
            //accessToken = '';
           // store.set('accessToken',accessToken)
        }

        /* if(store.get('accessToken') && store.get('accessToken') != ''){
             accessToken = store.get('accessToken');
             upstox.setToken(accessToken);
             getListOfAllSymbol();
             res.sendFile("index.html", {"root": __dirname});
        }
        else{ */
            var loginUrl = upstox.getLoginUri(redirect_uri);
            console.log("*loginUri " + loginUrl);
            res.status(200).header('Content-type', 'text/html');
            code = req.params.code;
            res.status(302).setHeader('Location', loginUrl);
            res.end();
        //}
    });

    // Change the 404 message modifing the middlewar
    app.use(function(req, res, next) {
        res.status(404).send("Sorry, that route doesn't exist. Have a nice day :)");
    });

    // start the server in the port 3000 !
    app.listen(PORT, function () {
    console.log('App listening on port '+PORT);
   // console.log(`Heapdump enabled. Run "kill -USR2 ${process.pid}" or send a request to "/heapdump" to generate a heapdump.`);
    });
}

// Listen for dying workers
cluster.on('exit', function (worker) {

    // Replace the dead worker,
    // we're not sentimental
    console.log('Worker %d died :(', worker.id);
    cluster.fork();

});

var strategy_smaCross1 = {
    name:"EMA Cross Over",
    description : "Crossed 13 ema with 50 SMA",
    isLive:false,
    isBuyOrSell:"b",
    strategy : [
    {
        indicators:
        [
            {indicator:'EMA',period : 13,values:"closes"},
            {indicator:'EMA',period : 50,values:"closes"}
        ],output:[],strategy:"output[0][0] >= output[1][0]"
    },
    {
        indicators:
        [
            {indicator:'SMA',period : 20,values:"closes"},
            {indicator:'SMA',period : 50,values:"closes"}
        ],output:[],strategy:"output[0][1] < output[1][1]"
    }
]
}; 

var strategy_sma200 = {
    name:"SMA 200 Cross Over",
    description : "Close above 200 sma",
    isBuyOrSell:"b",
    isLive:false,
    strategy :[
        {
            indicators:
            [
                {indicator:'SMA',period : 200,values:"closes"}
            ],output:[],strategy:"closes[i] >= output[0][i]"
        },
        {
            indicators:
            [
                {indicator:'SMA',period : 200,values:"opens"}
            ],output:[],strategy:"opens[i+1] <= output[0][i]"
        },
        {
            indicators:
            [
                {indicator:''}
            ],output:[],strategy:"closes[i] > opens[i]"
        }
]
}; 

var strategy_rsi60_crossed = {
name:"RSI : 60 Cross Over",
description : "RSI : 60 Cross Over",
isLive:false,
isBuyOrSell:"b",
strategy : [
    {
        indicators:
        [
            {indicator:'RSI',period : 14,values:"closes"}
        ],output:[],strategy:"output[0][i] >= 60"
    }, 
    {
        indicators:
        [
            {indicator:'RSI',period : 14,values:"closes"}
        ],output:[],strategy:"output[0][i+1] < 60"
    },
    {
        indicators:
        [
            {indicator:''}
        ],output:[],strategy:"((closes[0] - opens[0]) / (highs[0] - lows[0])) >= 0.5"
    },
    {
        indicators:
        [
            {indicator:''}
        ],output:[],strategy:"closes[i] > opens[i]"
    }  
]
}; 

var strategy_rsi40_crossed ={
    name:"RSI : 40 Cross Over",
    description : "RSI : 40 Cross Over",
    isBuyOrSell:"s",
    isLive:false,
    strategy : [
    {
        indicators:
        [
            {indicator:'RSI',period : 14,values:"closes"}
        ],output:[],strategy:"output[0][i] <= 40"
    }, 
    {
        indicators:
        [
            {indicator:'RSI',period : 14,values:"closes"}
        ],output:[],strategy:"output[0][i+1] >= 40"
    },
    {
        indicators:
        [
            {indicator:''}
        ],output:[],strategy:"((closes[0] - opens[0]) / (highs[0] - lows[0])) <= -0.5"
    },
    {
        indicators:
        [
            {indicator:''}
        ],output:[],strategy:"closes[i] < opens[i]"
    }  
]
}; 

var strategy_bbLower ={
    name:"Bollinger band : lower band Cross Over",
    description : "Bollinger band : lower band Cross Over",
    isBuyOrSell:"s",
    isLive:false,
    strategy : [
    {
        indicators:
        [
            {indicator:'BB',period : 14,values:"closes",stdDev : 2}
        ],output:[],strategy:"closes[i] <= output[0][i]['lower']"
    },
    {
        indicators:
        [
            {indicator:'BB',period : 14,values:"closes",stdDev : 2}
        ],output:[],strategy:"opens[i] >= output[0][i]['lower']"
    },
    {
        indicators:
        [
            {indicator:''}
        ],output:[],strategy:"closes[i] < opens[i]"
    },
    {
        indicators:
        [
            {indicator:''}
        ],output:[],strategy:"((closes[i] - opens[i]) / (highs[i] - lows[i])) <= -0.5"
    }
]
}; 

var strategy_bbUpper_band_crossed ={
    name:"Bollinger band : Upper band Cross Over",
    description : "Bollinger band : Upper band Cross Over",
    isBuyOrSell:"b",
    isLive:false,
    strategy : [
    {
        indicators:
        [
            {indicator:'BB',period : 14,values:"closes",stdDev : 2}
        ],output:[],strategy:"closes[i] >= output[0][i]['upper']"
    },
    {
        indicators:
        [
            {indicator:'BB',period : 14,values:"closes",stdDev : 2}
        ],output:[],strategy:"opens[i] <= output[0][i]['upper']"
    },
    {
        indicators:
        [
            {indicator:''}
        ],output:[],strategy:"closes[i] > opens[i]"
    },
    {
        indicators:
        [
            {indicator:''}
        ],output:[],strategy:"((closes[i] - opens[i]) / (highs[i] - lows[i])) >= 0.5"
    } 
]
}; 
    
var strategyList = [strategy_rsi60_crossed,strategy_bbUpper_band_crossed,strategy_bbLower];

var open_band_List = [strategy_bbUpper_band_crossed,strategy_bbLower];

/******Strong / week *****/

var strategy_rsi_above_60 = {
name:"RSI > 60 - Strong chart",
description : "RSI > 60 - Strong chart",
isLive:false,
isBuyOrSell:"b",
strategy : [
    {
        indicators:
        [
            {indicator:'RSI',period : 14,values:"closes"}
        ],output:[],strategy:"output[0][i] > 60"
    },
    {
        indicators:
        [
            {indicator:''}
        ],output:[],strategy:"((closes[0] - opens[0]) / (highs[0] - lows[0])) >= 0.5"
    },
    {
        indicators:
        [
            {indicator:''}
        ],output:[],strategy:"closes[i] > opens[i]"
    }  
]
}; 

var strategy_rsi_below_40 = {
name:"RSI < 40 - Weak chart",
description : "RSI < 4 - weak charts",
isLive:false,
isBuyOrSell:"s",
strategy : [
    {
        indicators:
        [
            {indicator:'RSI',period : 14,values:"closes"}
        ],output:[],strategy:"output[0][i] < 40"
    },
    {
        indicators:
        [
            {indicator:''}
        ],output:[],strategy:"((closes[0] - opens[0]) / (highs[0] - lows[0])) <= -0.5"
    },
    {
        indicators:
        [
            {indicator:''}
        ],output:[],strategy:"closes[i] < opens[i]"
    }  
]
}; 

var strategyStrongList = [strategy_rsi_above_60];


var strategyWeakList = [strategy_rsi_below_40];



/******OPEN = HIGH / OPEN = LOW *****/

var open_low = {
    name:"OPEN = LOW",
    description : "OPEN = LOW",
    isLive:false,
    isBuyOrSell:"b",
    strategy : [
        {
            indicators:
            [
                {indicator:''}
            ],output:[],strategy:"open[i] == low[i]"
        }  
    ]
}; 


var open_high = {
    name:"OPEN = HIGH",
    description : "OPEN = HIGH",
    isLive:false,
    isBuyOrSell:"s",
    strategy : [
        {
            indicators:
            [
                {indicator:''}
            ],output:[],strategy:"open[i] == high[i]"
        }  
    ]
}; 

var open_low_high_List = [open_high,open_low];

var technicalindicators = require('technicalindicators');
var fs = require('fs');
var path = require('path');
var moment = require('moment-timezone');

var months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
var date = new Date();
var today = date.getDate() +"-"+(date.getMonth() +  1)+"-"+date.getFullYear();
var time = date +":"+date.getHours() +":"+date.getMinutes();
var days = [
    'Sunday',
    'Monday',
    'Tuesday',
    'Wednesday',
    'Thursday',
    'Friday',
    'Saturday',
];

var strategyObj = {
    symbol:'BANKNIFTY19JANFUT',
    indicators:[{indicator:'rsi',settings:'14',value:'60',op:'>='}
               ,{indicator:'sma',settings:'20',value:'close',op:'>='}],
    interval:'15min'
};




    

//console.log("data  : " + x + " :: "+JSON.stringify(database.data));

/*  var df =  dataForge.fromJSON(JSON.stringify(obj.data)) // Read CSV file (or JSON!)
//.setIndex("timestamp")
.dropSeries(["cp"]) // Drop certain columns.
.where(row => calculateIndicators(row)) // Filter rows.
.select(row => transform(row)); // Transform the data. 

const chronoOrder = df.reverse();
var output = df.toJSON();

var valuesDf = df.detectValues(); */ 
//console.log(valuesDf.toString());

function backTesting(stockData,path){ 

  /* var result = Enumerable.from(stockData).forEach(function(obj)
  {
      console.log(obj.sma + " > "+ obj.rsi);
      return obj.rsi >= 60;
  }); */

  //var example = Enumerable(stockData).where(function(item){ return item.rsi >= 60; });

  //var result = Enumerable.from(stockData).where(function(obj){return obj.rsi >= 60});
  //var result = Enumerable.from(stockData).select((val, i) => ({ return val.rsi >= 60}));

  var result = stockData.filter(function (item) {
      return item.rsi >= 60;
  });

  var result = result.filter(function (item) {
      return item.close >= item.sma;              
  });

  //console.log("\n \n stockData >> " + path +" >> "+result[0].timestamp);


  /* var stockData =response.data;

  //console.log("\n \n stockData >> " + JSON.stringify(stockData));


  stockData= stockData.map(x => 
  {
      var obj = x;
      obj.timestamp = new Date(obj.timestamp);

      //console.log("\n \n timestamp >> " +  obj.timestamp);
      return obj;
  });  
  var closeData = stockData.map(x => x.close);  
  var inputRSI = {
      values : closeData,
      period : 14
  };
  var rsiData = technicalindicators.RSI.calculate(inputRSI);
  var inputSMA = {
      values : closeData,
      period : 20
  };
  var smaData = technicalindicators.SMA.calculate(inputSMA);
  var BB = technicalindicators.BollingerBands
  var period = 14
  var inputBB = {
      period : period, 
      values : closeData ,
      stdDev : 2 
  }
  var bbData = BB.calculate(inputBB);
  //console.log("\n \n BB >> " + JSON.stringify(bbData));

  var index = 0;
  var buyprice = 0;
  var sellprice = 0;
  var profit = 0;
  var totalProfit = 0;
  var isBuySignalGenerated = false;
  var isSellSignalGenerated = false;
  var buyCall = 0;
  var sellCall = 0;
  
  stockData= stockData.map(x => 
  {
      var obj = x;
      obj.rsi = index > inputRSI.period?rsiData[index - inputRSI.period]:0;
      obj.sma = index >= inputSMA.period?smaData[index - inputSMA.period]:0;
      obj.bb = index >= inputBB.period?bbData[index - inputBB.period]:null;

      var date = new Date(obj.timestamp);;

      //console.log("date " + date);

      if(obj.rsi >= 60 && date.getDay() == date.getDay() && date.getMonth()== date.getMonth())
      {
          log(obj.rsi);
      }
      if(obj.rsi >= 60 && stockData[index - 1].rsi < 60)
      {
          buyCall++;
          buyprice = x.close;
          isBuySignalGenerated = true;
          console.log("\n\n BUY *>> " + x.timestamp +" >> "+ buyprice);
      }
      else if(obj.rsi != 0 && obj.rsi <= 40 && stockData[index - 1].rsi > 40)
      {
          sellCall++;
          sellprice = x.close;
          isSellSignalGenerated = true;
          console.log("\n\n SELL *>> " + x.timestamp +" >> "+ sellprice);
      }
      
      if(isBuySignalGenerated)
      {
          if(obj.rsi < 60 || x.close < obj.sma)
          {
              isBuySignalGenerated = false;  
              profit = x.close - buyprice;
              totalProfit += profit;
              console.log("\n\n EXIT CALL *>> " + x.timestamp+" close >> "+x.close+" profit>> "+ profit+" totalProfit >> "+ totalProfit +">>"+ buyCall);
          }
      }else if(isSellSignalGenerated)
      {
          if(obj.rsi > 40 || x.close > obj.sma)
          {
              isSellSignalGenerated = false;  
              profit = sellprice - x.close;
              totalProfit += profit;
              console.log("\n\n EXIT SELL *>> " + x.timestamp+" close >> "+x.close+" profit>> "+ profit+" totalProfit >> "+ totalProfit +">>"+ sellCall);
          }
      } 
      index++;
      return obj;
  }); 
  console.log(stockData); */
}


function mappedFunction()
{
 
}

function transform(row)
{
    var timestamp = '';
    if(row.timestamp > 0){
        var d =new Date(Number(row.timestamp));
        var india = moment.tz(d, 'DD-MM-YYYY HH:mm',"Asia/Kolkata");
        india.format(); 
        //console.log(india +" : "+ stockData[0].timestamp +" : "+ d);
        /*  if(india.minute() > 0)
            timestamp = india.date() +"/"+(india.month()+1) +"/"+india.year()+" "+india.hour()+":"+india.minute();
        else
            timestamp = india.date() +"/"+(india.month()+1) +"/"+india.year();      */       
    }  

    row.timestamp = india;

  //row.timestamp = new Date(row.timestamp);
  return row;
}

/* function searchPattern(row)
{
    var now = new Date();
    var thisMonth = months[now.getMonth()].slice(0,3).toUpperCase();
    var syombolPattern = /BANKNIFTY/i;
    var monthPattern = new RegExp(thisMonth, 'gi');
    var isWeeklyExpiry = true;
    var arr = row.split(",");
    var isMatchingSymbol  = String(arr[3]).search(syombolPattern);
 
  if(isMatchingSymbol >= 0){      
    var isMatchFound = false;
    var isMatchingMonth  = String(arr[3]).search(monthPattern);
    var isFuture = String(arr[3]).search("FUT");
    for(var i =0 ; i < 7;i++){
        if(days[now.getDay()] == "Thursday" || days[now.getDay()] == "Wednesday")
        {
            var fullyear = now.getFullYear();
            var month = now.getMonth() + 1;
            var day = now.getDate();
            day = String(day).length < 2 ? "0"+now.getDate() : now.getDate();
            var symbol = "BANKNIFTY" + String(fullyear).slice(2,4) +month+day;//18121328400CE
            var currentPrice = Math.round(arr[2] / 100) * 100;
            var pricePattern = new RegExp(String(currentPrice), 'gi');
            var isMatchingPrice  = String(arr[3]).search(pricePattern);
            var isMatchingWeek  = String(arr[3]).search(symbol);

            if(isMatchingWeek >= 0 && isMatchingPrice >=0){
                
                var isCE = String(arr[3]).search("CE");
                var isPE = String(arr[3]).search("PE");

                console.log("\n MATCH " + isCE +" > "+ isPE +" > "+arr[3]);

                if(isCE > 0)
                  bankNiftyCall.CE = arr[3];
                else if(isPE > 0)
                  bankNiftyCall.PE = arr[3];  
                isMatchFound = true;
            }
        }
        now.setDate(now.getDate() + 1);
    }

    if(!isMatchFound){
        if(isMatchingMonth >= 0 && isFuture >=0){
            //console.log("\n MATCH " + isMatchingWeek +" > "+ symbol +" > "+arr[3]);
            bankNiftyCall.FUTURE = arr[3];
            return row;
        }else{
            return 0;
        }
    }else{
        return row;
    }    
  }
  else{
      return 0;
  }
}
 */



var index = 0;
var buyprice = 0;
var sellprice = 0;
var profit = 0;
var totalProfit = 0;
var isBuySignalGenerated = false;
var isSellSignalGenerated = false;
var buyCall = 0;
var sellCall = 0;

function calculateIndicators(row)
{
  row.rsi = rsi.nextValue(Number(row.close));
  row.sma = sma.nextValue(Number(row.close));
  row.bb = bb.nextValue(Number(row.close)); 

var d =new Date(Number(row.timestamp));
var india = moment.tz(d, 'DD-MM-YYYY HH:mm',"Asia/Kolkata");
india.format(); 
row.date =india.date() +"/"+(india.month()+1) +"/"+india.year()+" "+india.hour()+":"+india.minute();

    if(india.hour() == 9 && india.minute() == 25 && row.bb && row.close > row.bb.upper)
    {
        buyCall++;
          buyprice = row.close;
          isBuySignalGenerated = true;
          console.log("\n\n BUY *>> " + row.date  +" >> "+ buyprice);
    }

    if(isBuySignalGenerated)
    {
        if(row.bb && row.close <= row.bb.middle)
        {
            isBuySignalGenerated = false;  
            profit = row.close - buyprice;
            totalProfit += profit;
            console.log("\n\n EXIT CALL *>> " + row.date+" close >> "+row.close+" profit>> "+ profit+" totalProfit >> "+ totalProfit +">>"+ buyCall);
        }
    }else if(isSellSignalGenerated)
    {
        if(obj.rsi > 40 || row.close > obj.sma)
        {
            isSellSignalGenerated = false;  
            profit = sellprice - row.close;
            totalProfit += profit;
            console.log("\n\n EXIT SELL *>> " + row.date+" close >> "+row.close+" profit>> "+ profit+" totalProfit >> "+ totalProfit +">>"+ sellCall);
        }
    } 
    index++;
  
  return row;
}

function log(message){

    if(process.env.NODE_ENV=="production")
        return;
        
    date = new Date();
   
    today = date.getDate() +"-"+(date.getMonth() +1)+"-"+date.getFullYear();
  
    var path = "logs/log-"+today+".txt";
    try {
        if (fs.existsSync(path)) {
            fs.appendFile(path, "\n"+date +" "+message, function (err) {
            if (err) throw err;
            }); 
        }else {
            fs.writeFile(path, "\n"+date +" "+message, function (err) {
                if (err) throw err;
            }); 
        }
    }    
    catch(err) {
        console.error(err);
        fs.writeFile(path, "\n"+date +" "+message, function (err) {
            if (err) throw err;
        }); 
    }    
}

function addIndicators(response,path){ 
  var stockData =response.data;
  //stockData=  //stockData.map(x => 

  for (let x of stockData) {
      var obj = x;
      obj.timestamp = new Date(obj.timestamp);
       return obj;
  }

  var closeData =[];// stockData.map(x => x.close);  
  for (let x of stockData) {
    closeData.push(x.close);
  }

  var inputRSI = {
      values : closeData,
      period : 14
  };
 /*  var rsiData = technicalindicators.RSI.calculate(inputRSI);
  var inputSMA = {
      values : closeData,
      period : 20
  };
  var smaData = technicalindicators.SMA.calculate(inputSMA);
  var BB = technicalindicators.BollingerBands;
  var period = 14;
  var inputBB = {
      period : period, 
      values : closeData ,
      stdDev : 2 
  }
  var bbData = BB.calculate(inputBB); */
  //console.log("\n \n BB >> " + JSON.stringify(bbData));

  var index = 0;
  var buyprice = 0;
  var sellprice = 0;
  var profit = 0;
  var totalProfit = 0;
  var isBuySignalGenerated = false;
  var isSellSignalGenerated = false;
  var buyCall = 0;
  var sellCall = 0;
  
  for (let x of stockData) {
  //stockData= stockData.map(x =>{
      var obj = x;
     /*  obj.rsi = index > inputRSI.period?rsiData[index - inputRSI.period]:0;
      obj.sma = index >= inputSMA.period?smaData[index - inputSMA.period]:0;
      obj.bb = index >= inputBB.period?bbData[index - inputBB.period]:null; */

      index++;
      //console.log("\nobj > " + JSON.stringify(obj));
      return obj;
  } 


  backTesting(stockData,path);
  //log(stockData);
}
/* 
var bankNiftyCall;
function checkBankNiftyExpiry()
{
      bankNiftyCall = new Object();

      fs.readFile('data/index/nse_fo.txt', function(err, response) {      
        var  data= JSON.parse(response).data;
        const transformedData = new dataForge.DataFrame(data)
        .where(row => searchPattern(row)) // Filter rows.
        .toArray();                        // Back to normal JavaScript data!.
   
       console.log("WATCH BANK NIFTY  ****** " + JSON.stringify(bankNiftyCall)); 
       console.log(" \n \n BANK NIFTY >> data >>" + transformedData);
    });
} */
var fs = require('fs');
var path = require('path');

var loki  = require( 'lokijs' );
var intervalsArr =['1MINUTE','15MINUTE','1DAY'];
var allIntervalsArr = ['15MINUTE','1DAY','60MINUTE','30MINUTE','10MINUTE','5MINUTE','3MINUTE','1MONTH','1WEEK'];

var database;

async function syncLiveAllStockData(list,interval,start_date,end_date){ 
    //console.log('syncLiveAllStockData  - ' + list.length);
    list.map(async (x) =>  {
        var symbol = x.symbol ? x.symbol:x;        
        var ex = x.ex;      
        //console.log('syncLiveAllStockData : Finished Queue  - ' + symbol +" :: "+ interval);
        queue.push({symbol: symbol,ex:ex,interval:interval,start_date:start_date,end_date:end_date}, function (err) {
           // console.log('syncLiveAllStockData : Finished Queue  - ' + interval);
        });
        x = symbol = ex= null;
    });        
}

//Sync Upstox data on first load
async function syncAllUpstoxData(list){ 
    var now= new Date();
    var india = moment.tz(now, 'DD-MM-YYYY HH:mm',"Asia/Kolkata"); 
    var intervals = allIntervalsArr; 
   /*  if(india.day() == 0 || india.day() == 6 || india.hour() >= 18 || india.hour() <= 9)
    {
        intervals = allIntervalsArr;
    }
 */
    await intervals.map(async (interval) =>  {
        console.log('syncAllUpstoxData :  interval  - ' + interval);
        await list.map(async (x) =>  {
            var symbol = x.symbol ? x.symbol:x;        
            var ex = x.ex;      
            
            var now = new Date();
            var india = moment.tz(now, 'DD-MM-YYYY HH:mm',"Asia/Kolkata"); 
            var end_date = formatDate(india.date())+"-"+formatDate(india.month() + 1)+"-"+india.year();
            if(interval == '1MONTH')
                now.setMonth(now.getMonth() - 20);
            else if(interval == '1WEEK')
                now.setDate(now.getDate() - 22 * 7);
            else if(interval == '1DAY')
                now.setDate(now.getDate() - 202);    
            else if(interval == '30MINUTE' || interval == '60MINUTE')
                now.setDate(now.getDate() - 6);
            else if(interval == '15MINUTE')
                now.setDate(now.getDate() - 3);
            else if(interval == '5MINUTE' || interval == '3MINUTE' || interval == '1MINUTE')
                now.setDate(now.getDate() - 1);
            else if(interval == '5MINUTE' || interval == '3MINUTE')
                 now.setDate(now.getDate());
            else
                now.setDate(now.getDate() - 6);

            india = moment.tz(now, 'DD-MM-YYYY HH:mm',"Asia/Kolkata");
            india.format(); 
            var start_date = formatDate(india.date())+"-"+formatDate(india.month() + 1)+"-"+india.year();
            await queue.push({symbol:symbol,ex:ex,interval:interval,start_date:start_date,end_date:end_date}, function (err) {
                //console.log('syncAllUpstoxData : Finished Queue  - ' + interval);  
            });
        }); 
    });          
}

//Get Percentage change 
async function getPercent_list(list){ 
    var now = new Date();
    var india = moment.tz(now, 'DD-MM-YYYY HH:mm',"Asia/Kolkata"); 
    var time = india.hour() +":"+india.minute();

    console.log("getPercent_list  - time : " + time);
    var intervalsArr = ['1DAY','15MINUTE'];
    Promise.all(intervalsArr.map(async (interval) => {  
        return new Promise(function(resolved, rejected) {           
            Promise.all(list.map(async (x) =>  {
                return getStockDataFromDb(x.symbol ? x.symbol:x,interval);          
            })).then(stockData => {
                resolved(stockData);
            })
            .catch(error => { 
                console.log(error)
            }); 
        })
    })).then(dataArr => {
            var percentageChangeArray = [];
            for(var i = 0; i < dataArr[0].length;i++){
                try{
                    var dataObj1 = dataArr[0][i];
                    var dataObj2 = dataArr[1][i];
                    if(dataObj1.symbol == dataObj2.symbol)
                    {
                        var stock1 = [];
                        //console.log(dataObj1.symbol +" : "+ dataObj1.data);
                        stock1 = JSON.parse(dataObj1.data);
                        stock1.reverse();
                        var stock2 = [];
                        stock2 = JSON.parse(dataObj2.data);
                        stock2.reverse();
                        var perc = getPercentageChange(stock1[0].close,stock2[0].close);
                        var percObj = {};
                        percObj.symbol = dataObj1.symbol;
                        percObj.percentage = perc;
                        if(time == "9-30")
                            percObj.open = stock2[0].open;
                        
                        percObj.low = Math.max((percentageChangeArray[i] && percentageChangeArray[i].low) ? percentageChangeArray[i].low : 0,stock2[0].low);
                        percObj.close = Number(stock2[0].close);
                        percObj.high = Math.max((percentageChangeArray[i] && percentageChangeArray[i].high) ? percentageChangeArray[i].high : 0,stock2[0].high);

                        percentageChangeArray.push(percObj);
                        //console.log(dataObj1.symbol +" : "+ perc);
                        stock1 =  stock2 =  null;
                    }
                }
                catch(error){ 
                    //console.log("getPercent_list Parsing error " +dataObj1.symbol +" : "+ error);
                    //syncLiveStockDataByInterval([dataObj1.symbol],)
                }
            }
            percentageChangeArray.sort(function(a, b){return a.percentage - b.percentage});
            percentageChangeArray.reverse();
            store.set("percentage",percentageChangeArray);
            
            percentageChangeArray = dataArr =  intervalsArr = null;
            return 1;
    })
    .catch(error => { 
        console.log(error)
    }); 
}

//Get Indicators 
async function getDefaultIndicatorsValues(list,interval){ 
// console.log("* getAllStockDataByInterval   >> "+list.length);
    var matchSymbols = [];
    Promise.all(list.map(async (x) =>  {
    var symbol = x.symbol ? x.symbol:x;    
    return getStockDataFromDb(symbol,interval);          
    })).then(stockData => {
        var arr = stockData.map(async (dataObj) =>  {
            try{
                var data = JSON.parse(dataObj.data); 
            }
            catch(e){
                console.log("Error " + e);
            }
        });                           
    })
    .catch(error => { 
        console.log(error)
    }); 
}

//backTesting
async function backTesting(symbol,interval,strategy,isbackTesting){ 
    var matchDates = [];
    return new Promise(function(resolved, rejected) {           
        var arr =  getStockDataFromDb(symbol,interval); 
        resolved(arr);  
    }).then(stockData => {
            try{
                var data = JSON.parse(stockData.data); 
                startBackTesting(symbol,data,strategy,isbackTesting).then(finalResult => { 
                for(var i=0; i < finalResult[1].length;i++){
                    var finalResultFlag = finalResult[0][i].every(x => x.flag == true);
                  
                    if(finalResultFlag){
                        matchDates.push(finalResult[1][i][0].date);
                       // console.log("\n > " +JSON.stringify(finalResult[0][i]));
                       // console.log("\n backTesting RESULT  > " +strategy.name +"::"+ stockData.symbol +" > "+ matchDates);
                    }
                }  
                
                console.log("\n backTesting RESULT  > " +strategy.name +"::"+ stockData.symbol +" > "+ matchDates);
            }).catch(error => 
            {
                console.log("OUTER LOOP ERROR > " + error)
            });
        }
        catch(e){
            console.log("Error " + e);
        }             
    })
    .catch(error => { 
        console.log(error)
    }); 
}

async function syncLiveStockDataByInterval(list,interval){ 
    list.map(async (x) =>  {
        var symbol = x.symbol ? x.symbol:x;    
        var ex = x.ex;        
        queue.push({symbol:symbol,ex:ex,interval:interval}, function (err) {
           //console.log('syncLiveStockDataByInterval : Finished Queue' + interval);
        });       
    }); 
}

function getStockDataByInterval(symbol,interval,strategy){ 
    getStockDataFromDb(symbol,interval)
    .then(dataObj  => {
        //console.log("symbol  "+dataObj.symbol);
       var data = JSON.parse(dataObj.data); 
       // console.log("getStockDataByInterval \n " + data.length);
       // getIndicator(dataObj.symbol,data,strategy,true);
    }).catch(error => console.log(error));  
}


var Upstox = require("upstox");
var moment = require('moment-timezone');


var api = "OknufM07tm1g9EfN4fHKP2Eqi9DSw40I2Y3xliHg";
var upstox = new Upstox(api);
var fs = require('fs');
var months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
var code = '';
var __dirname = "views"
var exchanges =  [ 'MCX_FO', 'BSE_EQ', 'NSE_EQ', 'NSE_FO', 'NCD_FO'];
var api_secret = "69xldylnvf";
var client_id="";

var accessToken;

function getAcceToken(code)
{
    var params = {
        "apiSecret": api_secret,
        "code": code,
        "grant_type": "authorization_code",
        "redirect_uri": redirect_uri
    };
    
    upstox.getAccessToken(params)
        .then(function (response) {
            params = code = null;
                
            accessToken = response.access_token;
            //store.set('accessToken', accessToken); 
            var d  = new Date();
            
            var india = moment.tz(d, 'DD-MM-YYYY HH:mm',"Asia/Kolkata");
            india.format(); 
            
            india = india.set({
                'year' : india.year(),
                'date' : india.date() + 1,
                'hour' : 9,
                'minute'  : 05, 
                'second' : 05
             });
     
            store.set('tokenValidity', india); 
            console.log("accessToken : " +accessToken);
            upstox.setToken(accessToken);
            start();
            //res.sendFile("index.html", {"root": __dirname});
        })
        .catch(function (err) {
            console.log( "getAccessToken Error > " + JSON.stringify(err));
        });
}


function start() {
    //console.log( 'start');
    // an example using an object instead of an array
   //queue.empty();

    async.parallel({
        getProfile,
        getBalance,
        //getListOfAllSymbol,
        getAllData
    }, function(err, results) {
        console.log( 'start finish');
    });

   
       
    var bankNiftyCall;
          
    upstox.getMasterContract({exchange: "nse_fo"})
    .then(function(response) {
        //console.log("NSE FO " + JSON.stringify(response));
        
        /* bankNiftyCall = new Object();

      //  var response = JSON.parse(response);
        //console.log('\n 1.1' + response);
        var  data=csvTojs(response.data);

        //console.log("NSE FO " + JSON.stringify(data));

        var now = new Date();
        var thisMonth = months[now.getMonth()].slice(0,3).toUpperCase();
        var monthPattern = new RegExp(thisMonth, 'gi');
        
       var transformedData = JSON.parse(JSON.stringify(transformedData));
        //console.log(' >  ' + transformedData);

        var dataFrame = dataForge.fromJSON(transformedData)
        .where(row => {
     
           //console.log('\n row > ' + JSON.stringify(row));
            row = JSON.stringify(row);
           // console.log('\n row > ' + JSON.stringify(row));
           // console.log('\n symbol > ' + row.symbol);
            var isMatchingMonth  = String(row.symbol).search(monthPattern);
            var isFuture = String(row.symbol).search("FUT");

            if(isMatchingMonth >= 0 && isFuture >=0){
                console.log("\n \n MATCH  >> > " + row.symbol );
                bankNiftyCall.FUTURE = row.symbol;
                return row;
            }
        });  */
        
        console.log("FNO data >> \n \n" + transformedData);

        fs.writeFile("data/index/nse_fo.txt", JSON.stringify(response), function (err) {
            if (err) throw err;
            console.log('nse_fo File is created successfully.');
        }); 

        //checkBankNiftyExpiry();
    })
    .catch(function(err) {
        console.log("nse fo error " + JSON.stringify(err));
    });

    // Get Master Contract
   /*  upstox.getMasterContract({ exchange: "NSE_INDEX",format:"json"})
    .then(function (response) {
        fs.writeFile("data/index/index.txt", JSON.stringify(response), function (err) {
            if (err) throw err;
            console.log('index File is created successfully.');
        }); 
    })
    .catch(function (err) {
        console.log(err);
    }); */

    // PlaceOrder Note : default product = I i.e intra day order will be placed.
    /*var orderObject = {
        transaction_type:"b",
        exchange:"NSE_EQ",
        symbol: "RELIANCE",
        quantity: 1,
        order_type:"m"
    };

    upstox.placeOrder(orderObject)
        .then(function(response) {
            // Order details received
            console.log(response);
        })
        .catch(function(err) {
            // Something went wrong.
            console.log(err);
        });
    */

    upstox.connectSocket()
        .then(function(){
            upstox.on("orderUpdate", function(message) {
                console.log("orderUpdate"+ message);
            });
            upstox.on("positionUpdate", function(message) {
                //message for position conversion
                console.log("positionUpdate"+ message);
            });
            upstox.on("tradeUpdate", function(message) {
                //message for trade updates
                console.log("tradeUpdate"+ message);
            });

            //console.log("niftyList" + niftyList);
            var niftyStr = nifty.join();
            //console.log("join" + niftyStr);

            upstox.subscribeFeed({
                "exchange": "NSE_EQ",
                "symbol": niftyStr,//'BANKNIFTY27DECFUT',//NIFTY29NOVFUT NIFTY18NOVFUT,BANKNIFTY18NOVFUT
                "type": "ltp"
            })
            .then(function (response) {
                console.log('feedsymbols subscribeFeed response ', response);
            })
            .catch(function (error) {
                //res.send({ error: error });
                console.log('Error in subscribe feed ', error);
            });  

            upstox.on("liveFeed", function(message) {
                //message for live feed
                console.log("liveFeed"+ message);
            });
            upstox.on("disconnected", function(message) {
                //listener after socket connection is disconnected
                console.log("disconnected > "+ message);
            });
            upstox.on("error", function(error) {
                //error listener
                console.log("upstox.on error"+ error);
            });
        }).catch(function(error) {
            console.log( "connectSocket #" + error);
    });
}


var nseSymbolList = [];
function getListOfAllSymbol()
{
    return store.get('niftyList'); 
}

// Get Balance
var balance;
function getBalance()
{
    //console.log( 'getBalance');
    upstox.getBalance({ type: "security" })  // type can be security or commodity
    .then(function (response) {
        balance = JSON.stringify(response);
        
        getListOfAllSymbol();
    })
    .catch(function (err) {
        console.log(err);
        getListOfAllSymbol();
    });
}


var profile;
function getProfile()
{
   // console.log( 'getProfile');
    upstox.getProfile()
    .then(function (response) {
        //console.log("getProfile "+ JSON.stringify(response));
        client_id = response.data.client_id;
        profile = JSON.stringify(response.data);
    })
    .catch(function (error) {
        console.log("getProfile Error"+ JSON.stringify(error));
    });
}
/* 
function getMaster(ex = "nse_fo"){ 
    if(store.get('accessToken')){
        return upstox.getMasterContract({exchange: ex});
    }    
} */

async function loadSymbol(symbol,exchange,interval='1day',start_date='',end_date=''){ 
   //console.log("loadSymbol > " + symbol + " > "+accessToken +" :: "+ interval +" > "+exchange +" > "+ start_date +" > "+ end_date);
    upstox.setToken(accessToken);
    return new Promise(function(resolved, rejected) {   
        upstox.getOHLC({"exchange": exchange,
            "symbol": symbol,
            "start_date": start_date,
            "end_date": end_date,
            "format" : "json",
            "interval" : interval
        }).then(result =>{
            resolved(result);
            })
        .catch(error =>{
            rejected(error);
        }); 
    });
}

function getAllData(){
    queue.empty();

    let promise = new Promise(function(resolve, reject) {
        syncAllUpstoxData(watchList);
        setTimeout(function() {
            resolve(1);
        }, 47000);
          
    }).then(res=>{
        return Number(res) + 1;
    });

    promise.then(function(result)  {
        strategyStrongList.map(async(strategy)=>{
            applyStrategy(watchList,'1DAY',strategy); 
        });
        return Number(result) + 1;
    });
}

var stockData = []; 
var data = {};
var promiseArr = [];
 
async function loadAllSymbolData(response,interval='1DAY',start_date='11-11-2018'){ 
    console.log('* Step 1 : loadSymbol ');
    promiseArr = [];
    return Promise.all(response.map(function(symbol) { 
      return loadSymbol(symbol,'NSE_EQ',interval,start_date).then(function (response) {
            try {
                    console.log('* loadSymbol ' + JSON.stringify(response));
                    stockData =response.data;
                    //console.log('* loadSymbol symbol  > ' +symbol +" :: "+interval +" :: "+start_date+" :: "+ stockData);// +":: "+stockData);

                    var inputRSI = {
                        values : [],
                        period : 14
                    };
                    /* rsi = new technicalindicators.RSI(inputRSI);
                    var inputSMA = {
                        values : [],
                        period : 20
                    };
                    sma= new technicalindicators.SMA(inputSMA);
                    var inputBB = {
                        period : 14, 
                        values : [],
                        stdDev : 2 
                    }
                    bb = new technicalindicators.BollingerBands(inputBB); */
                    inputBB = inputRSI = inputSMA = null;
                    
                    stockData.map(row => {
                        if(row && Number(row.close) > 0){
                            /* row.rsi = rsi.nextValue(Number(row.close));
                            row.sma = sma.nextValue(Number(row.close));
                            row.bb = bb.nextValue(Number(row.close));  */
                        }
                        row.change = getPercentageChange(Number(lastObject.close),Number(row.close)); 
                    
                        if(row.bb && Number(row.close) >= Number(row.bb.upper))// && lastObject && Number(lastObject.close) < Number(lastObject.bb.upper))
                        {
                            row.bb.isCrossed = 'Crossed Above';
                        }
                        else if(row.bb && Number(row.close) <= Number(row.bb.lower))// && lastObject && Number(lastObject.close) > Number(lastObject.bb.lower))
                        {
                            row.bb.isCrossed = 'Crossed Below';
                        }
                        lastObject = row;
                        
                        return row;
                    });
               
                stockData.reverse();
                var timestamp;
               
                if(stockData[0].timestamp > 0){
                    var d =new Date(Number(stockData[0].timestamp));
                    var india = moment.tz(d, 'DD-MM-YYYY HH:mm',"Asia/Kolkata");
                    india.format(); 
                    //console.log(india +" : "+ stockData[0].timestamp +" : "+ d);
                    if(india.minute() > 0)
                        timestamp = india.date() +"/"+(india.month()+1) +"/"+india.year()+" "+india.hour()+":"+india.minute();
                    else
                        timestamp = india.date() +"/"+(india.month()+1) +"/"+india.year();            
                }   
                
                
                data = {
                    "symbol":symbol,
                    "close":stockData[0].close,
                    "volume":stockData[0].volume,
                    "rsi":stockData[0].rsi,
                    "timestamp":timestamp,
                    "sma":stockData[0].sma, 
                    "bb":stockData[0].bb,
                    "change":stockData[0].change
                }; 
                //console.log("data   > " + JSON.stringify(data));
                stockData = null;
                promiseArr.push(data);
                return data;
              } catch (err) {
                console.log("loadAllSymbolData : err   > " + err);
                //return err;
              }
        });
    }));
}


async function getUpstoxData(response,interval='1DAY',start_date='',end_date=''){ 
    console.log('* Step 1 : loadSymbol ');
    promiseArr = [];
    return Promise.all(response.map(function(symbol) { 
      return loadSymbol(symbol,'NSE_EQ',interval,start_date,end_date).then(function (response) {
            try {
                    console.log('* loadSymbol ' + JSON.stringify(response));
                    stockData =response.data;
                    promiseArr.push(data);
                    return data;
                } catch (err) {
                console.log("loadAllSymbolData : err   > " + err);
                //return err;
                }
        });
    }));
}



function csvTojs(csv) {
  var lines=csv;//.split(",");
  var result = [];

  var headers = lines[0].split(",");

    

  for(var i=1; i<lines.length; i++) {
    var obj = {};

    var row = lines[i],
      queryIdx = 0,
      startValueIdx = 0,
      idx = 0;

    if (row.trim() === '') { continue; }

    while (idx < row.length) {
      /* if we meet a double quote we skip until the next one */
      var c = row[idx];

      if (c === '"') {
        do { c = row[++idx]; } while (c !== '"' && idx < row.length - 1);
      }

      if (c === ',' || /* handle end of line with no comma */ idx === row.length - 1) {
        /* we've got a value */
        var value = row.substr(startValueIdx, idx - startValueIdx).trim();

        /* skip first double quote */
        if (value[0] === '"') { value = value.substr(1); }
        /* skip last comma */
        if (value[value.length - 1] === ',') { value = value.substr(0, value.length - 1); }
        /* skip last double quote */
        if (value[value.length - 1] === '"') { value = value.substr(0, value.length - 1); }

        var key = headers[queryIdx++];
        obj[key] = value;
        startValueIdx = idx + 1;
      }

      ++idx;
    }

    result.push(obj);
  }
  return result;
}

function getPercentageChange(oldNumber, newNumber){
  var decreaseValue = newNumber - oldNumber;

  return ((decreaseValue / oldNumber) * 100).toFixed(2);
}

Array.prototype.insert = function(i,...rest){
  return this.slice(0,i).concat(rest,this.slice(i));
}


function formatDate(str)
{
    if(String(str).length == 1)
    {
        str ="0"+str;
    }
    return str;
}