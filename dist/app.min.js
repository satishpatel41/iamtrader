"use strict";var __awaiter=this&&this.__awaiter||function(s,r,i,l){return new(i||(i=Promise))(function(e,t){function a(e){try{o(l.next(e))}catch(e){t(e)}}function n(e){try{o(l.throw(e))}catch(e){t(e)}}function o(t){t.done?e(t.value):new i(function(e){e(t.value)}).then(a,n)}o((l=l.apply(s,r||[])).next())})},__generator=this&&this.__generator||function(a,n){var o,s,r,e,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(o)throw new TypeError("Generator is already executing.");for(;i;)try{if(o=1,s&&(r=2&t[0]?s.return:t[0]?s.throw||((r=s.return)&&r.call(s),0):s.next)&&!(r=r.call(s,t[1])).done)return r;switch(s=0,r&&(t=[2&t[0],r.value]),t[0]){case 0:case 1:r=t;break;case 4:return i.label++,{value:t[1],done:!1};case 5:i.label++,s=t[1],t=[0];continue;case 7:t=i.ops.pop(),i.trys.pop();continue;default:if(!(r=0<(r=i.trys).length&&r[r.length-1])&&(6===t[0]||2===t[0])){i=0;continue}if(3===t[0]&&(!r||t[1]>r[0]&&t[1]<r[3])){i.label=t[1];break}if(6===t[0]&&i.label<r[1]){i.label=r[1],r=t;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(t);break}r[2]&&i.ops.pop(),i.trys.pop();continue}t=n.call(a,i)}catch(e){t=[6,e],s=0}finally{o=r=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},sqlite3=require("sqlite3").verbose(),db=new sqlite3.Database("db/upstox.db",function(e){if(e)return console.error(e.message);console.log("Connected to the in-memory SQlite database.")});function closeDb(){db.close()}function insertDB(e){db.run(e,function(e,t){})}function getData(e,t){db.get(e,t,function(e,t){})}var nodemailer=require("nodemailer"),transporter=nodemailer.createTransport({service:"gmail",auth:{user:"satish.patel41@gmail.com",pass:"Pratiksha@123"}}),mailOptions={from:'"Admin" <satish.patel41@gmail.com>',to:"satish.patel41@yahoo.com",subject:"Call Generated",text:"Hello world?",html:'<p><b>Hello</b> to myself <img src="cid:note@example.com"/></p><p>Here\'s a nyan cat for you as an embedded attachment:<br/><img src="cid:nyan@example.com"/></p>',attachments:[{filename:"notes.txt",content:"Some notes about this e-mail",contentType:"text/plain"}],list:{help:"admin@example.com?subject=help",unsubscribe:[{url:"http://example.com/unsubscribe",comment:"A short note about this url"},"unsubscribe@example.com"],id:{url:"mylist.example.com",comment:"This is my awesome list"}}};function sendingMail(){transporter.sendMail(mailOptions,function(e,t){if(e)return console.log(e);console.log("Message sent: %s",t.messageId),console.log("Preview URL: %s",nodemailer.getTestMessageUrl(t))})}var cron=require("node-cron"),list=fnoList,stockObj={data1day:[],data60:[],data30:[],data10:[],data5:[]};function load1dayData(){log("NSE 1 day data update");var t=niftyList,a=new Date;a.setDate(a.getDate()-21);var e=a.getDate()+"-"+(a.getMonth()+1)+"-"+a.getFullYear(),n="1DAY";accessToken&&loadAllSymbolData(t,n,e).then(function(e){stockObj.data1day=e,log("*** NSE 1 day *** \n "+JSON.stringify(stockObj)),t=a=n=null}).catch(function(e){log("loadAllSymbolData/ error > "+JSON.stringify(e))})}function load60minData(){log("NSE 60MINUTE data update");var t=niftyList,a=new Date;a.setMinutes(a.getMinutes()-3e3);var e=a.getDate()+"-"+(a.getMonth()+1)+"-"+a.getFullYear(),n="60MINUTE";accessToken&&loadAllSymbolData(t,n,e).then(function(e){stockObj.data60=e,log("*** NSE 60 MINUTE *** \n "+JSON.stringify(stockObj)),t=a=n=null}).catch(function(e){log("loadAllSymbolData/ error > "+JSON.stringify(e))})}function load30minData(){log("NSE 30MINUTE data update");var t=niftyList,a=new Date;a.setMinutes(a.getMinutes()-1500);var e=a.getDate()+"-"+(a.getMonth()+1)+"-"+a.getFullYear(),n="30MINUTE";accessToken&&loadAllSymbolData(t,n,e).then(function(e){stockObj.data30=e,log("*** NSE 30 MINUTE *** \n "+JSON.stringify(stockObj)),t=a=n=null}).catch(function(e){log("loadAllSymbolData/ error > "+JSON.stringify(e))})}function load10minData(){log("NSE 10MINUTE data update");var e=new Date;e.setMinutes(e.getMinutes()-500);e.getDate(),e.getMonth(),e.getFullYear()}function load5minData(){log("NSE 5 MINUTE data update");var e=new Date;e.setMinutes(e.getMinutes()-250);e.getDate(),e.getMonth(),e.getFullYear()}cron.schedule("*/5 * * * *",function(){load5minData(),console.log("running a task every 5 minutes")},{scheduled:!0,timezone:"Asia/Kolkata"}),cron.schedule("*/10 * * * *",function(){load10minData(),console.log("running a task every 10 minutes")},{scheduled:!0,timezone:"Asia/Kolkata"}),cron.schedule("*/30 * * * *",function(){load30minData(),console.log("running a task every 30 minutes")},{scheduled:!0,timezone:"Asia/Kolkata"}),cron.schedule("0 */1 * * *",function(){load60minData(),console.log("running a task every 1 hour")},{scheduled:!0,timezone:"Asia/Kolkata"}),cron.schedule("0 17 * * *",function(){load1dayData(),console.log("running a task every 1 day")},{scheduled:!0,timezone:"Asia/Kolkata"});var express=require("express"),bodyParser=require("body-parser"),fs=require("fs"),url=require("url"),dataForge=require("data-forge");require("data-forge-fs");var upstox=new(Upstox=require("upstox"))(api="cIs71szuLZ7WFKInU8O0o7GTHm5QIJke8ahnzLVw"),PORT=process.env.PORT||8080,redirect_uri="http://localhost:"+PORT,nifty="https://www.nseindia.com/content/indices/ind_nifty50list.csv",fno="https://www.nseindia.com/content/fo/fo_mktlots.csv";"production"==process.env.NODE_ENV&&(api="cIs71szuLZ7WFKInU8O0o7GTHm5QIJke8ahnzLVw",redirect_uri="https://robo-trader.herokuapp.com/");var app=express();app.use(express.static("public")),app.use(bodyParser.json()),app.use(bodyParser.urlencoded({extended:!0})),app.use(function(e,t,a){t.header("Access-Control-Allow-Origin","*"),t.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept"),a()});var months=["January","February","March","April","May","June","July","August","September","October","November","December"],today=(date=new Date).getDate()+"-"+(date.getMonth()+1)+"-"+date.getFullYear(),time=date+":"+date.getHours()+":"+date.getMinutes(),fnoArr=dataForge.readFileSync("data/list/fo_mktlots.csv").parseCSV().toArray(),fnoList=[];fnoArr.forEach(function(e){e.Symbol?fnoList.push(e.Symbol):fnoList.push(e.SYMBOL)});var niftyList=dataForge.readFileSync("data/list/ind_nifty50list.csv").parseCSV().toArray();niftyList=niftyList.map(function(e){return e.Symbol}),app.get("/",function(e,t){var a=url.parse(e.url,!0).query;(code=a.code)&&getAcceToken(code),t.sendFile("index.html",{root:__dirname}),a=null}),app.get("/welcome",function(e,t){t.send("<b>Hello</b> welcome to my http server made with express")}),app.get("/login",function(e,t){t.sendFile("login.html",{root:__dirname})}),app.post("/login",function(e,t){var a=e.body.username,n=e.body.password;a?t.send("<b>username </b>  : "+a+" > "+n):t.sendFile("login.html",{root:__dirname})}),app.get("/signup",function(e,t){t.sendFile("signup.html",{root:__dirname})}),app.post("/signup",function(e,t){var a=e.body.email,n=e.body.psw;e.body.pswRepeat;a?t.send("<b>username </b>  : "+a+" > "+n):t.sendFile("signup.html",{root:__dirname})}),app.get("/contactus",function(e,t){t.sendFile("contactus.html",{root:__dirname})}),app.get("/index",function(e,t){t.sendFile("index.html",{root:__dirname})}),app.get("/scan",function(e,t){t.sendFile("scanner.html",{root:__dirname})}),app.get("/strategy",function(e,t){t.sendFile("strategy.html",{root:__dirname})});var lastObject={open:"",close:"",low:"",high:"",volume:"",timestamp:"",rsi:"",sma:"",bb:{upper:"",lower:"",isCrossed:"",middel:"",pb:""}},stockData=[];function initiateIndicator(){var e={values:[],period:14};rsi=new technicalindicators.RSI(e);var t={values:[],period:20};sma=new technicalindicators.SMA(t);var a={period:14,values:[],stdDev:2};bb=new technicalindicators.BollingerBands(a),a=e=t=null}app.post("/createStrategy",function(e,c){var u=JSON.parse(e.body.data),t=u.interval,a=new Date;"5MINUTE"==t?a.setDate(a.getDate()-2):"10MINUTE"==t?a.setDate(a.getDate()-3):"30MINUTE"==t?a.setDate(a.getDate()-4):"60MINUTE"==t?a.setDate(a.getDate()-4):"1DAY"==t?a.setDate(a.getDate()-20):"1WEEK"==t?a.setDate(a.getDate()-140):"1MONTH"==t&&a.setMonth(a.getMonth()-20);var n=a.getDate()+"-"+(a.getMonth()+1)+"-"+a.getFullYear();initiateIndicator(),stockData=[],loadSymbol(u.symbol,u.exchange,t,n).then(function(e){c.setHeader("Content-Type","application/json"),stockData=e.data,lastObject={open:"",close:"",low:"",high:"",volume:"",timestamp:"",rsi:"",sma:"",bb:{upper:"",lower:"",isCrossed:"",middel:"",pb:""}},stockData.map(function(e){return e.timestamp=new Date(e.timestamp),e.rsi=rsi.nextValue(Number(e.close)),e.sma=sma.nextValue(Number(e.close)),e.bb=bb.nextValue(Number(e.close)),lastObject=e}),stockData.reverse();var t={symbol:u.symbol,close:stockData[0].close,volume:stockData[0].volume,rsi:stockData[0].rsi,timestamp:stockData[0].timestamp,sma:stockData[0].sma,bb:stockData[0].bb},a=!1;console.log("0 > "+u.indicators.length);for(var n=0;n<u.indicators.length;n++){console.log("1");var o=u.indicators[n].op;console.log("2"+o);var s=t[u.indicators[n].indicator];console.log("3"+s);var r=u.indicators[n].value;console.log("4"+r);var i=!1;"<"==o?i=s<r:">"==o?i=r<s:"<="==o?i=s<=r:">="==o?i=r<=s:"=="==o&&(i=s==r),console.log("result"+i),i&&(a=!0),console.log("isMatch"+a)}if(a){var l={transaction_type:u.orderType,exchange:u.exchange,symbol:u.symbolToBuySell,quantity:1,order_type:"m"};upstox.placeOrder(l).then(function(e){console.log(e)}).catch(function(e){console.log(e)})}console.log("Result "+JSON.stringify(t)),c.send(JSON.stringify(t)),stockData=null,c.end()}).catch(function(e){log("createStrategy error > "+JSON.stringify(e))})}),app.get("/loadSymbol/:symbol/:interval",function(e,t){var a=e.params.symbol,n=e.params.interval,o=new Date;"5MINUTE"==n?o.setMinutes(o.getMinutes()-100):"10MINUTE"==n?o.setMinutes(o.getMinutes()-200):"30MINUTE"==n?o.setMinutes(o.getMinutes()-600):"60MINUTE"==n?o.setMinutes(o.getMinutes()-1200):"1DAY"==n?o.setDate(o.getDate()-20):"1WEEK"==n?o.setDate(o.getDate()-140):"1MONTH"==n?o.setMonth(o.getMonth()-20):o.setDate(o.getDate()-20);var s=o.getDate()+"-"+(o.getMonth()+1)+"-"+o.getFullYear();console.log("start_date > "+n+" >> "+s),initiateIndicator(),stockData=[],loadSymbol(a,"nse_eq",n,s).then(function(e){t.setHeader("Content-Type","application/json"),stockData=e.data,lastObject={open:"",close:"",low:"",high:"",volume:"",timestamp:"",rsi:"",sma:"",bb:{upper:"",lower:"",isCrossed:"",middel:"",pb:""}},stockData.map(function(e){return e.timestamp=new Date(e.timestamp),e.rsi=rsi.nextValue(Number(e.close)),e.sma=sma.nextValue(Number(e.close)),e.bb=bb.nextValue(Number(e.close)),Number(e.close)>=e.bb.upper&&Number(lastObject.close)<Number(lastObject.bb.upper)?e.bb.isCrossed="Crossed Above":Number(e.close)<=e.bb.lower&&Number(lastObject.close)>Number(lastObject.bb.lower)&&(e.bb.isCrossed="Crossed Below"),lastObject=e}),stockData.reverse(),t.send(JSON.stringify(stockData)),stockData=null,t.end()}).catch(function(e){log("/loadSymbol/:symbol/:interval error > "+JSON.stringify(e))})}),app.get("/getFutureContract/:exchange",function(e,r){var i=e.params.exchange;console.log("getMaster exchange > "+JSON.stringify(i)),fs.readFile("data/index/nse_fo.txt","utf8",function(e,t){var a=JSON.parse(t),n=new Date,o=months[n.getMonth()].slice(0,3).toUpperCase(),s=(new RegExp(o,"gi"),csvTojs(a.data).filter(function(e){return String(e.instrument_type)===i}).map(function(e){return e.symbol}));r.setHeader("Content-Type","application/json"),r.send(s),r.end()})}),app.get("/loadAllSymbolData/:interval/:exchange",function(e,a){var n=e.params.interval,o=e.params.exchange,s=[];s="nifty"==o?niftyList:"fno"==o?fnoList:nseSymbolList;var t=[];"5MINUTE"==n?t=stockObj.data5:"10MINUTE"==n?t=stockObj.data10:"30MINUTE"==n?t=stockObj.data30:"60MINUTE"==n?t=stockObj.data60:"1DAY"==n&&(t=stockObj.data1day);var r=t.filter(function(e){return null!=e&&null!=e.close&&null!=e.close&&""!=e.close});if(0<r.length)a.setHeader("Content-Type","application/json"),a.send(JSON.stringify(r)),a.end();else{console.log("*** Ok No data available.. Fetch it \n ");var i=new Date;"5MINUTE"==n?i.setDate(i.getDate()-2):"10MINUTE"==n?i.setDate(i.getDate()-3):"30MINUTE"==n?i.setDate(i.getDate()-4):"60MINUTE"==n?i.setDate(i.getDate()-4):"1DAY"==n?i.setDate(i.getDate()-20):"1WEEK"==n?i.setDate(i.getDate()-140):"1MONTH"==n&&i.setMonth(i.getMonth()-20);var l=i.getDate()+"-"+(i.getMonth()+1)+"-"+i.getFullYear();loadAllSymbolData(s,n,l).then(function(e){var t=e.filter(function(e){return null!=e&&null!=e.close&&null!=e.close&&""!=e.close});"5MINUTE"==n?stockObj.data5=t:"10MINUTE"==n?stockObj.data10=t:"30MINUTE"==n?stockObj.data30=t:"60MINUTE"==n?stockObj.data60=t:"1DAY"==n&&(stockObj.data1day=t),a.setHeader("Content-Type","application/json"),a.send(JSON.stringify(e)),o=s=n=t=null,a.end()}).catch(function(e){log("loadAllSymbolData/ error > "+JSON.stringify(e))})}}),app.get("/getListOfAllSymbol",function(e,t){t.setHeader("Content-Type","application/json"),t.send(JSON.stringify(nseSymbolList)),t.end()}),app.get("/sync",function(e,t){t.setHeader("Content-Type","application/json"),t.send("Successfully sync data !"),t.end()}),app.get("/getBalance",function(e,t){syncStockData(),t.setHeader("Content-Type","application/json"),t.send(JSON.stringify(balance)),t.end()}),app.get("/getProfile",function(e,t){t.setHeader("Content-Type","application/json"),t.send(JSON.stringify(profile)),t.end()}),app.post("/scan",function(e,t){}),app.get("/admin",function(e,t){var a=upstox.getLoginUri(redirect_uri);log("*loginUri "+a),t.status(200).header("Content-type","text/html"),code=e.params.code,t.status(302).setHeader("Location",a),t.end()}),app.use(function(e,t,a){t.status(404).send("Sorry, that route doesn't exist. Have a nice day :)")}),app.listen(PORT,function(){log("App listening on port "+PORT)});var date,rsi,sma,bb,bankNiftyCall,technicalindicators=require("technicalindicators"),days=(fs=require("fs"),months=["January","February","March","April","May","June","July","August","September","October","November","December"],today=(date=new Date).getDate()+"-"+(date.getMonth()+1)+"-"+date.getFullYear(),time=date+":"+date.getHours()+":"+date.getMinutes(),["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]),strategyObj={symbol:"BANKNIFTY19JANFUT",indicators:[{indicator:"rsi",settings:"14",value:"60",op:">="},{indicator:"sma",settings:"20",value:"close",op:">="}],interval:"15min"};function backTesting(e,t){e.filter(function(e){return 60<=e.rsi}).filter(function(e){return e.close>=e.sma})}function getList(e){for(var t=0,a=e;t<a.length;t++){var n=a[t];if(n){rsi=new technicalindicators.RSI({values:[],period:14});sma=new technicalindicators.SMA({values:[],period:20});bb=new technicalindicators.BollingerBands({period:14,values:[],stdDev:2});var s="data/stock/1day/"+(n.symbol?n.symbol:n)+".txt";fs.access(s,fs.constants.F_OK|fs.constants.R_OK,function(e){e?console.error(s+" "+("ENOENT"===e.code?"does not exist":"is read-only")):(console.log(s+" exists, and it is Readable"),fs.readFile(s,"utf8",function(e,t){if(e)throw e;if(""!=t&&null!=t&&null!=t){var a=JSON.parse(t),n=dataForge.fromJSON(JSON.stringify(a.data)).dropSeries(["cp"]).where(function(e){return calculateIndicators(e)}).select(function(e){return transform(e)}),o=(n.reverse(),n.toJSON());log("data >> "+s+"  n \n "+o)}}))})}}}function mappedFunction(){}function transform(e){return e.timestamp=new Date(e.timestamp),e}function searchPattern(e){var t=new Date,a=months[t.getMonth()].slice(0,3).toUpperCase(),n=new RegExp(a,"gi"),o=e.split(",");if(0<=String(o[3]).search(/BANKNIFTY/i)){for(var s=!1,r=String(o[3]).search(n),i=String(o[3]).search("FUT"),l=0;l<7;l++){if("Thursday"==days[t.getDay()]||"Wednesday"==days[t.getDay()]){var c=t.getFullYear(),u=t.getMonth()+1,d=t.getDate();d=String(d).length<2?"0"+t.getDate():t.getDate();var g="BANKNIFTY"+String(c).slice(2,4)+u+d,p=100*Math.round(o[2]/100),f=new RegExp(String(p),"gi"),m=String(o[3]).search(f);if(0<=String(o[3]).search(g)&&0<=m){var b=String(o[3]).search("CE"),y=String(o[3]).search("PE");console.log("\n MATCH "+b+" > "+y+" > "+o[3]),0<b?bankNiftyCall.CE=o[3]:0<y&&(bankNiftyCall.PE=o[3]),s=!0}}t.setDate(t.getDate()+1)}return s?e:0<=r&&0<=i?(bankNiftyCall.FUTURE=o[3],e):0}return 0}function calculateIndicators(e){return e.rsi=rsi.nextValue(Number(e.close)),e.sma=sma.nextValue(Number(e.close)),e.bb=bb.nextValue(Number(e.close)),e}function log(t){if("production"!=process.env.NODE_ENV){date=new Date,today=date.getDate()+"-"+(date.getMonth()+1)+"-"+date.getFullYear(),time=today+":"+date.getHours()+":"+date.getMinutes();var a="logs/log-"+today+".txt";try{fs.existsSync(a)?fs.appendFile(a,"\n"+date+" "+t,function(e){if(e)throw e}):fs.writeFile(a,"\n"+date+" "+t,function(e){if(e)throw e})}catch(e){console.error(e),fs.writeFile(a,"\n"+date+" "+t,function(e){if(e)throw e})}}}function addIndicators(e,t){for(var a=e.data,n=0,o=a;n<o.length;n++){return(h=l=o[n]).timestamp=new Date(h.timestamp),h}for(var s=[],r=0,i=a;r<i.length;r++){var l=i[r];s.push(l.close)}for(var c={values:s,period:14},u=technicalindicators.RSI.calculate(c),d={values:s,period:20},g=technicalindicators.SMA.calculate(d),p={period:14,values:s,stdDev:2},f=technicalindicators.BollingerBands.calculate(p),m=0,b=0,y=a;b<y.length;b++){var h;return(h=l=y[b]).rsi=c.period<m?u[m-c.period]:0,h.sma=d.period<=m?g[m-d.period]:0,h.bb=p.period<=m?f[m-p.period]:null,m++,h}backTesting(a,t)}function checkBankNiftyExpiry(){bankNiftyCall=new Object,fs.readFile("data/index/nse_fo.txt",function(e,t){var a=JSON.parse(t).data,n=new dataForge.DataFrame(a).where(function(e){return searchPattern(e)}).toArray();console.log("WATCH BANK NIFTY  ****** "+JSON.stringify(bankNiftyCall)),log(" \n \n BANK NIFTY >> data >>"+n)})}upstox=new(Upstox=require("upstox"))(api="cIs71szuLZ7WFKInU8O0o7GTHm5QIJke8ahnzLVw"),fs=require("fs"),months=["January","February","March","April","May","June","July","August","September","October","November","December"];var Upstox,api,accessToken,code="",__dirname="views",exchanges=["MCX_FO","BSE_EQ","NSE_EQ","NSE_FO","NCD_FO"],login_code="ce728b73424e719680aa66a51ba4eb469f9875f2",api_secret="xs5ibb0pk0",client_id="",watchList=["banknifty","hindalco","ICICIBANK","sbin","idea","lt","HAVELLS"];function getAcceToken(t){var a={apiSecret:api_secret,code:t,grant_type:"authorization_code",redirect_uri:redirect_uri};upstox.getAccessToken(a).then(function(e){a=api_secret=t=null,log("****accessToken*\n"+(accessToken=e.access_token)),upstox.setToken(accessToken),start()}).catch(function(e){log("getAccessToken > "+e)})}function start(){var s;getProfile(),upstox.getMasterContract({exchange:"nse_fo"}).then(function(e){s=new Object;csvTojs(e.data);var t=new Date,a=months[t.getMonth()].slice(0,3).toUpperCase(),n=new RegExp(a,"gi"),o=JSON.parse(JSON.stringify(o));dataForge.fromJSON(o).where(function(e){e=JSON.stringify(e);var t=String(e.symbol).search(n),a=String(e.symbol).search("FUT");if(0<=t&&0<=a)return console.log("\n \n MATCH  >> > "+e.symbol),s.FUTURE=e.symbol,e});log("FNO data >> \n \n"+o),fs.writeFile("data/index/nse_fo.txt",JSON.stringify(e),function(e){if(e)throw e;console.log("nse_fo File is created successfully.")}),checkBankNiftyExpiry()}).catch(function(e){console.log("nse fo error "+JSON.stringify(e))}),upstox.getMasterContract({exchange:"NSE_INDEX",format:"json"}).then(function(e){fs.writeFile("data/index/index.txt",JSON.stringify(e),function(e){if(e)throw e;log("index File is created successfully.")})}).catch(function(e){log(e)}),upstox.connectSocket().then(function(){upstox.on("orderUpdate",function(e){log("orderUpdate"+e)}),upstox.on("positionUpdate",function(e){log("positionUpdate"+e)}),upstox.on("tradeUpdate",function(e){log("tradeUpdate"+e)});var e=niftyList.join();upstox.subscribeFeed({exchange:"nse_eq",symbol:e,type:"ltp"}).then(function(e){console.log("feedsymbols subscribeFeed response ",e)}).catch(function(e){console.log("Error in subscribe feed ",e)}),upstox.on("liveFeed",function(e){log("liveFeed"+e)}),upstox.on("disconnected",function(e){log("disconnected > "+e)}),upstox.on("error",function(e){log("error"+e)})}).catch(function(e){log("connectSocket #"+e)})}var balance,profile,nseSymbolList=[];function getListOfAllSymbol(){upstox.getMasterContract({exchange:"nse_eq",format:"json"}).then(function(e){var t=e.data;nseSymbolList=t.map(function(e){return e.symbol}),getAllData()}).catch(function(e){log("Error getListOfAllSymbol > "+e),getAllData()})}function getBalance(){upstox.getBalance({type:"security"}).then(function(e){balance=JSON.stringify(e),getListOfAllSymbol()}).catch(function(e){log(e),getListOfAllSymbol()})}function getProfile(){upstox.getProfile().then(function(e){client_id=e.data.client_id,profile=JSON.stringify(e.data),getBalance()}).catch(function(e){log("Error"+e)})}function getMaster(e){if(void 0===e&&(e="nse_fo"),accessToken)return upstox.getMasterContract({exchange:e})}function loadSymbol(e,t,a,n){if(void 0===a&&(a="1day"),void 0===n&&(n="12-12-2018"),log("loadSymbol > "+e+" > "+a+" > "+t+" > "+n),accessToken)return upstox.getOHLC({exchange:t,symbol:e,start_date:n,format:"json",interval:a})}function getAllData(){}function syncStockData(){delay(10).then(function(){return load5minData()}),delay(1e4).then(function(){return load10minData()}),delay(2e4).then(function(){return load30minData()}),delay(3e4).then(function(){return load60minData()}),delay(6e4).then(function(){return load1dayData()})}var delay=function(t){return new Promise(function(e){return setTimeout(e,t)})},data=(stockData=[],{}),promiseArr=[];function loadAllSymbolData(t,n,o){return void 0===n&&(n="1DAY"),void 0===o&&(o="11-11-2018"),__awaiter(this,void 0,void 0,function(){var a=this;return __generator(this,function(e){return promiseArr=[],promiseArr=t.map(function(t){return __awaiter(a,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return data={},stockData=[],console.log("symbol "+n+" >> "+t+" >> "+o),[4,loadSymbol(t,"nse_eq",n,o).then(function(e){(stockData=e.data).map(function(e){return e.timestamp=new Date(e.timestamp),e.rsi=rsi.nextValue(Number(e.close)),e.sma=sma.nextValue(Number(e.close)),e.bb=bb.nextValue(Number(e.close)),Number(e.close)>e.bb.upper?e.bb.isCrossed="Crossed Above":Number(e.close)<e.bb.lower?e.bb.isCrossed="Crossed Below":e.bb.isCrossed="",e}),stockData.reverse(),data={symbol:t,close:stockData[0].close,volume:stockData[0].volume,rsi:stockData[0].rsi,timestamp:stockData[0].timestamp,sma:stockData[0].sma,bb:stockData[0].bb},stockData=null}).catch(function(e){console.log("loadSymbol error > "+JSON.stringify(e))})];case 1:return e.sent(),t=null,[2,data]}})})}),[2,Promise.all(promiseArr).then(function(e){return e.filter(Boolean)})]})})}function csvTojs(e){for(var t=e,a=[],n=t[0].split(","),o=1;o<t.length;o++){var s={},r=t[o],i=0,l=0,c=0;if(""!==r.trim()){for(;c<r.length;){var u=r[c];if('"'===u)for(;'"'!==(u=r[++c])&&c<r.length-1;);if(","===u||c===r.length-1){var d=r.substr(l,c-l).trim();'"'===d[0]&&(d=d.substr(1)),","===d[d.length-1]&&(d=d.substr(0,d.length-1)),'"'===d[d.length-1]&&(d=d.substr(0,d.length-1)),s[n[i++]]=d,l=c+1}++c}a.push(s)}}return a}