var chalk=require("chalk");const sqlite3=require("sqlite3").verbose();let db=new sqlite3.Database("db/upstox.db",e=>e?console.error(e.message):void console.log(chalk.green("Connected to the in-memory SQlite database.")));function closeDb(){db.close()}function insertDB(e,t){return new Promise(function(o){db.run(e,t,function(e){e?console.log(chalk.red("Insert error > "+e)):(console.log(chalk.blue("Successfully inserted")),o("success"))})})}async function getFirst(e,t){return new Promise(function(o,a){db.get(e,t,function(e,t){e?a("Read error: "+e.message):o(t)})})}const nodemailer=require("nodemailer");var transporter=nodemailer.createTransport({service:"gmail",auth:{user:"satish.patel41@gmail.com",pass:"Pratiksha@123"}});let mailOptions={from:'"Admin" <satish.patel41@gmail.com>',to:"satish.patel41@yahoo.com",subject:"Call Generated",text:"Alert for",html:'<p><b>Hello</b> Alert triggered on Wed Nov 7, 6:00 pm</p><p>Here\'s a nyan cat for you as an embedded attachment:<br/><img src="cid:nyan@example.com"/></p>',attachments:[{filename:"notes.txt",content:"Some notes about this e-mail",contentType:"text/plain"}],list:{help:"admin@example.com?subject=help",unsubscribe:[{url:"http://example.com/unsubscribe",comment:"A short note about this url"},"unsubscribe@example.com"],id:{url:"mylist.example.com",comment:"This is my awesome list"}}};function sendingMail(){transporter.sendMail(mailOptions,(e,t)=>e?console.log(e):(console.log("Message sent: %s",t.messageId),void console.log("Preview URL: %s",nodemailer.getTestMessageUrl(t))))}const SMA=require("technicalindicators").SMA,EMA=require("technicalindicators").EMA,RSI=require("technicalindicators").RSI,BB=require("technicalindicators").BollingerBands,ADL=require("technicalindicators").ADL,ADX=require("technicalindicators").ADX,ATR=require("technicalindicators").ATR,MACD=require("technicalindicators").MACD;function getIndicator(symbol,stockData,strategyList,isBackTesting){var closes=[],opens=[],highs=[],lows=[],timestamps=[],values=stockData.map(e=>{closes.push(e.close),opens.push(e.open),highs.push(e.high),lows.push(e.low),timestamps.push(e.timestamp)});timestamps=timestamps.reverse(),Promise.all(strategyList.map(strategyObj=>new Promise(function(resolved,rejected){var result=[],output=[];Promise.all(strategyObj.indicators.map(indicatorObj=>new Promise(function(resolve,reject){try{indicatorObj.values=eval(indicatorObj.values);var str=indicatorObj.indicator+".calculate("+JSON.stringify(indicatorObj)+")",res=eval(str),op=isBackTesting?res.reverse():res.reverse().slice(0,3);return output.push(op),resolve(output)}catch(e){reject(e)}}))).then(obj=>{if(isBackTesting){closes=closes.reverse();for(var strategyRes=[],i=0;i<output[0].length;i++){result.push(eval(strategyObj.strategy));var india=moment.tz(new Date(+timestamps[i]),"Asia/Kolkata");india.format();var d=india.date()+"/"+(india.month()+1)+"/"+india.year()+" "+india.hour()+":"+india.minute();strategyRes.push(result.every(e=>1==e)),console.log("\n"+symbol+" > "+strategyObj.strategy+" :: "+d+"  > "+closes[i]+"::"+output[0][i])}return closes=closes.reverse(),output=result=null,console.log("*****strategyRes "+strategyRes),resolved(strategyRes)}closes=closes.reverse(),result.push(eval(strategyObj.strategy)),closes=closes.reverse();var d=new Date(+timestamps[0]),strategyRes=result.every(e=>1==e);return output=result=null,resolved(strategyRes)}).catch(e=>{rejected(e),console.log("INNER LOOP : "+e)})}))).then(e=>{var t=e.every(e=>1==e);console.log("%%% strategy RESULT  > "+symbol+" > "+t+" >> "+JSON.stringify(e)),closes=opens=highs=lows=timestamps=e=null}).catch(e=>{console.log("OUTER LOOP ERROR > "+e)})}Array.prototype.insert=function(e,...t){return this.slice(0,e).concat(t,this.slice(e))};var list,cron=require("node-cron"),chalk=require("chalk");function load1dayData(){var e=niftyList,t=new Date;t.setDate(t.getDate()-21);var o=t.getDate()+"-"+(t.getMonth()+1)+"-"+t.getFullYear(),a="1DAY";store.get("accessToken")&&loadAllSymbolData(e,a,o).then(function(o){0<o.length&&store.set("data1day",o),e=t=a=null,console.log("NSE 1 day data update")}).catch(function(e){console.log("load1dayData/ error > "+JSON.stringify(e))})}function load60minData(){var e=niftyList,t=new Date;t.setDate(t.getDate()-5);var o=t.getDate()+"-"+(t.getMonth()+1)+"-"+t.getFullYear(),a="60MINUTE";store.get("accessToken")&&loadAllSymbolData(e,a,o).then(function(o){0<o.length&&store.set("data60",o),e=t=a=null,console.log("NSE 60MINUTE data update")}).catch(function(e){console.log("load60minData/ error > "+JSON.stringify(e))})}function load30minData(){var e=niftyList,t=new Date;t.setDate(t.getDate()-4);var o=t.getDate()+"-"+(t.getMonth()+1)+"-"+t.getFullYear(),a="30MINUTE";store.get("accessToken")&&loadAllSymbolData(e,a,o).then(function(o){0<o.length&&store.set("data30",o),e=t=a=null,console.log("NSE 30MINUTE data update")}).catch(function(e){console.log("load30minData/ error > "+JSON.stringify(e))})}function load10minData(){var e=niftyList,t="10MINUTE",o=new Date;o.setDate(o.getDate()-3);var a=o.getDate()+"-"+(o.getMonth()+1)+"-"+o.getFullYear();store.get("accessToken")&&loadAllSymbolData(e,t,a).then(function(a){0<a.length&&store.set("data10",a),e=o=t=null,console.log("NSE 10MINUTE data update")}).catch(function(e){console.log("load10minData/ error > "+JSON.stringify(e))})}function load5minData(){var e=niftyList,t=new Date;t.setDate(t.getDate()-3);var o=t.getDate()+"-"+(t.getMonth()+1)+"-"+t.getFullYear(),a="5MINUTE";store.get("accessToken")&&loadAllSymbolData(e,a,o).then(function(o){0<o.length&&store.set("data5",o),e=t=a=null,console.log("NSE 5 MINUTE data update")}).catch(function(e){console.log("load5minData/ error > "+o+" >> "+JSON.stringify(e))})}function load3minData(){var e=niftyList,t=new Date;t.setDate(t.getDate()-3);var o=t.getDate()+"-"+(t.getMonth()+1)+"-"+t.getFullYear(),a="3MINUTE";store.get("accessToken")&&loadAllSymbolData(e,a,o).then(function(o){0<o.length&&store.set("data3",o),console.log("NSE 3 MINUTE data update"),e=t=a=null}).catch(function(e){console.log("load3minData/ error > "+o+" >> "+JSON.stringify(e))})}function load15minData(){var e=niftyList,t=new Date;t.setDate(t.getDate()-3);var o=t.getDate()+"-"+(t.getMonth()+1)+"-"+t.getFullYear(),a="15MINUTE";store.get("accessToken")&&loadAllSymbolData(e,a,o).then(function(o){0<o.length&&store.set("data15",o),e=t=a=null,console.log("NSE 15 MINUTE data update")}).catch(function(e){console.log("load15minData/ error > "+o+" >> "+JSON.stringify(e))})}cron.schedule("*/10 * * * *",()=>{load10minData(),console.log(chalk.blue("running a task every 10 minutes"))},{scheduled:!0,timezone:"Asia/Kolkata"}),cron.schedule("*/15 * * * *",()=>{load15minData(),console.log(chalk.blue("running a task every 15 minutes"))},{scheduled:!0,timezone:"Asia/Kolkata"}),cron.schedule("*/30 * * * *",()=>{load30minData(),console.log(chalk.blue("running a task every 30 minutes"))},{scheduled:!0,timezone:"Asia/Kolkata"}),cron.schedule("0 */1 * * *",()=>{load60minData(),console.log(chalk.blue("running a task every 1 hour"))},{scheduled:!0,timezone:"Asia/Kolkata"}),cron.schedule("59 23 * * *",()=>{store.unlink(),console.log(chalk.yellow("Clean cache data"))},{scheduled:!0,timezone:"Asia/Kolkata"}),cron.schedule("0 17 * * *",()=>{load1dayData(),console.log(chalk.blue("running a task every 1 day"))},{scheduled:!0,timezone:"Asia/Kolkata"});var express=require("express"),compression=require("compression"),moment=require("moment-timezone"),bodyParser=require("body-parser"),chalk=require("chalk"),fs=require("fs"),url=require("url"),cluster=require("cluster");const dataForge=require("data-forge");var session=require("express-session"),FileStore=require("session-file-store")(session);const Store=require("data-store");var async=require("async");const querystring=require("querystring"),store=new Store({path:"config.json"});require("data-forge-fs");var Upstox=require("upstox"),api="cIs71szuLZ7WFKInU8O0o7GTHm5QIJke8ahnzLVw",upstox=new Upstox(api);const PORT=process.env.PORT||8080;var redirect_uri="http://localhost:"+PORT,nifty="https://www.nseindia.com/content/indices/ind_nifty50list.csv",fno="https://www.nseindia.com/content/fo/fo_mktlots.csv";"production"==process.env.NODE_ENV&&(api="cIs71szuLZ7WFKInU8O0o7GTHm5QIJke8ahnzLVw",redirect_uri="https://robo-trader.herokuapp.com/");var numReqs=0;if(cluster.isMaster){console.log(chalk.green("cpus 1"));for(var worker,i=0;i<1;i++)worker=cluster.fork(),worker.on("message",function(){});cluster.on("death",function(e){console.log(chalk.red("worker "+e.pid+" died"))})}else{function a(e,t,o){e.session.user?o():(console.log(chalk.blue(JSON.stringify(e.session)+" session \n"+e.session.user)),t.sendFile("login.html",{root:__dirname}))}function b(){var e={values:[],period:14};rsi=new technicalindicators.RSI(e);var t={values:[],period:20};sma=new technicalindicators.SMA(t);var o={period:14,values:[],stdDev:2};bb=new technicalindicators.BollingerBands(o),o=e=t=null}var app=express();app.use(express.static("public")),app.use(compression()),app.use(bodyParser.json()),app.use(bodyParser.urlencoded({extended:!0})),app.use(session({store:new FileStore({path:"./session-store"}),name:"_fs_cookie",resave:!1,saveUninitialized:!1,secret:"00777",cookie:{maxAge:36e5}})),app.use(function(e,t,o){t.header("Access-Control-Allow-Origin","*"),t.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept"),o()});var months=["January","February","March","April","May","June","July","August","September","October","November","December"],date=new Date,today=date.getDate()+"-"+(date.getMonth()+1)+"-"+date.getFullYear(),time=date+":"+date.getHours()+":"+date.getMinutes(),fnoArr=dataForge.readFileSync("data/list/fo_mktlots.csv").parseCSV().toArray(),fnoList=[];fnoArr.forEach(function(e){e.SYMBOL&&fnoList.push(e.SYMBOL)}),store.set("fnoList",fnoList);var niftyList=dataForge.readFileSync("data/list/ind_nifty50list.csv").parseCSV().toArray();niftyList=niftyList.map(e=>e.Symbol),store.set("niftyList",niftyList),app.get("/",function(e,t){var o=url.parse(e.url,!0).query;code=o.code,console.log(chalk.green("session > "+JSON.stringify(e.session.cookie))),code?(getAcceToken(code),t.sendFile("index.html",{root:__dirname})):t.sendFile("index.html",{root:__dirname}),o=null}),app.get("/welcome",a,function(e,t){t.send("<b>Hello</b> welcome to my http server made with express")}),app.get("/login",function(e,t){t.sendFile("login.html",{root:__dirname})}),app.get("/logout",function(e,t){e.session.destroy(function(){console.log(chalk.blue("user logged out."))}),t.redirect("/login")}),app.post("/login",function(e,t){var o=e.body.username,a=e.body.password;o?getFirst("select * from User where email=? and password=?",[o,a]).then(o=>{console.log("result > "+JSON.stringify(o)),null==o?t.send("error"):(console.log(chalk.green("Login token > "+store.get("accessToken"))),e.session.user=o,t.send(o))}):t.sendFile("login.html",{root:__dirname})}),app.get("/signup",function(e,t){t.sendFile("signup.html",{root:__dirname})}),app.post("/signup",function(e,t){var o=e.body.email,a=e.body.psw,s=e.body.mobile,n=e.body.name;e.body.pswRepeat;if(o){var r=!1;getFirst(i="select * from User where email=?",l=[o]).then(e=>{console.log("result > "+JSON.stringify(e)),null==e||(t.send("error"),r=!0)});var i="INSERT INTO User (name,mobile,email,password)VALUES(?,?,?,?)",l=[n,s,o,a];console.log(i+"> "+l),r||insertDB(i,l).then(e=>{console.log("result > "+JSON.stringify(e)),"success"==e?t.send("success"):t.send("error")})}else t.sendFile("signup.html",{root:__dirname})}),app.get("/contactus",a,function(e,t){t.sendFile("contactus.html",{root:__dirname})}),app.get("/index",a,function(e,t){t.sendFile("index.html",{root:__dirname})}),app.get("/scan",a,function(e,t){t.sendFile("scanner.html",{root:__dirname})}),app.get("/strategy",a,function(e,t){t.sendFile("strategy.html",{root:__dirname})}),app.get("/gainerloser",a,function(e,t){t.sendFile("gainerloser.html",{root:__dirname})});var lastObject={open:"",close:"",low:"",high:"",volume:"",timestamp:"",rsi:"",sma:"",bb:{upper:"",lower:"",isCrossed:"",middel:"",pb:""}},stockData=[];app.post("/createStrategy",a,function(e,t){var o=JSON.parse(e.body.data),a=o.uid,s=o.name,n=o.symbol,r=o.exchange,i=o.orderType,l=o.symbolToBuySell,c=o.interval;insertDB("INSERT INTO Strategy (uid,name,symbol,exchange,orderType,symbolToBuySell,interval)VALUES(?,?,?,?,?,?,?)",[a,s,n,r,i,l,c]).then(e=>{"success"==e?getFirst("select sid from Strategy where uid=?",[a]).then(e=>{if(null==e.sid)t.send("error");else{console.log(e.sid);var a=e.sid;o.indicators.map(async e=>{var t=e.indicator,o=e.settings,s=e.value,n=e.op;insertDB("INSERT INTO Indicators (sid,indicator,settings,value,op)VALUES(?,?,?,?,?)",[a,t,o,s,n]).then(e=>{console.log("result > "+JSON.stringify(e))})}),t.send("success")}}):t.send("error")});var u=new Date;"5MINUTE"==c?u.setDate(u.getDate()-2):"3MINUTE"==c?u.setDate(u.getDate()-1):"15MINUTE"==c?u.setDate(u.getDate()-2):"10MINUTE"==c?u.setDate(u.getDate()-3):"30MINUTE"==c?u.setDate(u.getDate()-4):"60MINUTE"==c?u.setDate(u.getDate()-4):"1DAY"==c?u.setDate(u.getDate()-20):"1WEEK"==c?u.setDate(u.getDate()-140):"1MONTH"==c&&u.setMonth(u.getMonth()-20);var d=u.getDate()+"-"+(u.getMonth()+1)+"-"+u.getFullYear();b(),stockData=[],loadSymbol(o.symbol,o.exchange,c,d).then(function(e){t.setHeader("Content-Type","application/json"),stockData=e.data,lastObject={open:"",close:"",low:"",high:"",volume:"",timestamp:"",rsi:"",sma:"",bb:{upper:"",lower:"",isCrossed:"",middel:"",pb:""}},stockData.map(e=>{var t=moment.tz(new Date(+e.timestamp),"Asia/Kolkata");return t.format(),e.timestamp=t.date()+"/"+(t.month()+1)+"/"+t.year()+" "+t.hour()+":"+t.minute(),e.rsi=rsi.nextValue(+e.close),e.sma=sma.nextValue(+e.close),e.bb=bb.nextValue(+e.close),lastObject=e,e}),stockData.reverse();for(var a={symbol:o.symbol,close:stockData[0].close,volume:stockData[0].volume,rsi:stockData[0].rsi,timestamp:stockData[0].timestamp,sma:stockData[0].sma,bb:stockData[0].bb},s=!1,n=0;n<o.indicators.length;n++){var r=o.indicators[n].op,i=a[o.indicators[n].indicator],l=o.indicators[n].value,c=!1;"<"==r?c=i<l:">"==r?c=i>l:"<="==r?c=i<=l:">="==r?c=i>=l:"=="==r&&(c=i==l),c&&(s=!0),console.log("isMatch :> "+s)}if(s){var u={transaction_type:o.orderType,exchange:o.exchange,symbol:o.symbolToBuySell,quantity:1,order_type:"m"};upstox.placeOrder(u).then(function(e){console.log(e)}).catch(function(e){console.log(chalk.red(e))})}console.log("Result "+JSON.stringify(a)),t.send(JSON.stringify(a)),stockData=null,t.end()}).catch(function(e){console.log("createStrategy error > "+JSON.stringify(e))})}),app.get("/loadSymbol/:symbol/:interval",a,function(e,t){console.log("params: "+JSON.stringify(e.params));var o=e.params.symbol,a=e.params.interval,s=new Date;"5MINUTE"==a?s.setMinutes(s.getMinutes()-100):"3MINUTE"==a?s.setMinutes(s.getMinutes()-60):"10MINUTE"==a?s.setMinutes(s.getMinutes()-200):"15MINUTE"==a?s.setMinutes(s.getMinutes()-300):"30MINUTE"==a?s.setMinutes(s.getMinutes()-600):"60MINUTE"==a?s.setMinutes(s.getMinutes()-1200):"1DAY"==a?s.setDate(s.getDate()-20):"1WEEK"==a?s.setDate(s.getDate()-140):"1MONTH"==a?s.setMonth(s.getMonth()-20):s.setDate(s.getDate()-20);var n=s.getDate()+"-"+(s.getMonth()+1)+"-"+s.getFullYear();console.log("start_date > "+a+" >> "+n);var r={values:[],period:14},i=new technicalindicators.RSI(r),l={values:[],period:20},c=new technicalindicators.SMA(l),u={period:14,values:[],stdDev:2},d=new technicalindicators.BollingerBands(u);u=r=l=null,stockData=[],loadSymbol(o,"nse_eq",a,n).then(function(e){t.setHeader("Content-Type","application/json"),stockData=e.data,lastObject={open:"",close:"",low:"",high:"",volume:"",timestamp:"",rsi:"",sma:"",bb:{upper:"",lower:"",isCrossed:"",middel:"",pb:""}},stockData.map(e=>{return moment.tz(new Date(+e.timestamp),"Asia/Kolkata").format(),e.rsi=i.nextValue(+e.close),e.sma=c.nextValue(+e.close),e.bb=d.nextValue(+e.close),e&&e.bb&&+e.close>=+e.bb.upper?e.bb.isCrossed="Crossed Above":e&&e.bb&&+e.close<=+e.bb.lower&&(e.bb.isCrossed="Crossed Below"),lastObject=e,e}),stockData.reverse(),t.send(JSON.stringify(stockData)),stockData=null,t.end()}).catch(function(o){if(401==o.code){accessToken="",store.set("accessToken",accessToken);var a=upstox.getLoginUri(redirect_uri);t.status(200).header("Content-type","text/html"),code=e.params.code,t.status(302).setHeader("Location",a),t.end()}console.log("/loadSymbol/:symbol/:interval error > "+JSON.stringify(o))})}),app.get("/getFutureContract/:exchange",a,function(e,t){var o=e.params.exchange;fs.readFile("data/index/nse_fo.txt","utf8",function(e,a){var s=csvTojs(JSON.parse(a).data).filter(e=>e.instrument_type+""===o).map(e=>e.symbol);t.setHeader("Content-Type","application/json"),t.send(s),t.end()})});var result=[],map=new Map;app.get("/loadAllSymbolData/:interval/:exchange",a,function(e,t){console.log("params: "+JSON.stringify(e.params));var o=e.params.interval,a=e.params.exchange,s=[];s="nifty"==a?store.get("niftyList"):"fno"==a?store.get("fnoList"):store.get("nseSymbolList");var n=[];if("5MINUTE"==o?n=store.get("data5"):"3MINUTE"==o?n=store.get("data3"):"10MINUTE"==o?n=store.get("data10"):"15MINUTE"==o?n=store.get("data15"):"30MINUTE"==o?n=store.get("data30"):"60MINUTE"==o?n=store.get("data60"):"1DAY"==o?n=store.get("data1day"):"1WEEK"==o?n=store.get("data1week"):"1MONTH"==o&&(n=store.get("data1month")),n&&null!=n&&0<n.length&&n.filter(function(e){return null!=e&&null!=e.close&&null!=e.close&&""!=e.close}),n&&0<n.length&&n[0])t.setHeader("Content-Type","application/json"),t.send(JSON.stringify(n)),t.end();else{console.log("*No data available "+o+" Fetch it.");var r=new Date;"5MINUTE"==o?r.setDate(r.getDate()-2):"3MINUTE"==o?r.setDate(r.getDate()-2):"10MINUTE"==o?r.setDate(r.getDate()-3):"15MINUTE"==o?r.setDate(r.getDate()-3):"30MINUTE"==o?r.setDate(r.getDate()-4):"60MINUTE"==o?r.setDate(r.getDate()-4):"1DAY"==o?r.setDate(r.getDate()-30):"1WEEK"==o?r.setDate(r.getDate()-140):"1MONTH"==o&&r.setMonth(r.getMonth()-20);var i=r.getDate()+"-"+(r.getMonth()+1)+"-"+r.getFullYear();loadAllSymbolData(s,o,i).then(function(e){console.log("\n loadAllSymbolData **"+JSON.stringify(e));"5MINUTE"==o?store.set("data5",e):"3MINUTE"==o?store.set("data3",e):"10MINUTE"==o?store.set("data10",e):"15MINUTE"==o?store.set("data15",e):"30MINUTE"==o?store.set("data30",e):"60MINUTE"==o?store.set("data60",e):"1DAY"==o?store.set("data1day",e):"1WEEK"==o?store.set("data1week",e):"1MONTH"==o&&store.set("data1month",e),t.setHeader("Content-Type","application/json"),t.send(JSON.stringify(e)),a=s=o=null,t.end()}).catch(function(e){console.log("loadAllSymbolData/ error > "+JSON.stringify(e))})}}),app.get("/getListOfAllSymbol",a,function(e,t){t.setHeader("Content-Type","application/json"),0<(fnoList=store.get("fnoList")).length?t.send(JSON.stringify(fnoList)):t.send(JSON.stringify(getListOfAllSymbol())),t.end()}),app.get("/sync",a,function(e,t){syncStockData(),t.setHeader("Content-Type","application/json"),t.send("Successfully sync data !"),t.end()}),app.get("/getBalance",function(e,t){t.setHeader("Content-Type","application/json"),t.send(JSON.stringify(balance)),t.end()}),app.get("/getProfile",function(e,t){t.setHeader("Content-Type","application/json"),t.send(JSON.stringify(profile)),t.end()}),app.post("/scan",function(){}),app.get("/admin",a,function(e,t){var o=moment.tz(store.get("tokenValidity"),"Asia/Kolkata"),a=new Date,s=moment.tz(a,"YYYY-DD-MM HH:mm","Asia/Kolkata");if(s.format(),console.log("tokenValidity "+s+":"+o+":"+o.isBefore(s)),o.isBefore(s)&&(accessToken="",store.set("accessToken",accessToken)),store.get("accessToken")&&""!=store.get("accessToken"))accessToken=store.get("accessToken"),upstox.setToken(accessToken),getListOfAllSymbol(),t.sendFile("index.html",{root:__dirname});else{var n=upstox.getLoginUri(redirect_uri);console.log("*loginUri "+n),t.status(200).header("Content-type","text/html"),code=e.params.code,t.status(302).setHeader("Location",n),t.end()}}),app.use(function(e,t){t.status(404).send("Sorry, that route doesn't exist. Have a nice day :)")}),app.listen(PORT,function(){console.log("App listening on port "+PORT)})}cluster.on("exit",function(e){console.log("Worker %d died :(",e.id),cluster.fork()});var technicalindicators=require("technicalindicators"),fs=require("fs"),path=require("path"),moment=require("moment-timezone"),months=["January","February","March","April","May","June","July","August","September","October","November","December"],date=new Date,today=date.getDate()+"-"+(date.getMonth()+1)+"-"+date.getFullYear(),time=date+":"+date.getHours()+":"+date.getMinutes(),days=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],strategyObj={symbol:"BANKNIFTY19JANFUT",indicators:[{indicator:"rsi",settings:"14",value:"60",op:">="},{indicator:"sma",settings:"20",value:"close",op:">="}],interval:"15min"};function backTesting(e){e.filter(function(e){return 60<=e.rsi}).filter(function(e){return e.close>=e.sma})}function mappedFunction(){}function transform(e){if(0<e.timestamp){var t=new Date(+e.timestamp),o=moment.tz(t,"DD-MM-YYYY HH:mm","Asia/Kolkata");o.format()}return e.timestamp=o,e}var index=0,buyprice=0,sellprice=0,profit=0,totalProfit=0,isBuySignalGenerated=!1,isSellSignalGenerated=!1,buyCall=0,sellCall=0;function calculateIndicators(e){e.rsi=rsi.nextValue(+e.close),e.sma=sma.nextValue(+e.close),e.bb=bb.nextValue(+e.close);var t=new Date(+e.timestamp),o=moment.tz(t,"DD-MM-YYYY HH:mm","Asia/Kolkata");return o.format(),e.date=o.date()+"/"+(o.month()+1)+"/"+o.year()+" "+o.hour()+":"+o.minute(),9==o.hour()&&25==o.minute()&&e.bb&&e.close>e.bb.upper&&(buyCall++,buyprice=e.close,isBuySignalGenerated=!0,console.log("\n\n BUY *>> "+e.date+" >> "+buyprice)),isBuySignalGenerated?e.bb&&e.close<=e.bb.middle&&(isBuySignalGenerated=!1,profit=e.close-buyprice,totalProfit+=profit,console.log("\n\n EXIT CALL *>> "+e.date+" close >> "+e.close+" profit>> "+profit+" totalProfit >> "+totalProfit+">>"+buyCall)):isSellSignalGenerated&&(40<obj.rsi||e.close>obj.sma)&&(isSellSignalGenerated=!1,profit=sellprice-e.close,totalProfit+=profit,console.log("\n\n EXIT SELL *>> "+e.date+" close >> "+e.close+" profit>> "+profit+" totalProfit >> "+totalProfit+">>"+sellCall)),index++,e}function log(e){if("production"!=process.env.NODE_ENV){date=new Date;var t="logs/log-"+(today=date.getDate()+"-"+(date.getMonth()+1)+"-"+date.getFullYear())+".txt";try{fs.existsSync(t)?fs.appendFile(t,"\n"+date+" "+e,function(e){if(e)throw e}):fs.writeFile(t,"\n"+date+" "+e,function(e){if(e)throw e})}catch(o){console.error(o),fs.writeFile(t,"\n"+date+" "+e,function(e){if(e)throw e})}}}function addIndicators(e,t){var o=e.data;for(let e of o){return(s=e).timestamp=new Date(s.timestamp),s}var a=[];for(let e of o)a.push(e.close);for(let e of o){var s;return 0,s=e}backTesting(o,t)}var database,fs=require("fs"),path=require("path"),loki=require("lokijs"),intervalsArr=["1MONTH","1WEEK","1DAY","60MINUTE","30MINUTE","10MINUTE","5MINUTE"],queue=async.queue(function(e,t){if(console.log("async.queue    "+e.interval+"> "+e.symbol),e.symbol){var o;try{o=path.resolve(path.join(__dirname,"..","db/stock/"+e.interval+"/"+e.symbol+".db"))}catch(e){console.log("Error > "+e)}var a=new loki(o,{autoload:!0,autoloadCallback:function(){var o=a.getCollection(e.symbol);o||(o=a.addCollection(e.symbol));var s="data/stock/"+e.interval+"/"+e.symbol+".txt";fs.exists(s,function(n){n?fs.readFile(s,"utf8",function(s,n){if(s&&console.log("readFile  "+s),""!=n&&null!=n&&null!=n){var r=JSON.parse(n);o.get(1)&&o.get(1).timestamp&&o.get(1).timestamp===r.timestamp||(console.log("****************UPDATE   "+e.interval+"> "+e.symbol),o.clear(),o.insert(r)),a.saveDatabase(),t()}}):t()})},autosave:!0,autosaveInterval:1e4})}},5),strategy_smaCross=[{indicators:[{indicator:"SMA",period:20,values:"closes"},{indicator:"SMA",period:50,values:"closes"}],output:[],strategy:"output[0][0] >= output[1][0]"},{indicators:[{indicator:"SMA",period:20,values:"closes"},{indicator:"SMA",period:50,values:"closes"}],output:[],strategy:"output[0][1] < output[1][1]"}],strategy_sma200=[{indicators:[{indicator:"SMA",period:20,values:"closes"},{indicator:"SMA",period:50,values:"closes"}],output:[],strategy:"output[0][0] >= output[1][0]"},{indicators:[{indicator:"SMA",period:20,values:"closes"},{indicator:"SMA",period:50,values:"closes"}],output:[],strategy:"output[0][1] < output[1][1]"}],strategy_sma200=[{indicators:[{indicator:"SMA",period:200,values:"closes"}],output:[],strategy:"closes[0] >= output[0][0]"}],strategy_rsi60=[{indicators:[{indicator:"RSI",period:14,values:"closes"}],output:[],strategy:"output[0][0] >= 60"},{indicators:[{indicator:"RSI",period:14,values:"closes"}],output:[],strategy:"output[0][1] < 60"}],strategy_bbLower=[{indicators:[{indicator:"BB",period:14,values:"closes"}],output:[],strategy:"closes[0] >= output[0][0]['lower']"}],strategy_bbUpper=[{indicators:[{indicator:"BB",period:14,values:"closes"}],output:[],strategy:"closes[0] >= output[0][0]['upper']"}];async function syncLiveAllStockData(e){intervalsArr.map(async t=>{e.map(async e=>{var o=e.symbol?e.symbol:e;queue.push({symbol:o,interval:t},function(){})})})}function getAllStockDataByInterval(e,t,o){console.log("* getAllStockDataByInterval   >> "+e.length),Promise.all(e.map(async e=>{return getStock(e.symbol?e.symbol:e,t)})).then(e=>{console.log("* getAllStockDataByInterval  "+e.length),e.map(async e=>{try{var t=JSON.parse(e.data);getIndicator(e.symbol,t,o,!1)}catch(e){console.log("Error "+e)}})}).catch(e=>{console.log(e)})}async function syncLiveStockDataByInterval(e,t){e.map(async e=>{var o=e.symbol?e.symbol:e;queue.push({symbol:o,interval:t},function(){})})}function getStockDataByInterval(e,t){getStock(e,t).then(e=>{var t=JSON.parse(e.data);console.log("getStockDataByInterval \n "+t.length)}).catch(e=>console.log(e))}function getStock(e,t){return new Promise((o,a)=>{var s;try{s=path.resolve(path.join(__dirname,"..","db/stock/"+t+"/"+e+".db"))}catch(e){console.log("getStock > Error > "+e),a(e)}var n=new loki(s,{autoload:!0,autoloadCallback:function(){var t=n.getCollection(e);t||(t=n.addCollection(e));try{t.get(1)&&t.get(1).data?o({symbol:e,data:JSON.stringify(t.get(1).data)}):o({symbol:e,data:[]})}catch(e){a(e)}},autosave:!0,autosaveInterval:1e4})})}getAllStockDataByInterval(["BATAINDIA","VEDL","SBIN"],"1DAY",strategy_rsi60);var accessToken,Upstox=require("upstox"),moment=require("moment-timezone"),api="cIs71szuLZ7WFKInU8O0o7GTHm5QIJke8ahnzLVw",upstox=new Upstox(api),fs=require("fs"),months=["January","February","March","April","May","June","July","August","September","October","November","December"],code="",__dirname="views",exchanges=["MCX_FO","BSE_EQ","NSE_EQ","NSE_FO","NCD_FO"],login_code="ce728b73424e719680aa66a51ba4eb469f9875f2",api_secret="xs5ibb0pk0",client_id="",watchList=["banknifty","hindalco","ICICIBANK","sbin","idea","lt","HAVELLS"];function getAcceToken(e){var t={apiSecret:api_secret,code:e,grant_type:"authorization_code",redirect_uri:redirect_uri};upstox.getAccessToken(t).then(function(o){t=api_secret=e=null,accessToken=o.access_token,store.set("accessToken",accessToken);var a=new Date,s=moment.tz(a,"DD-MM-YYYY HH:mm","Asia/Kolkata");s.format(),s=s.set({year:s.year(),date:s.date()+1,hour:9,minute:5,second:5}),store.set("tokenValidity",s),console.log("****accessToken*\n"+accessToken),upstox.setToken(accessToken),start()}).catch(function(e){console.log("getAccessToken > "+e)})}function start(){async.parallel({getProfile:getProfile,getBalance:getBalance,getListOfAllSymbol:getListOfAllSymbol,getAllData:getAllData},function(){}),upstox.getMasterContract({exchange:"nse_fo"}).then(function(e){console.log("FNO data >> \n \n"+transformedData),fs.writeFile("data/index/nse_fo.txt",JSON.stringify(e),function(e){if(e)throw e;console.log("nse_fo File is created successfully.")})}).catch(function(e){console.log("nse fo error "+JSON.stringify(e))}),upstox.getMasterContract({exchange:"NSE_INDEX",format:"json"}).then(function(e){fs.writeFile("data/index/index.txt",JSON.stringify(e),function(e){if(e)throw e;console.log("index File is created successfully.")})}).catch(function(e){console.log(e)}),upstox.connectSocket().then(function(){upstox.on("orderUpdate",function(e){console.log("orderUpdate"+e)}),upstox.on("positionUpdate",function(e){console.log("positionUpdate"+e)}),upstox.on("tradeUpdate",function(e){console.log("tradeUpdate"+e)});var e=niftyList.join();upstox.subscribeFeed({exchange:"nse_eq",symbol:e,type:"ltp"}).then(function(e){console.log("feedsymbols subscribeFeed response ",e)}).catch(function(e){console.log("Error in subscribe feed ",e)}),upstox.on("liveFeed",function(e){console.log("liveFeed"+e)}),upstox.on("disconnected",function(e){console.log("disconnected > "+e)}),upstox.on("error",function(e){console.log("error"+e)})}).catch(function(e){console.log("connectSocket #"+e)})}var nseSymbolList=[],balance,profile;function getListOfAllSymbol(){upstox.getMasterContract({exchange:"nse_eq",format:"json"}).then(function(e){var t=e.data;nseSymbolList=t.map(e=>e.symbol),store.set("nseSymbolList",nseSymbolList)}).catch(function(e){console.log("Error getListOfAllSymbol > "+JSON.stringify(e))})}function getBalance(){upstox.getBalance({type:"security"}).then(function(e){balance=JSON.stringify(e)}).catch(function(e){console.log(e)})}function getProfile(){upstox.getProfile().then(function(e){client_id=e.data.client_id,profile=JSON.stringify(e.data)}).catch(function(e){console.log("Error"+e)})}function getMaster(e="nse_fo"){if(store.get("accessToken"))return upstox.getMasterContract({exchange:e})}function loadSymbol(e,t,o="1day",a="12-12-2018"){if(console.log("loadSymbol > "+e+" > "+o+" > "+t+" > "+a+" :: "+store.get("accessToken")),store.get("accessToken"))return upstox.getOHLC({exchange:t,symbol:e,start_date:a,format:"json",interval:o})}function getAllData(){}function syncStockData(){delay(10).then(()=>load5minData()),delay(1e3).then(()=>load3minData()),delay(1e4).then(()=>load10minData()),delay(15e3).then(()=>load15minData()),delay(2e4).then(()=>load30minData()),delay(3e4).then(()=>load60minData()),delay(6e4).then(()=>load1dayData())}const delay=e=>new Promise(t=>setTimeout(t,e));var stockData=[],data={},promiseArr=[];async function loadAllSymbolData(e,t="1DAY",o="11-11-2018"){return promiseArr=[],Promise.all(e.map(function(e){return loadSymbol(e,"nse_eq",t,o).then(function(t){try{stockData=t.data;var o;if(inputBB=inputSMA=null,stockData.map(e=>(e&&e.close,e.change=getPercentageChange(+lastObject.close,+e.close),e.bb&&+e.close>=+e.bb.upper?e.bb.isCrossed="Crossed Above":e.bb&&+e.close<=+e.bb.lower&&(e.bb.isCrossed="Crossed Below"),lastObject=e,e)),stockData.reverse(),0<stockData[0].timestamp){var a=new Date(+stockData[0].timestamp),s=moment.tz(a,"DD-MM-YYYY HH:mm","Asia/Kolkata");s.format(),o=0<s.minute()?s.date()+"/"+(s.month()+1)+"/"+s.year()+" "+s.hour()+":"+s.minute():s.date()+"/"+(s.month()+1)+"/"+s.year()}return data={symbol:e,close:stockData[0].close,volume:stockData[0].volume,rsi:stockData[0].rsi,timestamp:o,sma:stockData[0].sma,bb:stockData[0].bb,change:stockData[0].change},stockData=null,promiseArr.push(data),data}catch(e){console.log("loadAllSymbolData : err   > "+e)}})}))}function csvTojs(e){for(var t=e,o=[],a=t[0].split(","),s=1;s<t.length;s++){var n={},r=t[s],i=0,l=0,c=0;if(""!==r.trim()){for(;c<r.length;){var u=r[c];if('"'===u)do{u=r[++c]}while('"'!==u&&c<r.length-1);if(","===u||c===r.length-1){var d=r.substr(l,c-l).trim();'"'===d[0]&&(d=d.substr(1)),","===d[d.length-1]&&(d=d.substr(0,d.length-1)),'"'===d[d.length-1]&&(d=d.substr(0,d.length-1)),n[a[i++]]=d,l=c+1}++c}o.push(n)}}return o}function getPercentageChange(e,t){return((t-e)/e*100).toFixed(2)}