var __awaiter=this&&this.__awaiter||function(r,i,s,l){return new(s||(s=Promise))(function(e,t){function n(e){try{a(l.next(e))}catch(e){t(e)}}function o(e){try{a(l.throw(e))}catch(e){t(e)}}function a(t){t.done?e(t.value):new s(function(e){e(t.value)}).then(n,o)}a((l=l.apply(r,i||[])).next())})},__generator=this&&this.__generator||function(n,o){var a,r,i,e,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(a)throw new TypeError("Generator is already executing.");for(;s;)try{if(a=1,r&&(i=2&t[0]?r.return:t[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,t[1])).done)return i;switch(r=0,i&&(t=[2&t[0],i.value]),t[0]){case 0:case 1:i=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,r=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(i=0<(i=s.trys).length&&i[i.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!i||t[1]>i[0]&&t[1]<i[3])){s.label=t[1];break}if(6===t[0]&&s.label<i[1]){s.label=i[1],i=t;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(t);break}i[2]&&s.ops.pop(),s.trys.pop();continue}t=o.call(n,s)}catch(e){t=[6,e],r=0}finally{a=i=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},express=require("express"),bodyParser=require("body-parser"),fs=require("fs"),url=require("url"),upstox=new(Upstox=require("upstox"))(api="cIs71szuLZ7WFKInU8O0o7GTHm5QIJke8ahnzLVw"),redirect_uri="http://127.0.0.1:"+(port=8080),app=express();app.use(express.static("public")),app.use(bodyParser.json()),app.use(bodyParser.urlencoded({extended:!0})),app.use(function(e,t,n){t.header("Access-Control-Allow-Origin","*"),t.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept"),n()});var months=["January","February","March","April","May","June","July","August","September","October","November","December"],today=(date=new Date).getDate()+"-"+date.getMonth()+"-"+date.getFullYear(),time=date+":"+date.getHours()+":"+date.getMinutes();app.get("/",function(e,t){var n=url.parse(e.url,!0).query;(code=n.code)&&(getAcceToken(code),t.sendFile("index.html",{root:__dirname}))}),app.get("/welcome",function(e,t){t.send("<b>Hello</b> welcome to my http server made with express")}),app.get("/login",function(e,t){t.sendFile("login.html",{root:__dirname})}),app.post("/login",function(e,t){var n=e.body.username,o=e.body.password;n?t.send("<b>username </b>  : "+n+" > "+o):t.sendFile("login.html",{root:__dirname})}),app.get("/signup",function(e,t){t.sendFile("signup.html",{root:__dirname})}),app.post("/signup",function(e,t){var n=e.body.email,o=e.body.psw;e.body.pswRepeat;n?t.send("<b>username </b>  : "+n+" > "+o):t.sendFile("signup.html",{root:__dirname})}),app.get("/contactus",function(e,t){t.sendFile("contactus.html",{root:__dirname})}),app.get("/index",function(e,t){t.sendFile("index.html",{root:__dirname})}),app.get("/scan",function(e,t){var o=this,a=url.parse(e.url,!0).query;a.symbolSearch?(nseSymbolList.map(function(n){return __awaiter(o,void 0,void 0,function(){var t;return __generator(this,function(e){return t=new RegExp(a.symbolSearch,"gi"),String(n).search(t),[2,n]})})}),console.log("nseSymbolList "+JSON.stringify(nseSymbolList))):t.sendFile("index.html",{root:__dirname})}),app.get("/loadSymbol/:symbol/:interval",function(e,n){var t=e.params.symbol,o=e.params.interval;rsi=new technicalindicators.RSI({values:[],period:14});sma=new technicalindicators.SMA({values:[],period:20});bb=new technicalindicators.BollingerBands({period:14,values:[],stdDev:2}),loadSymbol(t,"nse_eq",o,"9-9-2018").then(function(e){n.setHeader("Content-Type","application/json");var t=e.data;t.map(function(e){return e.timestamp=new Date(e.timestamp),e.rsi=rsi.nextValue(Number(e.close)),e.sma=sma.nextValue(Number(e.close)),e.bb=bb.nextValue(Number(e.close)),e}),t.reverse(),n.send(JSON.stringify(t)),n.end()}).catch(function(e){log("loadSymbol/:symbol error > "+JSON.stringify(e))})}),app.post("/setinterval",function(e,t){e.body.interval}),app.get("/getListOfAllSymbol",function(e,t){t.setHeader("Content-Type","application/json"),t.send(JSON.stringify(nseSymbolList)),t.end()}),app.get("/getBalance",function(e,t){t.setHeader("Content-Type","application/json"),t.send(JSON.stringify(balance)),t.end()}),app.get("/getProfile",function(e,t){t.setHeader("Content-Type","application/json"),t.send(JSON.stringify(profile)),t.end()}),app.post("/scan",function(e,t){}),app.get("/admin",function(e,t){var n=upstox.getLoginUri(redirect_uri);log("**************** loginUri ***********\n"+n),t.status(200).header("Content-type","text/html"),code=e.params.code,t.status(302).setHeader("Location",n),t.end()}),app.use(function(e,t,n){t.status(404).send("Sorry, that route doesn't exist. Have a nice day :)")}),app.listen(port,function(){log("App listening on port "+port)});var technicalindicators=require("technicalindicators"),dataForge=(fs=require("fs"),require("data-forge"));require("data-forge-plot"),require("data-forge-fs");months=["January","February","March","April","May","June","July","August","September","October","November","December"],today=(date=new Date).getDate()+"-"+date.getMonth()+"-"+date.getFullYear(),time=date+":"+date.getHours()+":"+date.getMinutes();var date,rsi,sma,bb,bankNiftyCall,days=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];function backTesting(e,t){e.filter(function(e){return 60<=e.rsi}).filter(function(e){return e.close>=e.sma})}function getList(e){for(var t=0,n=e;t<n.length;t++){var o=n[t];if(o){rsi=new technicalindicators.RSI({values:[],period:14});sma=new technicalindicators.SMA({values:[],period:20});bb=new technicalindicators.BollingerBands({period:14,values:[],stdDev:2});var r="data/stock/1day/"+(o.symbol?o.symbol:o)+".txt";fs.access(r,fs.constants.F_OK|fs.constants.R_OK,function(e){e?console.error(r+" "+("ENOENT"===e.code?"does not exist":"is read-only")):(console.log(r+" exists, and it is Readable"),fs.readFile(r,"utf8",function(e,t){if(e)throw e;if(""!=t&&null!=t&&null!=t){var n=JSON.parse(t),o=dataForge.fromJSON(JSON.stringify(n.data)).dropSeries(["cp"]).where(function(e){return calculateIndicators(e)}).select(function(e){return transform(e)}),a=(o.reverse(),o.toJSON());log("data >> "+r+"  n \n "+a)}}))})}}}function mappedFunction(){}function transform(e){return e.timestamp=new Date(e.timestamp),e}function searchPattern(e){var t=new Date,n=months[t.getMonth()].slice(0,3).toUpperCase(),o=new RegExp(n,"gi"),a=e.split(",");if(0<=String(a[3]).search(/BANKNIFTY/i)){for(var r=!1,i=String(a[3]).search(o),s=String(a[3]).search("FUT"),l=0;l<7;l++){if("Thursday"==days[t.getDay()]||"Wednesday"==days[t.getDay()]){var c=t.getFullYear(),u=t.getMonth()+1,d=t.getDate();d=String(d).length<2?"0"+t.getDate():t.getDate();var g="BANKNIFTY"+String(c).slice(2,4)+u+d,p=100*Math.round(a[2]/100),f=new RegExp(String(p),"gi"),h=String(a[3]).search(f);if(0<=String(a[3]).search(g)&&0<=h){var y=String(a[3]).search("CE"),b=String(a[3]).search("PE");console.log("\n MATCH "+y+" > "+b+" > "+a[3]),0<y?bankNiftyCall.CE=a[3]:0<b&&(bankNiftyCall.PE=a[3]),r=!0}}t.setDate(t.getDate()+1)}return r?e:0<=i&&0<=s?(bankNiftyCall.FUTURE=a[3],e):0}return 0}function calculateIndicators(e){return e.rsi=rsi.nextValue(Number(e.close)),e.sma=sma.nextValue(Number(e.close)),e.bb=bb.nextValue(Number(e.close)),e}function log(e){today=date.getDate()+"-"+date.getMonth()+"-"+date.getFullYear(),time=today+":"+date.getHours()+":"+date.getMinutes(),fs.appendFile("logs/log-"+today+".txt","\n"+date+" "+e,function(e){if(e)throw e})}function addIndicators(e,t){for(var n=e.data,o=0,a=n;o<a.length;o++){return(m=l=a[o]).timestamp=new Date(m.timestamp),m}for(var r=[],i=0,s=n;i<s.length;i++){var l=s[i];r.push(l.close)}for(var c={values:r,period:14},u=technicalindicators.RSI.calculate(c),d={values:r,period:20},g=technicalindicators.SMA.calculate(d),p={period:14,values:r,stdDev:2},f=technicalindicators.BollingerBands.calculate(p),h=0,y=0,b=n;y<b.length;y++){var m;return(m=l=b[y]).rsi=c.period<h?u[h-c.period]:0,m.sma=d.period<=h?g[h-d.period]:0,m.bb=p.period<=h?f[h-p.period]:null,h++,m}backTesting(n,t)}function checkBankNiftyExpiry(){bankNiftyCall=new Object,fs.readFile("data/index/nse_fo.txt",function(e,t){var n=JSON.parse(t).data,o=new dataForge.DataFrame(n).where(function(e){return searchPattern(e)}).toArray();console.log("WATCH BANK NIFTY  ****** "+JSON.stringify(bankNiftyCall)),log(" \n \n BANK NIFTY >> data >>"+o)})}var Upstox,api,port,$=require("jquery"),Awesomplete=require("Awesomplete"),schedule=(upstox=new(Upstox=require("upstox"))(api="cIs71szuLZ7WFKInU8O0o7GTHm5QIJke8ahnzLVw"),require("node-schedule")),code=(months=["January","February","March","April","May","June","July","August","September","October","November","December"],""),__dirname="views",exchanges=["MCX_FO","BSE_EQ","NSE_EQ","NSE_FO","NCD_FO"],login_code="ce728b73424e719680aa66a51ba4eb469f9875f2",api_secret="xs5ibb0pk0",client_id=(redirect_uri="http://127.0.0.1:"+(port=8080),""),watchList=["banknifty","hindalco","ICICIBANK","sbin","idea","lt","HAVELLS"],loginUrl=upstox.getLoginUri(redirect_uri);function getLogin(){var e=upstox.getLoginUri(redirect_uri);return console.log("**************** loginUri ***********\n"+e),e}function getAcceToken(e){var t={apiSecret:api_secret,code:e,grant_type:"authorization_code",redirect_uri:redirect_uri};upstox.getAccessToken(t).then(function(e){var t=e.access_token;log("****accessToken*\n"+t),upstox.setToken(t),start()}).catch(function(e){log("******** "+e)})}function start(){var i;function s(e,n,o){void 0===n&&(n="1day"),void 0===o&&(o="1-1-2010");for(var t=function(t){console.log("Load All > "+t.symbol+" > "+JSON.stringify(t)),upstox.getOHLC({exchange:t.exchange,symbol:t.symbol,start_date:o,format:"json",interval:n}).then(function(e){fs.writeFile("data/stock/"+n+"/"+t.symbol+".txt",JSON.stringify(e),function(e){if(e)throw e;log(t.exchange+" >> "+t.symbol+" >> "+n+" File is created successfully.")})}).catch(function(e){log("error  : : > "+JSON.stringify(e))})},a=0,r=e;a<r.length;a++){t(r[a])}}getProfile(),upstox.getMasterContract({exchange:"nse_fo"}).then(function(e){i=new Object;csvTojs(e.data);var t=new Date,n=months[t.getMonth()].slice(0,3).toUpperCase(),o=new RegExp(n,"gi"),a=JSON.parse(JSON.stringify(a));console.log(" >  "+a);dataForge.fromJSON(a).where(function(e){console.log("\n row > "+JSON.stringify(e)),e=JSON.stringify(e);var t=String(e.symbol).search(o),n=String(e.symbol).search("FUT");if(0<=t&&0<=n)return console.log("\n \n MATCH  >> > "+e.symbol),i.FUTURE=e.symbol,e});log("FNO data >> \n \n"+a),fs.writeFile("data/index/nse_fo.txt",JSON.stringify(e),function(e){if(e)throw e;console.log("nse_fo File is created successfully.")});schedule.scheduleJob("0 18 * * *",function(){log("Daily data update"),s(a,"1DAY","1-1-2005")});(r=new Date).setDate(r.getDate()-10);schedule.scheduleJob("*/60 * * * *",function(){log("NSE 60MINUTE data update"),s(a,"60MINUTE",r.getDate()+"-"+r.getMonth()+"-"+r.getFullYear())}),schedule.scheduleJob("*/30 * * * *",function(){log("NSE 30MINUTE data update"),s(a,"30MINUTE",r.getDate()+"-"+r.getMonth()+"-"+r.getFullYear())});(r=new Date).setDate(r.getDate()-5);var r;schedule.scheduleJob("*/10 * * * *",function(){log("NSE 10MINUTE data update"),s(a,"10MINUTE",r.getDate()+"-"+r.getMonth()+"-"+r.getFullYear())});(r=new Date).setDate(r.getDate()-5);schedule.scheduleJob("*/5 * * * *",function(){log("NSE 10MINUTE data update"),s(a,"5MINUTE",r.getDate()+"-"+r.getMonth()+"-"+r.getFullYear())})}).catch(function(e){console.log("nse fo error "+JSON.stringify(e))}),upstox.getMasterContract({exchange:"NSE_INDEX",format:"json"}).then(function(e){fs.writeFile("data/index/index.txt",JSON.stringify(e),function(e){if(e)throw e;log("index File is created successfully.")})}).catch(function(e){log(e)}),upstox.connectSocket().then(function(){upstox.on("orderUpdate",function(e){log("orderUpdate"+e)}),upstox.on("positionUpdate",function(e){log("positionUpdate"+e)}),upstox.on("tradeUpdate",function(e){log("tradeUpdate"+e)}),upstox.subscribeFeed({exchange:"NSE_FO",symbol:"BANKNIFTY27DECFUT",type:"ltp"}).then(function(e){console.log("feedsymbols subscribeFeed response ",e)}).catch(function(e){console.log("Error in subscribe feed ",e)}),upstox.on("liveFeed",function(e){log("liveFeed"+e)}),upstox.on("disconnected",function(e){log("disconnected"+e)}),upstox.on("error",function(e){log("error"+e)})}).catch(function(e){log("******** "+e)})}var balance,profile,nseSymbolList=[];function getListOfAllSymbol(){upstox.getMasterContract({exchange:"nse_eq",format:"json"}).then(function(e){var t=e.data;nseSymbolList=t.map(function(e){return e.symbol})}).catch(function(e){log("Error getListOfAllSymbol > "+e)})}function getBalance(){upstox.getBalance({type:"security"}).then(function(e){balance=JSON.stringify(e)}).catch(function(e){log(e)})}function getProfile(){upstox.getProfile().then(function(e){client_id=e.data.client_id,profile=JSON.stringify(e.data),getBalance(),getListOfAllSymbol()}).catch(function(e){log("Error"+e)})}function loadSymbol(e,t,n,o){return void 0===n&&(n="1day"),void 0===o&&(o="1-1-2010"),upstox.getOHLC({exchange:t,symbol:e,start_date:o,format:"json",interval:n})}function csvTojs(e){for(var t=e,n=[],o=t[0].split(","),a=1;a<t[1].length;a++){var r={},i=t[a],s=0,l=0,c=0;if(""!==i.trim()){for(;c<i.length;){var u=i[c];if('"'===u)for(;'"'!==(u=i[++c])&&c<i.length-1;);if(","===u||c===i.length-1){var d=i.substr(l,c-l).trim();'"'===d[0]&&(d=d.substr(1)),","===d[d.length-1]&&(d=d.substr(0,d.length-1)),'"'===d[d.length-1]&&(d=d.substr(0,d.length-1)),r[o[s++]]=d,l=c+1}++c}n.push(r)}}return n}