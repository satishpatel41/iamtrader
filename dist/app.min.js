"use strict";var __awaiter=this&&this.__awaiter||function(i,r,s,l){return new(s||(s=Promise))(function(e,t){function n(e){try{o(l.next(e))}catch(e){t(e)}}function a(e){try{o(l.throw(e))}catch(e){t(e)}}function o(t){t.done?e(t.value):new s(function(e){e(t.value)}).then(n,a)}o((l=l.apply(i,r||[])).next())})},__generator=this&&this.__generator||function(n,a){var o,i,r,e,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,i&&(r=2&t[0]?i.return:t[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,t[1])).done)return r;switch(i=0,r&&(t=[2&t[0],r.value]),t[0]){case 0:case 1:r=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,i=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(r=0<(r=s.trys).length&&r[r.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!r||t[1]>r[0]&&t[1]<r[3])){s.label=t[1];break}if(6===t[0]&&s.label<r[1]){s.label=r[1],r=t;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(t);break}r[2]&&s.ops.pop(),s.trys.pop();continue}t=a.call(n,s)}catch(e){t=[6,e],i=0}finally{o=r=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},nodemailer=require("nodemailer"),transporter=nodemailer.createTransport({service:"gmail",auth:{user:"satish.patel41@gmail.com",pass:"Pratiksha@123"}}),mailOptions={from:'"Admin" <satish.patel41@gmail.com>',to:"satish.patel41@yahoo.com",subject:"Call Generated",text:"Hello world?",html:'<p><b>Hello</b> to myself <img src="cid:note@example.com"/></p><p>Here\'s a nyan cat for you as an embedded attachment:<br/><img src="cid:nyan@example.com"/></p>',attachments:[{filename:"notes.txt",content:"Some notes about this e-mail",contentType:"text/plain"}],list:{help:"admin@example.com?subject=help",unsubscribe:[{url:"http://example.com/unsubscribe",comment:"A short note about this url"},"unsubscribe@example.com"],id:{url:"mylist.example.com",comment:"This is my awesome list"}}};function sendingMail(){transporter.sendMail(mailOptions,function(e,t){if(e)return console.log(e);console.log("Message sent: %s",t.messageId),console.log("Preview URL: %s",nodemailer.getTestMessageUrl(t))})}var schedule=require("node-schedule"),list=fnoList,stockObj={data1day:[],data60:[],data30:[],data10:[],data5:[]},j=schedule.scheduleJob("0 18 * * *",function(){load1dayData()});j=schedule.scheduleJob("*/60 * * * *",function(){load60minData()}),j=schedule.scheduleJob("*/30 * * * *",function(){load30minData()}),j=schedule.scheduleJob("*/10 * * * *",function(){load10minData()}),j=schedule.scheduleJob("*/5 * * * *",function(){load5minData()});function load1dayData(){log("NSE 1 day data update");var t=fnoList,n=new Date;n.setDate(n.getDate()-21);var e=n.getDate()+"-"+n.getMonth()+"-"+n.getFullYear(),a="1day";loadAllSymbolData(t,a,e).then(function(e){stockObj.data1day=e,log("*** NSE 1 day *** \n "+JSON.stringify(stockObj)),t=n=a=null}).catch(function(e){log("loadAllSymbolData/ error > "+JSON.stringify(e))})}function load60minData(){log("NSE 60MINUTE data update");var t=fnoList,n=new Date;n.setMinutes(n.getMinutes()-3e3);var e=n.getDate()+"-"+n.getMonth()+"-"+n.getFullYear(),a="60MINUTE";loadAllSymbolData(t,a,e).then(function(e){stockObj.data60=e,log("*** NSE 60 MINUTE *** \n "+JSON.stringify(stockObj)),t=n=a=null}).catch(function(e){log("loadAllSymbolData/ error > "+JSON.stringify(e))})}function load30minData(){log("NSE 30MINUTE data update");var t=fnoList,n=new Date;n.setMinutes(n.getMinutes()-1500);var e=n.getDate()+"-"+n.getMonth()+"-"+n.getFullYear(),a="30MINUTE";loadAllSymbolData(t,a,e).then(function(e){stockObj.data30=e,log("*** NSE 30 MINUTE *** \n "+JSON.stringify(stockObj)),t=n=a=null}).catch(function(e){log("loadAllSymbolData/ error > "+JSON.stringify(e))})}function load10minData(){log("NSE 10MINUTE data update");var t=fnoList,n="10MINUTE",a=new Date;a.setMinutes(a.getMinutes()-500);var e=a.getDate()+"-"+a.getMonth()+"-"+a.getFullYear();loadAllSymbolData(t,n,e).then(function(e){stockObj.data10=e,log("*** NSE 10 MINUTE *** \n "+JSON.stringify(stockObj)),t=a=n=null}).catch(function(e){log("loadAllSymbolData/ error > "+JSON.stringify(e))})}function load5minData(){log("NSE 5 MINUTE data update");var t=fnoList,n=new Date;n.setMinutes(n.getMinutes()-250);var a=n.getDate()+"-"+n.getMonth()+"-"+n.getFullYear(),o="5MINUTE";loadAllSymbolData(t,o,a).then(function(e){stockObj.data5=e,log("*** NSE 5 MINUTE *** \n "+a+" >> "+JSON.stringify(stockObj)),t=n=o=null}).catch(function(e){log("loadAllSymbolData/ error > "+a+" >> "+JSON.stringify(e))})}var express=require("express"),bodyParser=require("body-parser"),fs=require("fs"),url=require("url"),https=require("https"),dataForge=require("data-forge");require("data-forge-fs");var upstox=new(Upstox=require("upstox"))(api="cIs71szuLZ7WFKInU8O0o7GTHm5QIJke8ahnzLVw"),PORT=process.env.PORT||8080,redirect_uri="http://localhost:"+PORT,nifty="https://www.nseindia.com/content/indices/ind_nifty50list.csv",fno="https://www.nseindia.com/content/fo/fo_mktlots.csv",jsdom=require("jsdom").jsdom;"production"==process.env.NODE_ENV&&(api="cIs71szuLZ7WFKInU8O0o7GTHm5QIJke8ahnzLVw",redirect_uri="https://robo-trader.herokuapp.com/");var app=express();app.use(express.static("public")),app.use(bodyParser.json()),app.use(bodyParser.urlencoded({extended:!0})),app.use(function(e,t,n){t.header("Access-Control-Allow-Origin","*"),t.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept"),n()});var months=["January","February","March","April","May","June","July","August","September","October","November","December"],today=(date=new Date).getDate()+"-"+date.getMonth()+"-"+date.getFullYear(),time=date+":"+date.getHours()+":"+date.getMinutes(),fnoArr=dataForge.readFileSync("data/list/fo_mktlots.csv").parseCSV().toArray(),fnoList=[];fnoArr.forEach(function(e){e.Symbol?fnoList.push(e.Symbol):fnoList.push(e.SYMBOL)});var niftyList=dataForge.readFileSync("data/list/ind_nifty50list.csv").parseCSV().toArray();function initiateIndicator(){rsi=new technicalindicators.RSI({values:[],period:14});sma=new technicalindicators.SMA({values:[],period:20});bb=new technicalindicators.BollingerBands({period:14,values:[],stdDev:2})}niftyList=niftyList.map(function(e){return e.Symbol}),app.get("/",function(e,t){var n=url.parse(e.url,!0).query;(code=n.code)&&getAcceToken(code),t.sendFile("index.html",{root:__dirname})}),app.get("/welcome",function(e,t){t.send("<b>Hello</b> welcome to my http server made with express")}),app.get("/login",function(e,t){t.sendFile("login.html",{root:__dirname})}),app.post("/login",function(e,t){var n=e.body.username,a=e.body.password;n?t.send("<b>username </b>  : "+n+" > "+a):t.sendFile("login.html",{root:__dirname})}),app.get("/signup",function(e,t){t.sendFile("signup.html",{root:__dirname})}),app.post("/signup",function(e,t){var n=e.body.email,a=e.body.psw;e.body.pswRepeat;n?t.send("<b>username </b>  : "+n+" > "+a):t.sendFile("signup.html",{root:__dirname})}),app.get("/contactus",function(e,t){t.sendFile("contactus.html",{root:__dirname})}),app.get("/index",function(e,t){t.sendFile("index.html",{root:__dirname})}),app.get("/scan",function(e,t){t.sendFile("scanner.html",{root:__dirname})}),app.get("/loadSymbol/:symbol/:interval",function(e,n){var t=e.params.symbol,a=e.params.interval,o=new Date;"5MINUTE"==a?o.setMinutes(o.getMinutes()-100):"10MINUTE"==a?o.setMinutes(o.getMinutes()-200):"30MINUTE"==a?o.setMinutes(o.getMinutes()-600):"60MINUTE"==a?o.setMinutes(o.getMinutes()-1200):"1DAY"==a?o.setDate(o.getDate()-20):"1WEEK"==a?o.setDate(o.getDate()-140):"1MONTH"==a&&o.setMonth(o.getMonth()-20);var i=o.getDate()+"-"+o.getMonth()+"-"+o.getFullYear();initiateIndicator(),loadSymbol(t,"nse_eq",a,i).then(function(e){n.setHeader("Content-Type","application/json");var t=e.data;t.map(function(e){return e.timestamp=new Date(e.timestamp),e.rsi=rsi.nextValue(Number(e.close)),e.sma=sma.nextValue(Number(e.close)),e.bb=bb.nextValue(Number(e.close)),e}),t.reverse(),n.send(JSON.stringify(t)),n.end()}).catch(function(e){log("loadSymbol/:symbol error > "+JSON.stringify(e))})}),app.get("/loadAllSymbolData/:interval/:exchange",function(e,n){var a=e.params.interval,t=e.params.exchange,o=[];o="nifty"==t?niftyList:"fno"==t?fnoList:nseSymbolList;var i=[];console.log("*** NSE stockData *** \n "+JSON.stringify(stockObj)),"5MINUTE"==a?i=stockObj.data5:"10MINUTE"==a?i=stockObj.data10:"30MINUTE"==a?i=stockObj.data30:"60MINUTE"==a?i=stockObj.data60:"1DAY"==a&&(i=stockObj.data1day);var r=i.filter(function(e){return null!=e&&null!=e.close&&null!=e.close&&""!=e.close});0<r.length?(n.setHeader("Content-Type","application/json"),n.send(JSON.stringify(r)),n.end()):(console.log("*** Ok No data available.. Fetch it \n "),loadAllSymbolData(o,a,"10-11-2018").then(function(e){var t=e.filter(function(e){return null!=e&&null!=e.close&&null!=e.close&&""!=e.close});"5MINUTE"==a?stockObj.data5=t:"10MINUTE"==a?stockObj.data10=t:"30MINUTE"==a?stockObj.data30=t:"60MINUTE"==a?stockObj.data60=t:"1DAY"==a&&(stockObj.data1day=t),n.setHeader("Content-Type","application/json"),n.send(JSON.stringify(e)),t=null,n.end()}).catch(function(e){log("loadAllSymbolData/ error > "+JSON.stringify(e))}))}),app.get("/getListOfAllSymbol",function(e,t){t.setHeader("Content-Type","application/json"),t.send(JSON.stringify(nseSymbolList)),t.end()}),app.get("/sync",function(e,t){t.setHeader("Content-Type","application/json"),t.send("Successfully sync data !"),t.end()}),app.get("/getBalance",function(e,t){syncStockData(),t.setHeader("Content-Type","application/json"),t.send(JSON.stringify(balance)),t.end()}),app.get("/getProfile",function(e,t){t.setHeader("Content-Type","application/json"),t.send(JSON.stringify(profile)),t.end()}),app.post("/scan",function(e,t){}),app.get("/admin",function(e,t){var n=upstox.getLoginUri(redirect_uri);log("*loginUri "+n),t.status(200).header("Content-type","text/html"),code=e.params.code,t.status(302).setHeader("Location",n),t.end()}),app.use(function(e,t,n){t.status(404).send("Sorry, that route doesn't exist. Have a nice day :)")}),app.listen(PORT,function(){log("App listening on port "+PORT)});var date,rsi,sma,bb,bankNiftyCall,technicalindicators=require("technicalindicators"),days=(fs=require("fs"),months=["January","February","March","April","May","June","July","August","September","October","November","December"],today=(date=new Date).getDate()+"-"+date.getMonth()+"-"+date.getFullYear(),time=date+":"+date.getHours()+":"+date.getMinutes(),["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]);function backTesting(e,t){e.filter(function(e){return 60<=e.rsi}).filter(function(e){return e.close>=e.sma})}function getList(e){for(var t=0,n=e;t<n.length;t++){var a=n[t];if(a){rsi=new technicalindicators.RSI({values:[],period:14});sma=new technicalindicators.SMA({values:[],period:20});bb=new technicalindicators.BollingerBands({period:14,values:[],stdDev:2});var i="data/stock/1day/"+(a.symbol?a.symbol:a)+".txt";fs.access(i,fs.constants.F_OK|fs.constants.R_OK,function(e){e?console.error(i+" "+("ENOENT"===e.code?"does not exist":"is read-only")):(console.log(i+" exists, and it is Readable"),fs.readFile(i,"utf8",function(e,t){if(e)throw e;if(""!=t&&null!=t&&null!=t){var n=JSON.parse(t),a=dataForge.fromJSON(JSON.stringify(n.data)).dropSeries(["cp"]).where(function(e){return calculateIndicators(e)}).select(function(e){return transform(e)}),o=(a.reverse(),a.toJSON());log("data >> "+i+"  n \n "+o)}}))})}}}function mappedFunction(){}function transform(e){return e.timestamp=new Date(e.timestamp),e}function searchPattern(e){var t=new Date,n=months[t.getMonth()].slice(0,3).toUpperCase(),a=new RegExp(n,"gi"),o=e.split(",");if(0<=String(o[3]).search(/BANKNIFTY/i)){for(var i=!1,r=String(o[3]).search(a),s=String(o[3]).search("FUT"),l=0;l<7;l++){if("Thursday"==days[t.getDay()]||"Wednesday"==days[t.getDay()]){var c=t.getFullYear(),u=t.getMonth()+1,d=t.getDate();d=String(d).length<2?"0"+t.getDate():t.getDate();var f="BANKNIFTY"+String(c).slice(2,4)+u+d,p=100*Math.round(o[2]/100),g=new RegExp(String(p),"gi"),m=String(o[3]).search(g);if(0<=String(o[3]).search(f)&&0<=m){var h=String(o[3]).search("CE"),b=String(o[3]).search("PE");console.log("\n MATCH "+h+" > "+b+" > "+o[3]),0<h?bankNiftyCall.CE=o[3]:0<b&&(bankNiftyCall.PE=o[3]),i=!0}}t.setDate(t.getDate()+1)}return i?e:0<=r&&0<=s?(bankNiftyCall.FUTURE=o[3],e):0}return 0}function calculateIndicators(e){return e.rsi=rsi.nextValue(Number(e.close)),e.sma=sma.nextValue(Number(e.close)),e.bb=bb.nextValue(Number(e.close)),e}function log(t){date=new Date,today=date.getDate()+"-"+date.getMonth()+"-"+date.getFullYear(),time=today+":"+date.getHours()+":"+date.getMinutes();var n="logs/log-"+today+".txt";try{fs.existsSync(n)?fs.appendFile(n,"\n"+date+" "+t,function(e){if(e)throw e}):fs.writeFile(n,"\n"+date+" "+t,function(e){if(e)throw e})}catch(e){console.error(e),fs.writeFile(n,"\n"+date+" "+t,function(e){if(e)throw e})}}function addIndicators(e,t){for(var n=e.data,a=0,o=n;a<o.length;a++){return(y=l=o[a]).timestamp=new Date(y.timestamp),y}for(var i=[],r=0,s=n;r<s.length;r++){var l=s[r];i.push(l.close)}for(var c={values:i,period:14},u=technicalindicators.RSI.calculate(c),d={values:i,period:20},f=technicalindicators.SMA.calculate(d),p={period:14,values:i,stdDev:2},g=technicalindicators.BollingerBands.calculate(p),m=0,h=0,b=n;h<b.length;h++){var y;return(y=l=b[h]).rsi=c.period<m?u[m-c.period]:0,y.sma=d.period<=m?f[m-d.period]:0,y.bb=p.period<=m?g[m-p.period]:null,m++,y}backTesting(n,t)}function checkBankNiftyExpiry(){bankNiftyCall=new Object,fs.readFile("data/index/nse_fo.txt",function(e,t){var n=JSON.parse(t).data,a=new dataForge.DataFrame(n).where(function(e){return searchPattern(e)}).toArray();console.log("WATCH BANK NIFTY  ****** "+JSON.stringify(bankNiftyCall)),log(" \n \n BANK NIFTY >> data >>"+a)})}upstox=new(Upstox=require("upstox"))(api="cIs71szuLZ7WFKInU8O0o7GTHm5QIJke8ahnzLVw"),schedule=require("node-schedule"),fs=require("fs"),months=["January","February","March","April","May","June","July","August","September","October","November","December"];var Upstox,api,code="",__dirname="views",exchanges=["MCX_FO","BSE_EQ","NSE_EQ","NSE_FO","NCD_FO"],login_code="ce728b73424e719680aa66a51ba4eb469f9875f2",api_secret="xs5ibb0pk0",client_id="",watchList=["banknifty","hindalco","ICICIBANK","sbin","idea","lt","HAVELLS"];function getAcceToken(n){var a={apiSecret:api_secret,code:n,grant_type:"authorization_code",redirect_uri:redirect_uri};upstox.getAccessToken(a).then(function(e){a=api_secret=n=null;var t=e.access_token;log("****accessToken*\n"+t),upstox.setToken(t),t=null,start()}).catch(function(e){log("getAccessToken > "+e)})}function start(){var i;getProfile(),upstox.getMasterContract({exchange:"nse_fo1"}).then(function(e){i=new Object;csvTojs(e.data);var t=new Date,n=months[t.getMonth()].slice(0,3).toUpperCase(),a=new RegExp(n,"gi"),o=JSON.parse(JSON.stringify(o));dataForge.fromJSON(o).where(function(e){e=JSON.stringify(e);var t=String(e.symbol).search(a),n=String(e.symbol).search("FUT");if(0<=t&&0<=n)return console.log("\n \n MATCH  >> > "+e.symbol),i.FUTURE=e.symbol,e});log("FNO data >> \n \n"+o),fs.writeFile("data/index/nse_fo.txt",JSON.stringify(e),function(e){if(e)throw e;console.log("nse_fo File is created successfully.")})}).catch(function(e){console.log("nse fo error "+JSON.stringify(e))}),upstox.getMasterContract({exchange:"NSE_INDEX",format:"json"}).then(function(e){fs.writeFile("data/index/index.txt",JSON.stringify(e),function(e){if(e)throw e;log("index File is created successfully.")})}).catch(function(e){log(e)}),upstox.connectSocket().then(function(){upstox.on("orderUpdate",function(e){log("orderUpdate"+e)}),upstox.on("positionUpdate",function(e){log("positionUpdate"+e)}),upstox.on("tradeUpdate",function(e){log("tradeUpdate"+e)}),upstox.subscribeFeed({exchange:"NSE_FO",symbol:"BANKNIFTY27DECFUT",type:"ltp"}).then(function(e){console.log("feedsymbols subscribeFeed response ",e)}).catch(function(e){console.log("Error in subscribe feed ",e)}),upstox.on("liveFeed",function(e){log("liveFeed"+e)}),upstox.on("disconnected",function(e){log("disconnected"+e)}),upstox.on("error",function(e){log("error"+e)})}).catch(function(e){log("connectSocket #"+e)})}var balance,profile,nseSymbolList=[];function getListOfAllSymbol(){upstox.getMasterContract({exchange:"nse_eq",format:"json"}).then(function(e){var t=e.data;nseSymbolList=t.map(function(e){return e.symbol}),getAllData()}).catch(function(e){log("Error getListOfAllSymbol > "+e),getAllData()})}function getBalance(){upstox.getBalance({type:"security"}).then(function(e){balance=JSON.stringify(e),getListOfAllSymbol()}).catch(function(e){log(e),getListOfAllSymbol()})}function getProfile(){upstox.getProfile().then(function(e){client_id=e.data.client_id,profile=JSON.stringify(e.data),getBalance()}).catch(function(e){log("Error"+e)})}function loadSymbol(e,t,n,a){return void 0===n&&(n="1day"),void 0===a&&(a="1-1-2018"),upstox.getOHLC({exchange:t,symbol:e,start_date:a,format:"json",interval:n})}function getAllData(){}function syncStockData(){setTimeout(function(){load1dayData()},6e4),setTimeout(function(){load60minData()},3e4),setTimeout(function(){load30minData()},2e4),setTimeout(function(){load10minData()},1e4),setTimeout(function(){load5minData()},10)}function loadAllSymbolData(a,o,e){return void 0===o&&(o="1day"),void 0===e&&(e="11-11-2018"),__awaiter(this,void 0,void 0,function(){var t,n=this;return __generator(this,function(e){return[],t=a.map(function(a){return __awaiter(n,void 0,void 0,function(){var n;return __generator(this,function(e){switch(e.label){case 0:return n={},[4,loadSymbol(a,"nse_eq",o,"9-9-2018").then(function(e){var t=e.data;t.map(function(e){return e.timestamp=new Date(e.timestamp),e.rsi=rsi.nextValue(Number(e.close)),e.sma=sma.nextValue(Number(e.close)),e.bb=bb.nextValue(Number(e.close)),e}),t.reverse(),n={symbol:a,close:t[0].close,volume:t[0].volume,rsi:t[0].rsi,timestamp:t[0].timestamp,sma:t[0].sma,bb:t[0].bb}}).catch(function(e){console.log("loadSymbol error > "+JSON.stringify(e))})];case 1:return e.sent(),[2,n]}})})}),[2,Promise.all(t).then(function(e){return e.filter(Boolean)})]})})}function csvTojs(e){for(var t=e,n=[],a=t[0].split(","),o=1;o<t[1].length;o++){var i={},r=t[o],s=0,l=0,c=0;if(""!==r.trim()){for(;c<r.length;){var u=r[c];if('"'===u)for(;'"'!==(u=r[++c])&&c<r.length-1;);if(","===u||c===r.length-1){var d=r.substr(l,c-l).trim();'"'===d[0]&&(d=d.substr(1)),","===d[d.length-1]&&(d=d.substr(0,d.length-1)),'"'===d[d.length-1]&&(d=d.substr(0,d.length-1)),i[a[s++]]=d,l=c+1}++c}n.push(i)}}return n}