
var chalk=require("chalk");const sqlite3=require("sqlite3").verbose();let db=new sqlite3.Database("db/upstox.db",a=>a?console.error(a.message):void console.log(chalk.green("Connected to the in-memory SQlite database.")));function closeDb(){db.close()}function insertDB(a,b){return new Promise(function(c){db.run(a,b,function(a){a?console.log(chalk.red("Insert error > "+a)):(console.log(chalk.blue("Successfully inserted")),c("success"))})})}async function getFirst(a,b){return new Promise(function(c,d){db.get(a,b,function(a,b){a?d("Read error: "+a.message):c(b)})})}
"use strict";const nodemailer=require("nodemailer");var transporter=nodemailer.createTransport({service:"gmail",auth:{user:"satish.patel41@gmail.com",pass:"Pratiksha@123"}});let mailOptions={from:"\"Admin\" <satish.patel41@gmail.com>",to:"satish.patel41@yahoo.com",subject:"Call Generated",text:"Alert for",html:"<p><b>Hello</b> Alert triggered on Wed Nov 7, 6:00 pm</p><p>Here's a nyan cat for you as an embedded attachment:<br/><img src=\"cid:nyan@example.com\"/></p>",attachments:[{filename:"notes.txt",content:"Some notes about this e-mail",contentType:"text/plain"}],list:{help:"admin@example.com?subject=help",unsubscribe:[{url:"http://example.com/unsubscribe",comment:"A short note about this url"},"unsubscribe@example.com"],id:{url:"mylist.example.com",comment:"This is my awesome list"}}};function sendingMail(){transporter.sendMail(mailOptions,(a,b)=>a?console.log(a):void(console.log("Message sent: %s",b.messageId),console.log("Preview URL: %s",nodemailer.getTestMessageUrl(b))))}
var list,cron=require("node-cron"),chalk=require("chalk");cron.schedule("*/3 * * * *",()=>{load3minData(),console.log(chalk.blue("running a task every 3 minutes"))},{scheduled:!0,timezone:"Asia/Kolkata"}),cron.schedule("*/5 * * * *",()=>{load5minData(),console.log(chalk.blue("running a task every 5 minutes"))},{scheduled:!0,timezone:"Asia/Kolkata"}),cron.schedule("*/10 * * * *",()=>{load10minData(),console.log(chalk.blue("running a task every 10 minutes"))},{scheduled:!0,timezone:"Asia/Kolkata"}),cron.schedule("*/15 * * * *",()=>{load15minData(),console.log(chalk.blue("running a task every 15 minutes"))},{scheduled:!0,timezone:"Asia/Kolkata"}),cron.schedule("*/30 * * * *",()=>{load30minData(),console.log(chalk.blue("running a task every 30 minutes"))},{scheduled:!0,timezone:"Asia/Kolkata"}),cron.schedule("0 */1 * * *",()=>{load60minData(),console.log(chalk.blue("running a task every 1 hour"))},{scheduled:!0,timezone:"Asia/Kolkata"}),cron.schedule("59 23 * * *",()=>{store.unlink(),console.log(chalk.yellow("Clean cache data"))},{scheduled:!0,timezone:"Asia/Kolkata"}),cron.schedule("0 17 * * *",()=>{load1dayData(),console.log(chalk.blue("running a task every 1 day"))},{scheduled:!0,timezone:"Asia/Kolkata"});function load1dayData(){var a=niftyList,b=new Date;b.setDate(b.getDate()-21);var c=b.getDate()+"-"+(b.getMonth()+1)+"-"+b.getFullYear(),d="1DAY";store.get("accessToken")&&loadAllSymbolData(a,d,c).then(function(c){0<c.length&&store.set("data1day",c),a=b=d=null,console.log("NSE 1 day data update")}).catch(function(a){console.log("load1dayData/ error > "+JSON.stringify(a))})}function load60minData(){var a=niftyList,b=new Date;b.setDate(b.getDate()-5);var c=b.getDate()+"-"+(b.getMonth()+1)+"-"+b.getFullYear(),d="60MINUTE";store.get("accessToken")&&loadAllSymbolData(a,d,c).then(function(c){0<c.length&&store.set("data60",c),a=b=d=null,console.log("NSE 60MINUTE data update")}).catch(function(a){console.log("load60minData/ error > "+JSON.stringify(a))})}function load30minData(){var a=niftyList,b=new Date;b.setDate(b.getDate()-4);var c=b.getDate()+"-"+(b.getMonth()+1)+"-"+b.getFullYear(),d="30MINUTE";store.get("accessToken")&&loadAllSymbolData(a,d,c).then(function(c){0<c.length&&store.set("data30",c),a=b=d=null,console.log("NSE 30MINUTE data update")}).catch(function(a){console.log("load30minData/ error > "+JSON.stringify(a))})}function load10minData(){var a=niftyList,b="10MINUTE",c=new Date;c.setDate(c.getDate()-3);var d=c.getDate()+"-"+(c.getMonth()+1)+"-"+c.getFullYear();store.get("accessToken")&&loadAllSymbolData(a,b,d).then(function(d){0<d.length&&store.set("data10",d),a=c=b=null,console.log("NSE 10MINUTE data update")}).catch(function(a){console.log("load10minData/ error > "+JSON.stringify(a))})}function load5minData(){var a=niftyList,b=new Date;b.setDate(b.getDate()-3);var c=b.getDate()+"-"+(b.getMonth()+1)+"-"+b.getFullYear(),d="5MINUTE";store.get("accessToken")&&loadAllSymbolData(a,d,c).then(function(c){0<c.length&&store.set("data5",c),a=b=d=null,console.log("NSE 5 MINUTE data update")}).catch(function(a){console.log("load5minData/ error > "+c+" >> "+JSON.stringify(a))})}function load3minData(){var a=niftyList,b=new Date;b.setDate(b.getDate()-3);var c=b.getDate()+"-"+(b.getMonth()+1)+"-"+b.getFullYear(),d="3MINUTE";store.get("accessToken")&&loadAllSymbolData(a,d,c).then(function(c){0<c.length&&store.set("data3",c),console.log("NSE 3 MINUTE data update"),a=b=d=null}).catch(function(a){console.log("load3minData/ error > "+c+" >> "+JSON.stringify(a))})}function load15minData(){var a=niftyList,b=new Date;b.setDate(b.getDate()-3);var c=b.getDate()+"-"+(b.getMonth()+1)+"-"+b.getFullYear(),d="15MINUTE";store.get("accessToken")&&loadAllSymbolData(a,d,c).then(function(c){0<c.length&&store.set("data15",c),a=b=d=null,console.log("NSE 15 MINUTE data update")}).catch(function(a){console.log("load15minData/ error > "+c+" >> "+JSON.stringify(a))})}
var express=require("express"),compression=require("compression"),moment=require("moment-timezone"),bodyParser=require("body-parser"),chalk=require("chalk"),fs=require("fs"),url=require("url"),cluster=require("cluster");const dataForge=require("data-forge");var session=require("express-session"),FileStore=require("session-file-store")(session);const Store=require("data-store");var async=require("async");const querystring=require("querystring"),store=new Store({path:"config.json"});require("data-forge-fs");var Upstox=require("upstox"),api="cIs71szuLZ7WFKInU8O0o7GTHm5QIJke8ahnzLVw",upstox=new Upstox(api);const PORT=process.env.PORT||8080;var redirect_uri="http://localhost:"+PORT,nifty="https://www.nseindia.com/content/indices/ind_nifty50list.csv",fno="https://www.nseindia.com/content/fo/fo_mktlots.csv";"production"==process.env.NODE_ENV&&(api="cIs71szuLZ7WFKInU8O0o7GTHm5QIJke8ahnzLVw",redirect_uri="https://robo-trader.herokuapp.com/");var numReqs=0;if(cluster.isMaster){let a=require("os").cpus().length;console.log(chalk.green("cpus "+a));for(var worker,i=0;i<a;i++)worker=cluster.fork(),worker.on("message",function(){});cluster.on("death",function(a){console.log(chalk.red("worker "+a.pid+" died"))})}else{function a(a,b,c){a.session.user?c():(console.log(chalk.blue(JSON.stringify(a.session)+" session \n"+a.session.user)),b.sendFile("login.html",{root:__dirname}))}function b(){var a={values:[],period:14};rsi=new technicalindicators.RSI(a);var b={values:[],period:20};sma=new technicalindicators.SMA(b);var c={period:14,values:[],stdDev:2};bb=new technicalindicators.BollingerBands(c),c=a=b=null}var app=express();app.use(express.static("public")),app.use(compression()),app.use(bodyParser.json()),app.use(bodyParser.urlencoded({extended:!0})),app.use(session({store:new FileStore({path:"./session-store"}),name:"_fs_cookie",resave:!1,saveUninitialized:!1,secret:"00777",cookie:{maxAge:3600000}})),app.use(function(a,b,c){b.header("Access-Control-Allow-Origin","*"),b.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept"),c()});var months=["January","February","March","April","May","June","July","August","September","October","November","December"],date=new Date,today=date.getDate()+"-"+(date.getMonth()+1)+"-"+date.getFullYear(),time=date+":"+date.getHours()+":"+date.getMinutes(),fnoArr=dataForge.readFileSync("data/list/fo_mktlots.csv").parseCSV().toArray(),fnoList=[];fnoArr.forEach(function(a){a.SYMBOL&&fnoList.push(a.SYMBOL)}),store.set("fnoList",fnoList);var niftyList=dataForge.readFileSync("data/list/ind_nifty50list.csv").parseCSV().toArray();niftyList=niftyList.map(a=>a.Symbol),store.set("niftyList",niftyList),app.get("/",function(a,b){var c=url.parse(a.url,!0).query;code=c.code,console.log(chalk.green("session > "+JSON.stringify(a.session.cookie))),code?(getAcceToken(code),b.sendFile("index.html",{root:__dirname})):b.sendFile("index.html",{root:__dirname}),c=null}),app.get("/welcome",a,function(a,b){b.send("<b>Hello</b> welcome to my http server made with express")}),app.get("/login",function(a,b){b.sendFile("login.html",{root:__dirname})}),app.get("/logout",function(a,b){a.session.destroy(function(){console.log(chalk.blue("user logged out."))}),b.redirect("/login")}),app.post("/login",function(a,b){var c=a.body.username,d=a.body.password;if(c){getFirst("select * from User where email=? and password=?",[c,d]).then(c=>{console.log("result > "+JSON.stringify(c)),c==null?b.send("error"):(console.log(chalk.green("Login token > "+store.get("accessToken"))),a.session.user=c,b.send(c))})}else b.sendFile("login.html",{root:__dirname})}),app.get("/signup",function(a,b){b.sendFile("signup.html",{root:__dirname})}),app.post("/signup",function(a,b){var c=a.body.email,d=a.body.psw,e=a.body.mobile,f=a.body.name,g=a.body.pswRepeat;if(c){var h="select * from User where email=?",i=[c],j=!1;getFirst(h,i).then(a=>{console.log("result > "+JSON.stringify(a)),a==null||(b.send("error"),j=!0)});var h="INSERT INTO User (name,mobile,email,password)VALUES(?,?,?,?)",i=[f,e,c,d];console.log(h+"> "+i),j||insertDB(h,i).then(a=>{console.log("result > "+JSON.stringify(a)),"success"==a?b.send("success"):b.send("error")})}else b.sendFile("signup.html",{root:__dirname})}),app.get("/contactus",a,function(a,b){b.sendFile("contactus.html",{root:__dirname})}),app.get("/index",a,function(a,b){b.sendFile("index.html",{root:__dirname})}),app.get("/scan",a,function(a,b){b.sendFile("scanner.html",{root:__dirname})}),app.get("/strategy",a,function(a,b){b.sendFile("strategy.html",{root:__dirname})}),app.get("/gainerloser",a,function(a,b){b.sendFile("gainerloser.html",{root:__dirname})});var lastObject={open:"",close:"",low:"",high:"",volume:"",timestamp:"",rsi:"",sma:"",bb:{upper:"",lower:"",isCrossed:"",middel:"",pb:""}},stockData=[];app.post("/createStrategy",a,function(a,c){var d=JSON.parse(a.body.data),e=d.uid,f=d.name,g=d.symbol,h=d.exchange,i=d.orderType,j=d.symbolToBuySell,k=d.indicators[0].indicator,l=d.indicators[0].settings,m=d.indicators[0].value,n=d.indicators[0].op,o=d.interval,p="INSERT INTO Strategy (uid,name,symbol,exchange,orderType,symbolToBuySell,indicator,settings,value,op,interval)VALUES(?,?,?,?,?,?,?,?,?,?,?)",q=[e,f,g,h,i,j,k,l,m,n,o];console.log(p+"> "+JSON.stringify(q)),insertDB(p,q).then(a=>{console.log("result > "+JSON.stringify(a)),"success"==a?c.send("success"):c.send("error")});var r=new Date;"5MINUTE"==o?r.setDate(r.getDate()-2):"3MINUTE"==o?r.setDate(r.getDate()-1):"15MINUTE"==o?r.setDate(r.getDate()-2):"10MINUTE"==o?r.setDate(r.getDate()-3):"30MINUTE"==o?r.setDate(r.getDate()-4):"60MINUTE"==o?r.setDate(r.getDate()-4):"1DAY"==o?r.setDate(r.getDate()-20):"1WEEK"==o?r.setDate(r.getDate()-140):"1MONTH"==o&&r.setMonth(r.getMonth()-20);var s=r.getDate()+"-"+(r.getMonth()+1)+"-"+r.getFullYear();b(),stockData=[],loadSymbol(d.symbol,d.exchange,o,s).then(function(e){c.setHeader("Content-Type","application/json"),stockData=e.data,lastObject={open:"",close:"",low:"",high:"",volume:"",timestamp:"",rsi:"",sma:"",bb:{upper:"",lower:"",isCrossed:"",middel:"",pb:""}},stockData.map(a=>{var b=moment.tz(new Date(+a.timestamp),"Asia/Kolkata");return b.format(),a.timestamp=b.date()+"/"+(b.month()+1)+"/"+b.year()+" "+b.hour()+":"+b.minute(),a.rsi=rsi.nextValue(+a.close),a.sma=sma.nextValue(+a.close),a.bb=bb.nextValue(+a.close),lastObject=a,a}),stockData.reverse();for(var f={symbol:d.symbol,close:stockData[0].close,volume:stockData[0].volume,rsi:stockData[0].rsi,timestamp:stockData[0].timestamp,sma:stockData[0].sma,bb:stockData[0].bb},g=!1,h=0;h<d.indicators.length;h++){var j=d.indicators[h].op,k=f[d.indicators[h].indicator],a=d.indicators[h].value,b=!1;"<"==j?b=k<a:">"==j?b=k>a:"<="==j?b=k<=a:">="==j?b=k>=a:"=="==j&&(b=k==a),b&&(g=!0),console.log("isMatch :> "+g)}if(g){var l={transaction_type:d.orderType,exchange:d.exchange,symbol:d.symbolToBuySell,quantity:1,order_type:"m"};upstox.placeOrder(l).then(function(a){console.log(a)}).catch(function(a){console.log(chalk.red(a))})}console.log("Result "+JSON.stringify(f)),c.send(JSON.stringify(f)),stockData=null,c.end()}).catch(function(a){console.log("createStrategy error > "+JSON.stringify(a))})}),app.get("/loadSymbol/:symbol/:interval",a,function(a,b){console.log("params: "+JSON.stringify(a.params));var c=a.params.symbol,d=a.params.interval,e=new Date;"5MINUTE"==d?e.setMinutes(e.getMinutes()-100):"3MINUTE"==d?e.setMinutes(e.getMinutes()-60):"10MINUTE"==d?e.setMinutes(e.getMinutes()-200):"15MINUTE"==d?e.setMinutes(e.getMinutes()-300):"30MINUTE"==d?e.setMinutes(e.getMinutes()-600):"60MINUTE"==d?e.setMinutes(e.getMinutes()-1200):"1DAY"==d?e.setDate(e.getDate()-20):"1WEEK"==d?e.setDate(e.getDate()-140):"1MONTH"==d?e.setMonth(e.getMonth()-20):e.setDate(e.getDate()-20);var f=e.getDate()+"-"+(e.getMonth()+1)+"-"+e.getFullYear();console.log("start_date > "+d+" >> "+f);var g={values:[],period:14},h=new technicalindicators.RSI(g),i={values:[],period:20},j=new technicalindicators.SMA(i),k={period:14,values:[],stdDev:2},l=new technicalindicators.BollingerBands(k);k=g=i=null,stockData=[],loadSymbol(c,"nse_eq",d,f).then(function(a){b.setHeader("Content-Type","application/json"),stockData=a.data,console.log("loadSymbol stockData : "+stockData.length),lastObject={open:"",close:"",low:"",high:"",volume:"",timestamp:"",rsi:"",sma:"",bb:{upper:"",lower:"",isCrossed:"",middel:"",pb:""}},stockData.map(a=>{var b=moment.tz(new Date(+a.timestamp),"Asia/Kolkata");return b.format(),a.timestamp=b.date()+"/"+(b.month()+1)+"/"+b.year()+" "+b.hour()+":"+b.minute(),a.rsi=h.nextValue(+a.close),a.sma=j.nextValue(+a.close),a.bb=l.nextValue(+a.close),a&&a.bb&&+a.close>=+a.bb.upper?a.bb.isCrossed="Crossed Above":a&&a.bb&&+a.close<=+a.bb.lower&&(a.bb.isCrossed="Crossed Below"),lastObject=a,a}),stockData.reverse(),b.send(JSON.stringify(stockData)),stockData=null,b.end()}).catch(function(c){if(401==c.code){accessToken="",store.set("accessToken",accessToken);var d=upstox.getLoginUri(redirect_uri);b.status(200).header("Content-type","text/html"),code=a.params.code,b.status(302).setHeader("Location",d),b.end()}console.log("/loadSymbol/:symbol/:interval error > "+JSON.stringify(c))})}),app.get("/getFutureContract/:exchange",a,function(a,b){var c=a.params.exchange;fs.readFile("data/index/nse_fo.txt","utf8",function(a,d){var e=JSON.parse(d),f=csvTojs(e.data),f=f.filter(a=>a.instrument_type+""===c),g=f.map(a=>a.symbol);b.setHeader("Content-Type","application/json"),b.send(g),b.end()})});var result=[],map=new Map;app.get("/loadAllSymbolData/:interval/:exchange",a,function(a,b){console.log("params: "+JSON.stringify(a.params));var c=a.params.interval,d=a.params.exchange,e=[];e="nifty"==d?store.get("niftyList"):"fno"==d?store.get("fnoList"):store.get("nseSymbolList");var f=[];"5MINUTE"==c?f=store.get("data5"):"3MINUTE"==c?f=store.get("data3"):"10MINUTE"==c?f=store.get("data10"):"15MINUTE"==c?f=store.get("data15"):"30MINUTE"==c?f=store.get("data30"):"60MINUTE"==c?f=store.get("data60"):"1DAY"==c?f=store.get("data1day"):"1WEEK"==c?f=store.get("data1week"):"1MONTH"==c&&(f=store.get("data1month"));if(f&&null!=f&&0<f.length&&f.filter(function(a){return null!=a&&null!=a.close&&null!=a.close&&""!=a.close}),f&&0<f.length&&f[0])b.setHeader("Content-Type","application/json"),b.send(JSON.stringify(f)),b.end();else{console.log("*No data available "+c+" Fetch it.");var g=new Date;"5MINUTE"==c?g.setDate(g.getDate()-2):"3MINUTE"==c?g.setDate(g.getDate()-2):"10MINUTE"==c?g.setDate(g.getDate()-3):"15MINUTE"==c?g.setDate(g.getDate()-3):"30MINUTE"==c?g.setDate(g.getDate()-4):"60MINUTE"==c?g.setDate(g.getDate()-4):"1DAY"==c?g.setDate(g.getDate()-30):"1WEEK"==c?g.setDate(g.getDate()-140):"1MONTH"==c&&g.setMonth(g.getMonth()-20);var h=g.getDate()+"-"+(g.getMonth()+1)+"-"+g.getFullYear();loadAllSymbolData(e,c,h).then(function(a){console.log("\n loadAllSymbolData **"+JSON.stringify(a));var f=[];"5MINUTE"==c?store.set("data5",a):"3MINUTE"==c?store.set("data3",a):"10MINUTE"==c?store.set("data10",a):"15MINUTE"==c?store.set("data15",a):"30MINUTE"==c?store.set("data30",a):"60MINUTE"==c?store.set("data60",a):"1DAY"==c?store.set("data1day",a):"1WEEK"==c?store.set("data1week",a):"1MONTH"==c&&store.set("data1month",a),b.setHeader("Content-Type","application/json"),b.send(JSON.stringify(a)),d=e=c=f=null,b.end()}).catch(function(a){console.log("loadAllSymbolData/ error > "+JSON.stringify(a))})}}),app.get("/getListOfAllSymbol",a,function(a,b){b.setHeader("Content-Type","application/json"),fnoList=store.get("fnoList"),0<fnoList.length?b.send(JSON.stringify(fnoList)):b.send(JSON.stringify(getListOfAllSymbol())),b.end()}),app.get("/sync",a,function(a,b){syncStockData(),b.setHeader("Content-Type","application/json"),b.send("Successfully sync data !"),b.end()}),app.get("/getBalance",function(a,b){b.setHeader("Content-Type","application/json"),b.send(JSON.stringify(balance)),b.end()}),app.get("/getProfile",function(a,b){b.setHeader("Content-Type","application/json"),b.send(JSON.stringify(profile)),b.end()}),app.post("/scan",function(){}),app.get("/admin",a,function(a,b){if(store.get("accessToken")&&""!=store.get("accessToken"))accessToken=store.get("accessToken"),upstox.setToken(accessToken),getListOfAllSymbol(),b.sendFile("index.html",{root:__dirname});else{var c=upstox.getLoginUri(redirect_uri);console.log("*loginUri "+c),b.status(200).header("Content-type","text/html"),code=a.params.code,b.status(302).setHeader("Location",c),b.end()}}),app.use(function(a,b){b.status(404).send("Sorry, that route doesn't exist. Have a nice day :)")}),app.listen(PORT,function(){console.log("App listening on port "+PORT)})}cluster.on("exit",function(a){console.log("Worker %d died :(",a.id),cluster.fork()});
var technicalindicators=require("technicalindicators"),fs=require("fs"),months=["January","February","March","April","May","June","July","August","September","October","November","December"],date=new Date,today=date.getDate()+"-"+(date.getMonth()+1)+"-"+date.getFullYear(),time=date+":"+date.getHours()+":"+date.getMinutes(),days=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],strategyObj={symbol:"BANKNIFTY19JANFUT",indicators:[{indicator:"rsi",settings:"14",value:"60",op:">="},{indicator:"sma",settings:"20",value:"close",op:">="}],interval:"15min"};function backTesting(a){var b=a.filter(function(a){return 60<=a.rsi}),b=b.filter(function(a){return a.close>=a.sma})}var rsi,sma,bb;function getList(a){for(let d of a)if(d){rsi=new technicalindicators.RSI({values:[],period:14});sma=new technicalindicators.SMA({values:[],period:20});bb=new technicalindicators.BollingerBands({period:14,values:[],stdDev:2});var b=d.symbol?d.symbol:d,c="data/stock/1day/"+b+".txt";fs.access(c,fs.constants.F_OK|fs.constants.R_OK,a=>{a?console.error(`${c} ${"ENOENT"===a.code?"does not exist":"is read-only"}`):(console.log(`${c} exists, and it is Readable`),fs.readFile(c,"utf8",function(a,b){if(a)throw a;if(""!=b&&null!=b&&null!=b){var d=JSON.parse(b),e=dataForge.fromJSON(JSON.stringify(d.data)).dropSeries(["cp"]).where(a=>calculateIndicators(a)).select(a=>transform(a));e.reverse();var f=e.toJSON();console.log("data >> "+c+"  n \n "+f)}}))})}}function mappedFunction(){}function transform(a){return a.timestamp=new Date(a.timestamp),a}function calculateIndicators(a){return a.rsi=rsi.nextValue(+a.close),a.sma=sma.nextValue(+a.close),a.bb=bb.nextValue(+a.close),a}function log(a){if("production"!=process.env.NODE_ENV){date=new Date,today=date.getDate()+"-"+(date.getMonth()+1)+"-"+date.getFullYear();var b="logs/log-"+today+".txt";try{fs.existsSync(b)?fs.appendFile(b,"\n"+date+" "+a,function(a){if(a)throw a}):fs.writeFile(b,"\n"+date+" "+a,function(a){if(a)throw a})}catch(c){console.error(c),fs.writeFile(b,"\n"+date+" "+a,function(a){if(a)throw a})}}}function addIndicators(a,b){var c=a.data;for(let e of c){var d=e;return d.timestamp=new Date(d.timestamp),d}var e=[];for(let d of c)e.push(d.close);var f={values:e,period:14},g=technicalindicators.RSI.calculate(f),h={values:e,period:20},i=technicalindicators.SMA.calculate(h),j=technicalindicators.BollingerBands,k={period:14,values:e,stdDev:2},l=j.calculate(k),m=0;for(let e of c){var d=e;return d.rsi=m>f.period?g[m-f.period]:0,d.sma=m>=h.period?i[m-h.period]:0,d.bb=m>=k.period?l[m-k.period]:null,m++,d}backTesting(c,b)}
var accessToken,Upstox=require("upstox"),moment=require("moment-timezone"),api="cIs71szuLZ7WFKInU8O0o7GTHm5QIJke8ahnzLVw",upstox=new Upstox(api),fs=require("fs"),months=["January","February","March","April","May","June","July","August","September","October","November","December"],code="",__dirname="views",exchanges=["MCX_FO","BSE_EQ","NSE_EQ","NSE_FO","NCD_FO"],login_code="ce728b73424e719680aa66a51ba4eb469f9875f2",api_secret="xs5ibb0pk0",client_id="",watchList=["banknifty","hindalco","ICICIBANK","sbin","idea","lt","HAVELLS"];function getAcceToken(a){var b={apiSecret:api_secret,code:a,grant_type:"authorization_code",redirect_uri:redirect_uri};upstox.getAccessToken(b).then(function(c){b=api_secret=a=null,accessToken=c.access_token,store.set("accessToken",accessToken),console.log("****accessToken*\n"+accessToken),upstox.setToken(accessToken),start()}).catch(function(a){console.log("getAccessToken > "+a)})}function start(){async.parallel({getProfile,getBalance,getListOfAllSymbol,getAllData},function(){});upstox.getMasterContract({exchange:"nse_fo"}).then(function(a){console.log("FNO data >> \n \n"+transformedData),fs.writeFile("data/index/nse_fo.txt",JSON.stringify(a),function(a){if(a)throw a;console.log("nse_fo File is created successfully.")})}).catch(function(a){console.log("nse fo error "+JSON.stringify(a))}),upstox.getMasterContract({exchange:"NSE_INDEX",format:"json"}).then(function(a){fs.writeFile("data/index/index.txt",JSON.stringify(a),function(a){if(a)throw a;console.log("index File is created successfully.")})}).catch(function(a){console.log(a)}),upstox.connectSocket().then(function(){upstox.on("orderUpdate",function(a){console.log("orderUpdate"+a)}),upstox.on("positionUpdate",function(a){console.log("positionUpdate"+a)}),upstox.on("tradeUpdate",function(a){console.log("tradeUpdate"+a)});var a=niftyList.join();upstox.subscribeFeed({exchange:"nse_eq",symbol:a,type:"ltp"}).then(function(a){console.log("feedsymbols subscribeFeed response ",a)}).catch(function(a){console.log("Error in subscribe feed ",a)}),upstox.on("liveFeed",function(a){console.log("liveFeed"+a)}),upstox.on("disconnected",function(a){console.log("disconnected > "+a)}),upstox.on("error",function(a){console.log("error"+a)})}).catch(function(a){console.log("connectSocket #"+a)})}var nseSymbolList=[];function getListOfAllSymbol(){upstox.getMasterContract({exchange:"nse_eq",format:"json"}).then(function(a){var b=a.data;nseSymbolList=b.map(a=>a.symbol),store.set("nseSymbolList",nseSymbolList)}).catch(function(a){console.log("Error getListOfAllSymbol > "+JSON.stringify(a))})}var balance;function getBalance(){upstox.getBalance({type:"security"}).then(function(a){balance=JSON.stringify(a)}).catch(function(a){console.log(a)})}var profile;function getProfile(){upstox.getProfile().then(function(a){client_id=a.data.client_id,profile=JSON.stringify(a.data)}).catch(function(a){console.log("Error"+a)})}function getMaster(a="nse_fo"){if(store.get("accessToken"))return upstox.getMasterContract({exchange:a})}function loadSymbol(a,b,c="1day",d="12-12-2018"){if(console.log("loadSymbol > "+a+" > "+c+" > "+b+" > "+d+" :: "+store.get("accessToken")),store.get("accessToken"))return upstox.getOHLC({exchange:b,symbol:a,start_date:d,format:"json",interval:c})}function getAllData(){}function syncStockData(){delay(10).then(()=>load5minData()),delay(1e3).then(()=>load3minData()),delay(1e4).then(()=>load10minData()),delay(15e3).then(()=>load15minData()),delay(2e4).then(()=>load30minData()),delay(3e4).then(()=>load60minData()),delay(6e4).then(()=>load1dayData())}const delay=a=>new Promise(b=>setTimeout(b,a));var stockData=[],data={},promiseArr=[];async function loadAllSymbolData(a,b="1DAY",c="11-11-2018"){return console.log("* Step 1 : loadSymbol "),promiseArr=[],Promise.all(a.map(function(a){return loadSymbol(a,"nse_eq",b,c).then(function(b){try{console.log("* loadSymbol "+JSON.stringify(b)),stockData=b.data;var c={values:[],period:14};rsi=new technicalindicators.RSI(c);var e={values:[],period:20};sma=new technicalindicators.SMA(e);var f={period:14,values:[],stdDev:2};bb=new technicalindicators.BollingerBands(f),f=c=e=null,stockData.map(a=>(a&&0<+a.close&&(a.rsi=rsi.nextValue(+a.close),a.sma=sma.nextValue(+a.close),a.bb=bb.nextValue(+a.close)),a.change=getPercentageChange(+lastObject.close,+a.close),a.bb&&+a.close>=+a.bb.upper?a.bb.isCrossed="Crossed Above":a.bb&&+a.close<=+a.bb.lower&&(a.bb.isCrossed="Crossed Below"),lastObject=a,a)),stockData.reverse();var g;if(0<stockData[0].timestamp){var h=new Date(+stockData[0].timestamp),d=moment.tz(h,"Asia/Kolkata");d.format(),g=0<d.minute()?d.date()+"/"+(d.month()+1)+"/"+d.year()+" "+d.hour()+":"+d.minute():d.date()+"/"+(d.month()+1)+"/"+d.year()}return data={symbol:a,close:stockData[0].close,volume:stockData[0].volume,rsi:stockData[0].rsi,timestamp:g,sma:stockData[0].sma,bb:stockData[0].bb,change:stockData[0].change},stockData=null,promiseArr.push(data),data}catch(a){console.log("loadAllSymbolData : err   > "+a)}})}))}
function csvTojs(a){for(var b=a,d=[],e=b[0].split(","),f=1;f<b.length;f++){var g={},h=b[f],j=0,k=0,l=0;if(""!==h.trim()){for(;l<h.length;){var m=h[l];if("\""===m)do m=h[++l];while("\""!==m&&l<h.length-1);if(","===m||l===h.length-1){var n=h.substr(k,l-k).trim();"\""===n[0]&&(n=n.substr(1)),","===n[n.length-1]&&(n=n.substr(0,n.length-1)),"\""===n[n.length-1]&&(n=n.substr(0,n.length-1));var o=e[j++];g[o]=n,k=l+1}++l}d.push(g)}}return d}function getPercentageChange(a,b){return(100*((b-a)/a)).toFixed(2)}